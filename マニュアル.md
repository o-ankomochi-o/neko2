# 第 1 章：はじめに

## 目的

本ガイドの目的は、**GitLab の導入および運用をスムーズに開始できるよう支援すること**です。特に、これから GitLab を初めて導入する方や、Azure DevOps からの移行を検討している方に向けて、具体的な構築手順や運用ノウハウを提供します。

本ガイドでは**オンプレミス環境における GitLab の運用**を前提としており、Docker 上に GitLab および GitLab Runner を構築する構成を軸に解説します。

また、CI/CD 機能、カンバンボード機能、成果物管理といった主要機能の活用方法や、セキュリティやバックアップなどの運用面のベストプラクティスについても取り上げています。

## 対象読者

このガイドは、以下のような方を対象としています：

- **Docker 上に GitLab 本体と GitLab Runner を構築したい方**
- **GitLab を使って新たに CI/CD 環境を構築したい方**
- **Azure DevOps で CI/CD を運用しており、同等の機能を GitLab（オンプレミス）へ移行したい方**
- **オンプレミスでの継続的インテグレーション／デリバリーの自動化を目指すインフラ／開発担当者**

---

了解しました。以下は「**第 2 章：GitLab の機能概要**」のドラフトです。
視覚的に理解しやすくする構成で、各機能のイメージ画像（GitLab 公式サイトの UI キャプチャを使用する想定）を挿入できるようにコメントを入れています。

---

# 第 2 章：GitLab の機能概要

GitLab は、単なる Git リポジトリのホスティングツールにとどまらず、開発ライフサイクル全体をサポートする統合プラットフォームです。本章では、主要な 4 つの機能について、実際の画面イメージとともに直感的に理解できるよう解説します。

---

## 2.1 Git リポジトリ機能

GitLab は Git ベースのソースコード管理（SCM）を提供しており、ブランチ管理、マージリクエスト（Pull Request）、差分表示、履歴管理などの基本機能を備えています。

- **主な機能**

  - ブランチ戦略の管理（GitLab Flow、GitHub Flow など）
  - Web 上でのコード閲覧・編集・レビュー
  - マージリクエスト（レビュー＋マージ）
  - コードの差分比較とコメント機能

<!-- 画像例：GitLabのマージリクエスト画面のスクリーンショット -->

> ![GitLab Merge Request](https://docs.gitlab.com/assets/images/gitlab-flow-example.png)

---

## 2.2 パイプライン機能（CI/CD）

GitLab の CI/CD 機能は、コードのビルド・テスト・デプロイを自動化する強力な仕組みです。`.gitlab-ci.yml` ファイルを用いて、柔軟にワークフローを構築できます。

- **主な機能**

  - 自動テスト、ビルド、デプロイの設定
  - ステージ（build/test/deploy）単位のジョブ実行
  - GitLab Runner との連携による分散実行
  - 成功/失敗ステータスの可視化

<!-- 画像例：GitLabのCI/CDパイプライン可視化画面 -->

> ![GitLab CI/CD Pipeline](https://about.gitlab.com/images/ci/cd_example.png)

---

## 2.3 ボード機能（Issue ボード／カンバン）

GitLab の「ボード」機能は、スクラムや PBL（Project-Based Learning）などのアジャイル開発にも対応できるカンバンボードです。
課題（Issue）を列（List）に分類し、ドラッグ＆ドロップで管理できます。

- **主な機能**

  - ボードのカスタマイズ（To Do／Doing／Done など）
  - Issue とマイルストーンの連携
  - 担当者・ラベルによる絞り込み
  - 複数プロジェクトの統合管理（グループボード）

<!-- 画像例：GitLab Issue Boardのスクリーンショット -->

> ![GitLab Issue Board](https://docs.gitlab.com/ee/assets/img/issue_board.png)

---

## 2.4 成果物管理機能（Package & Release）

GitLab では成果物（アーティファクト）の保管や配布も可能です。たとえば、パッケージの登録・参照や、リリースノートの作成などを一元管理できます。

- **主な機能**

  - CI で生成された成果物の保存と参照
  - GitLab Package Registry（npm/pypi/docker など）
  - GitLab Release 機能によるリリース管理
  - チェンジログの自動生成

<!-- 画像例：リリース画面のスクリーンショット -->

> ![GitLab Releases](https://docs.gitlab.com/assets/images/releases-example.png)

---

## 補足：すべてが一体化されたプラットフォーム

GitLab では、これらの機能が**同一の UI と権限管理のもと**で統合されているため、開発者、PM、インフラ担当者がスムーズに連携できる環境を提供しています。

---

画像の差し替えが必要であれば、手元の GitLab 環境のスクリーンショットに置き換えてください。

---以下は「**第 3 章：環境構築**」の冒頭、「システム構成の概要」とその中の「選定理由」までを含んだドラフトです。

---

# 第 3 章：環境構築

## 3.1 システム構成の概要

本ガイドでは、GitLab を**オンプレミス環境**（クラウド上の仮想マシンを含む）で利用する前提で構成を説明します。

今回は、以下のような構成で GitLab 環境を構築します：

- **ホスト環境**：AWS EC2（Ubuntu）
- **コンテナ管理**：Docker
- **GitLab 本体**：Docker コンテナ上で稼働
- **GitLab Runner**：同じく Docker 上に構築し、CI/CD パイプラインを実行

```
┌────────────────────────┐
│        AWS EC2（Ubuntu）         │
│  ┌────────────────────┐   │
│  │    Docker Engine        │   │
│  │  ┌────────────┐   │
│  │  │ GitLab コンテナ    │   │
│  │  └────────────┘   │
│  │  ┌────────────┐   │
│  │  │ Runner コンテナ  │   │
│  │  └────────────┘   │
│  └────────────────────┘   │
└────────────────────────┘
```

---

## 3.2 なぜこの構成を選んだか（選定理由）

この構成を選んだ理由は以下の通りです：

### ✅ **柔軟性と拡張性が高い**

- Docker を用いることで、**GitLab や Runner のバージョン管理、構成変更、再起動が容易**になります。
- CI/CD パイプラインの特性に応じて Runner を**水平スケール**することも可能です。

### ✅ **コスト効率のよいクラウド環境**

- AWS EC2 を利用することで、**インフラ構成の自由度とコスト管理のバランス**がとりやすく、スモールスタートにも適しています。
- オンプレ構成と比較して、**サーバの物理的管理が不要**で、短期間の PoC やスケールアップにも対応しやすいです。

### ✅ **セキュアな社内運用が可能**

- SaaS 型の GitLab.com とは異なり、**アクセス制限やネットワークポリシーを自由に設計可能**です。
- VPN 接続や IAM 連携など、セキュリティ要件に応じた運用が可能です。

### ✅ **Azure DevOps からの移行を意識**

- すでに Azure DevOps で CI/CD を構築している場合、**似たような構成（リポジトリ＋エージェント）で GitLab 移行が行いやすい**です。

---

了解しました。以下は「第 3 章：環境構築」の続きとなるセクション案と、その内容です。AWS EC2 上での Docker、GitLab、Runner の導入までを丁寧にガイド形式で記述しています。

---

## 3.3 Docker の導入手順（EC2 上）

まず、AWS EC2 にログインし、Docker をインストールします。

```bash
# パッケージ更新
sudo apt update

# Docker のインストール
sudo apt install -y docker.io

# 自動起動設定と起動
sudo systemctl enable docker
sudo systemctl start docker

# docker コマンドを sudo なしで使えるようにする
sudo usermod -aG docker $USER

# ※ 再ログインが必要です
```

---

## 3.4 GitLab コンテナの起動

次に、GitLab 本体の Docker コンテナを起動します。

```bash
sudo docker run --detach \
  --hostname gitlab.example.com \
  --publish 80:80 --publish 443:443 --publish 22:22 \
  --name gitlab \
  --restart always \
  --volume $HOME/gitlab/config:/etc/gitlab \
  --volume $HOME/gitlab/logs:/var/log/gitlab \
  --volume $HOME/gitlab/data:/var/opt/gitlab \
  gitlab/gitlab-ce:latest
```

> 💡 `gitlab.example.com` は実際のドメイン名または IP に変更してください。

起動後、数分待ってからブラウザで `http://[EC2のパブリックIP]` にアクセスします。初回ログイン用のパスワードは以下のコマンドで確認できます。

```bash
sudo cat $HOME/gitlab/config/initial_root_password
```

---

## 3.5 GitLab Runner の登録と起動

次に、CI/CD を実行する Runner をセットアップします。

```bash
# GitLab Runner を Docker 上で起動
sudo docker run -d --name gitlab-runner --restart always \
  -v /srv/gitlab-runner/config:/etc/gitlab-runner \
  -v /var/run/docker.sock:/var/run/docker.sock \
  gitlab/gitlab-runner:latest
```

### Runner の登録

```bash
sudo docker exec -it gitlab-runner gitlab-runner register
```

インタラクティブに以下のような情報を入力します：

| 質問内容            | 入力内容例                               |
| ------------------- | ---------------------------------------- |
| GitLab instance URL | `http://[EC2のIPまたはドメイン]/`        |
| Registration token  | GitLab 管理画面 > Admin > Runners で確認 |
| Description         | 任意（例：`docker-runner`）              |
| Tags                | 任意（例：`build,test`）                 |
| Executor            | `docker` を選択                          |
| Docker image        | 例：`alpine:latest` や `python:3.9`      |

---

## 3.6 動作確認

`.gitlab-ci.yml` を含んだリポジトリでパイプラインを実行し、Runner が正しく機能するか確認します。

```yaml
# 例: Hello World 用の CI ファイル
stages:
  - test

hello-world:
  stage: test
  script:
    - echo "Hello, GitLab CI!"
```

リポジトリに `.gitlab-ci.yml` をプッシュすると、パイプラインが自動で実行されます。

---

これで、**GitLab + GitLab Runner のオンプレ（EC2）環境での基本構築が完了**です。
以下は「**第 4 章：主要機能の使い方**」のドラフトです。
第 3 章で構築した環境（GitLab ＋ Runner）を前提に、実際にどう操作すればいいかを**具体的な操作手順付き**で記述しています。初心者にも配慮したステップバイステップ形式です。

---

# 第 4 章：主要機能の使い方

本章では、第 3 章で構築した GitLab 環境上で、代表的な機能を実際に使うための手順を解説します。

---

## 4.1 Git リポジトリ機能の使い方

### リポジトリの作成

1. GitLab にログインし、右上の **\[New project]** をクリック
2. 任意のプロジェクト名・説明を入力
3. 「Initialize repository with a README」にチェックを入れると、初期状態で `main` ブランチと `README.md` が作成されます
4. **\[Create project]** をクリック

### クローンしてローカル作業

```bash
git clone http://[YOUR_GITLAB_HOST]/[USERNAME]/[PROJECT_NAME].git
cd [PROJECT_NAME]
```

### コミット・プッシュの例

```bash
echo "# Hello GitLab" >> README.md
git add README.md
git commit -m "Update README"
git push origin main
```

---

## 4.2 パイプライン機能の使い方

### `.gitlab-ci.yml` の作成

プロジェクトルートに以下のようなファイルを作成します：

```yaml
stages:
  - build
  - test

build-job:
  stage: build
  script:
    - echo "ビルドステージ"

test-job:
  stage: test
  script:
    - echo "テストステージ"
```

### 実行確認

1. ファイルをリポジトリにコミット・プッシュ
2. GitLab の「**CI/CD → Pipelines**」画面でジョブの実行状況が表示されます
3. 各ジョブをクリックするとログを確認できます

---

## 4.3 ボード機能の使い方（スクラム対応）

### Issue の作成

1. プロジェクト画面左メニューから「**Issues → List**」を選択
2. \[New Issue] をクリックして課題を登録

### カンバンボードの利用

1. 「**Issues → Boards**」に移動
2. \[Create Board]（または \[New List]）をクリックして、「To Do」「Doing」「Done」などのカラムを作成
3. Issue をドラッグ＆ドロップしてステータスを管理

> 📝 教育向けや PBL でも活用しやすく、学習者にタスクの可視化と進捗管理を促す運用が可能です。

---

## 4.4 成果物管理機能の使い方

### CI の成果物としてファイルを保存

以下のように `.gitlab-ci.yml` を編集することで、ジョブ内で生成したファイルを「成果物」として保存できます：

```yaml
artifacts-job:
  stage: build
  script:
    - echo "成果物ファイル" > result.txt
  artifacts:
    paths:
      - result.txt
```

ジョブ成功後、「**CI/CD → Jobs → 該当ジョブ → Browse**」からダウンロード可能です。

### リリースノートの作成

1. リポジトリの「**Deployments → Releases**」から「\[New release]」を作成
2. 対象のタグを選び、リリース名・内容（例：バージョン情報、更新点など）を記入
3. 「Create release」をクリックすると公開されます

---

この章で紹介した各機能は、**実際の開発や教育プロジェクトで即活用可能な実践的機能**です。
次章では、これらを安定運用するための管理方法やバックアップ、セキュリティ対策について解説します。

---

必要に応じてこの章に **Tips コラム** や **トラブル事例集** などを追加することもできます。以下に「第 4 章：主要機能の使い方」に差し込める **Tips コラム** と **トラブル事例集** のサンプルを用意しました。
実運用時にありがちな「あるある」や「なるほど」が詰まっており、読み物的にも親しみやすくなる構成です。

---

## ✅ Tips コラム：現場で役立つちょい技

### 🔹Tips 1：CI/CD の高速化には「キャッシュ」を活用せよ！

```yaml
cache:
  paths:
    - node_modules/
```

`npm install` を毎回ゼロから行っていると時間がかかります。上記のようにキャッシュ設定を行えば、インストール済みモジュールが再利用され、パイプラインが大幅に高速化されます。

---

### 🔹Tips 2：Issue ボードを「ラベル」で自動整理！

ボードのカラムは、実は「ラベル」に紐づいています。
「To Do」「In Progress」「Done」といったラベルを事前に作っておけば、**ラベルを付けるだけで自動でカラムが整理**されます。スクラム運用で大活躍！

---

### 🔹Tips 3：README にバッジをつけよう

```markdown
[![pipeline status](http://your-gitlab-host/user/repo/badges/main/pipeline.svg)](http://...)
```

リポジトリのトップに CI ステータスやカバレッジのバッジを付けることで、**現在の状況を一目で確認**できます。

---

## 🚨 トラブル事例集：よくあるハマりポイント

### 🧨 事例 1：CI パイプラインが走らない

**原因**：`.gitlab-ci.yml` が正しく書かれていない／ファイル名が間違っている。

**解決策**：

- ファイル名は必ず `.gitlab-ci.yml`
- YAML 構文チェッカー（例： [https://yamlchecker.com/](https://yamlchecker.com/) ）で文法を確認
- GitLab の「CI Lint」ツールでも検証可能（CI/CD → Editor → Lint）

---

### 🧨 事例 2：Runner が登録されない／認識されない

**原因**：

- トークンが違う
- GitLab 本体の URL が `localhost` や `127.0.0.1` になっている

**解決策**：

- `gitlab-runner register` 時の URL は **EC2 のパブリック IP かドメイン**を使う
- Runner 側のログ（`docker logs gitlab-runner`）を確認して詳細を掴む

---

### 🧨 事例 3：成果物がダウンロードできない

**原因**：`.gitlab-ci.yml` に `artifacts` の指定がない／ジョブが失敗している

**解決策**：

- ジョブ内で確実にファイルが出力されているか確認
- `script:` のコマンドに `ls -l` や `cat` を入れてログで確認

---

これらのコラムは、セクションの末尾に「補足」として挿入することで、ドキュメント全体を**より実践的かつ読みやすく**する効果があります。
以下は「**第 5 章：運用方法**」のドラフトです。第 3〜4 章で構築・活用した GitLab 環境を**安定運用・安全運用するためのノウハウ**をまとめた内容になっています。

---

# 第 5 章：運用方法

GitLab は非常に高機能な開発プラットフォームですが、**長期的な運用においては「安全性」と「可用性」が鍵**となります。本章では、GitLab を組織で安心して運用するためのバックアップ、アクセス制御、認証統合、セキュリティ管理の方法を紹介します。

---

## 5.1 バックアップ

### ▶ 定期バックアップの必要性

万が一の障害に備えて、GitLab では以下のデータを定期的にバックアップすることが推奨されます。

- リポジトリの内容
- Issue・Merge Request などのメタデータ
- CI/CD 設定
- コンテナ/パッケージレジストリ

### ▶ バックアップコマンド（例）

GitLab CE の場合：

```bash
sudo gitlab-backup create
```

デフォルトでは `/var/opt/gitlab/backups` に `.tar` ファイルが作成されます。

### ▶ 復元（リストア）方法

```bash
# 事前にGitLabを停止
sudo gitlab-ctl stop unicorn
sudo gitlab-ctl stop sidekiq

# 復元
sudo gitlab-backup restore BACKUP=1698201540_2023_10_25_13.2.4

# GitLabを再起動
sudo gitlab-ctl restart
```

> 💡 自動化には cron や systemd timer でのスケジューリングを推奨します。

---

## 5.2 アクセス制御（プロジェクトとロールの管理）

GitLab では、**個人やチームの役割に応じてアクセス権限を細かく設定**できます。

### ▶ 権限レベル

| 権限       | 説明                                       |
| ---------- | ------------------------------------------ |
| Guest      | 読み取り専用。Issue 閲覧は可能             |
| Reporter   | リポジトリをクローンして参照可能           |
| Developer  | ブランチ作成や Push が可能                 |
| Maintainer | 設定変更・マージ操作が可能                 |
| Owner      | グループの全権限を持つ（グループ単位のみ） |

### ▶ 利用例

- **外注開発者には Reporter に制限**
- **CI 設定を誤って壊さないよう、Maintainer 権限は限定メンバーのみ**

---

## 5.3 認証システムとの連携（シングルサインオン）

### ▶ GitLab で対応している認証方式

- LDAP/Active Directory
- SAML（Google Workspace、Azure AD など）
- OAuth2 / OpenID Connect
- CAS（Central Authentication Service）

### ▶ 連携イメージ：Google Workspace との SAML 連携

1. GitLab 側で `gitlab.rb` に以下を記述：

```ruby
gitlab_rails['omniauth_providers'] = [
  {
    "name" => "saml",
    "args" => {
      "assertion_consumer_service_url" => "https://gitlab.example.com/users/auth/saml/callback",
      "idp_cert_fingerprint" => "...",
      ...
    }
  }
]
```

2. IdP 側（Google Workspace 管理画面など）で SAML アプリを設定

> 🔒 シングルサインオン（SSO）により、**人の入退室に伴うアカウント管理の統一**ができ、セキュリティと運用効率が向上します。

---

## 5.4 セキュリティ管理

### ▶ 外部公開範囲の制限

- プロジェクトの「Visibility Level」を `Private` に設定
- 無関係な外部ユーザーのアクセスを防ぐため、デフォルトの可視性を制限

### ▶ SSH・Token の適切な管理

- 公開鍵認証（SSH）の推奨
- Personal Access Token は**必要最小限のスコープ・有効期限**で発行

### ▶ 監査ログの取得（GitLab Premium 以上）

- 誰がいつ、どの操作を行ったかを記録
- セキュリティインシデント対応の証跡として活用

---

## 📌 補足：最小限でも以下の対策を！

| 項目                  | 実施内容                               |
| --------------------- | -------------------------------------- |
| 🔐 パスワードポリシー | 8 文字以上／複雑性チェック             |
| 🚫 不要なユーザー削除 | 毎月 1 回の棚卸し推奨                  |
| 🧑‍💻 アクセス権限見直し | チーム変更時・プロジェクト終了時に実施 |
| 📤 バックアップ自動化 | Cron ＋監視で運用負荷を削減            |

---

必要であればこの後に「第 6 章：Azure DevOps との比較と移行メモ」や「付録：用語集」「設定ファイル例」なども加えられます。次章を進めましょうか？
ありがとうございます！以下にご要望の「第 6 章：Azure DevOps との比較と移行メモ」、および補助的な「付録：用語集」と「付録：設定ファイル例」のドラフトをまとめました。

---

# 第 6 章：Azure DevOps との比較と移行メモ

Azure DevOps から GitLab への移行を検討している方向けに、代表的な機能の対応関係と、移行時のポイントをまとめます。

## 6.1 機能比較表（GitLab vs Azure DevOps）

| 機能カテゴリ         | Azure DevOps                | GitLab（CE 版中心）                |
| -------------------- | --------------------------- | ---------------------------------- |
| リポジトリ管理       | Repos（Git）                | リポジトリ（Git）                  |
| CI/CD                | Pipelines（YAML ベース）    | GitLab CI/CD（.gitlab-ci.yml）     |
| タスク管理           | Boards（Work Items）        | Issues ＋ Boards（カンバン）       |
| アーティファクト管理 | Artifacts, Feeds            | Package Registry（npm, docker 等） |
| テスト管理           | Test Plans（有償）          | CI 内でのテストログ＋ JUnit 互換   |
| ユーザー管理         | Azure AD・MS アカウント連携 | LDAP/SAML/OAuth 連携（自己管理）   |
| デプロイ機能         | Environments / Releases     | Environments / Deploy tokens       |
| 通知・連携           | Teams / Webhook / REST API  | Slack / Webhook / REST API         |

## 6.2 移行の注意点

### ✅ ソースコードの移行

- Git リポジトリであれば `git remote add` → `git push` で移行可能。
- Submodule や large files（LFS）は事前に確認を。

```bash
git clone --mirror https://dev.azure.com/org/project/_git/repo
cd repo.git
git push --mirror https://gitlab.example.com/group/repo.git
```

### ✅ CI/CD の移行

- YAML ベースである点は共通。
- Azure DevOps の `jobs`, `steps` を GitLab の `stages`, `script` にマッピング。
- 移行ツールは現時点では未整備のため**手動変換**が現実的。

### ✅ 課題・ボードの移行

- Azure DevOps の Work Item は直接インポート不可。
- CSV エクスポート →GitLab Issue API でのインポートがおすすめ。

---

# 付録：用語集

| 用語             | 説明                                                                           |
| ---------------- | ------------------------------------------------------------------------------ |
| Runner           | GitLab で CI/CD ジョブを実行するワーカー。Docker や Shell で動作可能。         |
| `.gitlab-ci.yml` | GitLab の CI/CD パイプラインを定義する YAML ファイル。プロジェクトごとに置く。 |
| Issue            | タスク、バグ報告、アイデアなど。GitLab ではタスク管理の中心となる。            |
| Merge Request    | GitHub の Pull Request に相当。ブランチを統合する前にレビューできる。          |
| Artifact         | CI で生成された成果物（例：zip、バイナリ）。`artifacts:` で指定して保存。      |
| SAML             | シングルサインオンに使われる認証方式の一種。企業の IdP との連携に使用される。  |
| Visibility       | プロジェクトの公開範囲（Private / Internal / Public）を設定する項目。          |

---

# 付録：設定ファイル例

### 1. `.gitlab-ci.yml`（Node.js プロジェクト向け）

```yaml
stages:
  - install
  - test

install:
  stage: install
  script:
    - npm install
  cache:
    paths:
      - node_modules/

test:
  stage: test
  script:
    - npm run test
  artifacts:
    paths:
      - coverage/
```

---

### 2. Docker Compose で GitLab + Runner を起動する例

```yaml
version: "3"

services:
  gitlab:
    image: gitlab/gitlab-ce:latest
    ports:
      - "80:80"
      - "443:443"
      - "22:22"
    volumes:
      - ./config:/etc/gitlab
      - ./logs:/var/log/gitlab
      - ./data:/var/opt/gitlab

  gitlab-runner:
    image: gitlab/gitlab-runner:latest
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./runner-config:/etc/gitlab-runner
```

---

ご希望があれば、次に「全体 PDF 化」「Google Docs 整形版」「Markdown リポジトリとして公開」などもご支援できます。ご希望の形式はありますか？
素晴らしいアイデアです！GitLab の公式ドキュメントは内容も充実しており、実際の利用者にも信頼されています。
以下に「第 2 章：機能概要」と「第 4 章：主要機能の使い方」の各節に対応した**GitLab 公式ドキュメントのリファレンス URL**を追記したバージョンを用意しました。

---

## 🔗 第 2 章：GitLab の機能概要（参考リンク付き）

### 2.1 Git リポジトリ機能

Git ベースのソースコード管理、ブランチ・マージ操作、コードレビューなど
🔗 [GitLab Docs – Source Code Management (SCM)](https://docs.gitlab.com/ee/user/project/repository/)

---

### 2.2 パイプライン機能（CI/CD）

`.gitlab-ci.yml` によるジョブ定義と自動実行、可視化されたパイプライン
🔗 [GitLab Docs – CI/CD Pipelines](https://docs.gitlab.com/ee/ci/pipelines/)

---

### 2.3 ボード機能（スクラム対応）

Issue をカンバンボードで管理し、スクラム／PBL に応用可能
🔗 [GitLab Docs – Issue Boards](https://docs.gitlab.com/ee/user/project/issue_board.html)

---

### 2.4 成果物管理機能（アーティファクト、パッケージ）

CI で生成されたファイルの保存、配布、リリースノート作成など
🔗 [GitLab Docs – CI/CD Artifacts](https://docs.gitlab.com/ee/ci/pipelines/job_artifacts.html)
🔗 [GitLab Docs – Package Registry](https://docs.gitlab.com/ee/user/packages/)

---

## 🔗 第 4 章：主要機能の使い方（参考リンク付き）

### 4.1 Git リポジトリ機能の使い方

🔗 [GitLab Docs – Working with Projects](https://docs.gitlab.com/ee/user/project/index.html)

---

### 4.2 パイプライン機能の使い方

🔗 [GitLab Docs – CI/CD Pipelines: Getting Started](https://docs.gitlab.com/ee/ci/quick_start/)

---

### 4.3 ボード機能の使い方（スクラム対応）

🔗 [GitLab Docs – Managing Issue Boards](https://docs.gitlab.com/ee/user/project/issue_board.html#using-an-issue-board)

---

### 4.4 成果物管理機能の使い方

🔗 [GitLab Docs – GitLab CI/CD Artifacts Guide](https://docs.gitlab.com/ee/ci/pipelines/job_artifacts.html)
🔗 [GitLab Docs – Releases](https://docs.gitlab.com/ee/user/project/releases/)

---もちろんです！以下に「**第 5 章：運用方法**」の各項目に対応する **GitLab 公式ドキュメントのリファレンスリンク** を追記したバージョンを提示します。

---

## 🔗 第 5 章：運用方法（参考リンク付き）

### 5.1 バックアップ

GitLab のデータ（リポジトリ、データベース、アーティファクトなど）のバックアップと復元方法
🔗 [GitLab Docs – Create a Backup](https://docs.gitlab.com/ee/raketasks/backup_restore.html#create-a-backup-of-the-gitlab-system)
🔗 [GitLab Docs – Restore from Backup](https://docs.gitlab.com/ee/raketasks/backup_restore.html#restore-a-backup-of-the-gitlab-system)

---

### 5.2 アクセス制御

ユーザー権限の管理、ロール（Guest〜Owner）の概要と活用方法
🔗 [GitLab Docs – Project Members Permissions](https://docs.gitlab.com/ee/user/project/members/)
🔗 [GitLab Docs – Roles and Permissions](https://docs.gitlab.com/ee/user/permissions.html)

---

### 5.3 認証システムとの連携（シングルサインオン）

LDAP、SAML、OAuth2 などとの外部認証統合設定方法
🔗 [GitLab Docs – OmniAuth Overview](https://docs.gitlab.com/ee/integration/omniauth.html)
🔗 [GitLab Docs – SAML SSO](https://docs.gitlab.com/ee/integration/saml.html)
🔗 [GitLab Docs – LDAP Authentication](https://docs.gitlab.com/ee/administration/auth/ldap.html)

---

### 5.4 セキュリティ管理

パスワードポリシー、SSH キー、トークン管理、監査ログ等のセキュリティ対策
🔗 [GitLab Docs – Security Best Practices](https://docs.gitlab.com/ee/topics/security/)
🔗 [GitLab Docs – SSH Keys](https://docs.gitlab.com/ee/user/ssh.html)
🔗 [GitLab Docs – Personal Access Tokens](https://docs.gitlab.com/ee/user/profile/personal_access_tokens.html)
🔗 [GitLab Docs – Audit Events (Premium 以上)](https://docs.gitlab.com/ee/administration/audit_events.html)

---

はい、**EC2 + GitLab（Docker）構成**におけるバックアップ戦略は、次の 2 つの層に分けて設計・運用するのが実践的です：

---

# ✅ 5.1 バックアップ（詳細手順付き）

## 概要

GitLab を安定運用する上で、**定期的なバックアップは必須**です。
特に以下の 2 つを分けて考える必要があります：

### 🔹（A）GitLab アプリケーションのバックアップ

GitLab が管理する **リポジトリ・DB・アーティファクト** などのバックアップ
👉 GitLab 公式の `gitlab-backup` コマンドで実行

### 🔹（B）EC2 インスタンス全体のバックアップ

GitLab 以外の環境設定も含めた **OS 丸ごとスナップショット**
👉 EC2 の EBS スナップショットとして管理

---

## 🔸（A）GitLab アプリケーションのバックアップ

### 🔧 対象データ

Docker 上で GitLab を運用している場合、以下の 3 つのボリュームに重要データが格納されています：

| ホストパス         | コンテナマウント先 | 内容                          |
| ------------------ | ------------------ | ----------------------------- |
| `~/gitlab/config/` | `/etc/gitlab`      | GitLab 設定ファイル群         |
| `~/gitlab/logs/`   | `/var/log/gitlab`  | ログ                          |
| `~/gitlab/data/`   | `/var/opt/gitlab`  | リポジトリ・DB・CI データなど |

---

### ✅ バックアップ手順（GitLab 公式）

1. **GitLab コンテナに入る**

```bash
sudo docker exec -it gitlab /bin/bash
```

2. **バックアップコマンドを実行**

```bash
gitlab-backup create
```

3. **完了後、以下のパスに `.tar` バックアップファイルが作成される**

```
/var/opt/gitlab/backups/
例: 1714186411_2024_04_27_16.4.2_gitlab_backup.tar
```

4. **ホスト側にコピーして、外部ストレージ等に保存（推奨）**

```bash
# ホスト側で実行
sudo docker cp gitlab:/var/opt/gitlab/backups/1714186411_*.tar ./backups/
```

---

### ✅ 復元手順

1. `.tar` ファイルを GitLab コンテナ内に配置し、GitLab を停止：

```bash
sudo docker cp 1714186411_backup.tar gitlab:/var/opt/gitlab/backups/
sudo docker exec -it gitlab gitlab-ctl stop unicorn
sudo docker exec -it gitlab gitlab-ctl stop sidekiq
```

2. **バックアップを復元：**

```bash
sudo docker exec -it gitlab gitlab-backup restore BACKUP=1714186411_2024_04_27_16.4.2
```

3. **再起動：**

```bash
sudo docker exec -it gitlab gitlab-ctl restart
```

---

## 🔸（B）EC2 インスタンス（OS ごと）のバックアップ

GitLab に加えて、OS や Docker 設定、各種ログも含めた丸ごとのバックアップを行うには、**Amazon EC2 の EBS スナップショット機能**を活用します。

### ✅ バックアップ手順（EBS スナップショット）

1. AWS マネジメントコンソールで EC2 ダッシュボードに移動
2. 対象インスタンスの **ルート EBS ボリューム** を確認
3. 「アクション」→「スナップショットを作成」
4. 名前、説明を付けて実行

> ⏰ 自動スナップショット化には「ライフサイクルマネージャー」設定が便利

---

## 💡 実運用のポイント

| 項目             | 推奨事項                                                      |
| ---------------- | ------------------------------------------------------------- |
| バックアップ頻度 | `gitlab-backup`：1 日 1 回、`EBSスナップショット`：週 1〜月 1 |
| バックアップ先   | 外部ディスク・S3・リモートサーバーなどに定期転送              |
| テスト復元       | 月 1 回以上、テスト環境で復元手順を確認                       |
| 自動化           | `cron` or `systemd timer` で GitLab バックアップを定期実行    |

---

## 🔗 公式ドキュメントリンクまとめ

- 🔧 [Create a Backup](https://docs.gitlab.com/ee/raketasks/backup_restore.html#create-a-backup-of-the-gitlab-system)
- ♻️ [Restore from Backup](https://docs.gitlab.com/ee/raketasks/backup_restore.html#restore-a-backup-of-the-gitlab-system)
- 🛡️ [EC2 – EBS Snapshot](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ebs-creating-snapshot.html)

---S
以下に、「**2.1 Git リポジトリ機能**」に対応する **GitLab 上での具体的な利用手順** を丁寧に解説します。
GitLab Flow に基づいた**実際の開発操作**（ブランチ作成〜マージまで）をベースにしています。

---

## 🔧 2.1 Git リポジトリ機能（詳細手順）

GitLab のリポジトリ機能は、ブランチの作成、マージリクエスト（Merge Request）の送信、レビュー、差分比較などを一連の流れで直感的に扱えるようになっています。

---

### 🪜 ステップ 1：新しいプロジェクトの作成

1. GitLab にログイン
2. 右上の「**\[New project]**」ボタンをクリック
3. 以下を入力

   - Project name：例 `sample-app`
   - Visibility level：Private（推奨）

4. 「**Initialize repository with a README**」にチェック
5. 「**\[Create project]**」をクリック

---

### 🪜 ステップ 2：リポジトリをクローン

```bash
# HTTPSまたはSSHでクローン（プロジェクト画面の "Clone" ボタンから取得）
git clone https://gitlab.example.com/your-username/sample-app.git
cd sample-app
```

---

### 🪜 ステップ 3：新しいブランチの作成と作業

```bash
# 作業用の新ブランチ作成（例：feature/login）
git checkout -b feature/login

# ファイルを編集
echo "<h1>Login Page</h1>" > login.html

# コミット
git add login.html
git commit -m "Add login page"

# GitLab にプッシュ
git push origin feature/login
```

---

### 🪜 ステップ 4：マージリクエスト（Merge Request）の作成

1. GitLab プロジェクトページにアクセス
2. 「**Merge Requests**」タブをクリック
3. 「**New merge request**」をクリック
4. 以下を設定

   - Source branch: `feature/login`
   - Target branch: `main`

5. 「Compare branches and continue」をクリック
6. タイトル・説明を記入し、「**Create merge request**」をクリック

---

### 🪜 ステップ 5：コードレビュー・差分比較

レビュワーは以下のように操作できます：

- 「Changes」タブで差分を確認
- 行単位でコメント（+マーク）を追加
- 「Approve」や「Request changes」でフィードバック

---

### 🪜 ステップ 6：マージの実行

すべてのレビューが完了したら、MR 画面右上の「**Merge**」ボタンをクリック
※オプション：マージ後にブランチを自動削除する設定も可能（`Delete source branch`）

---

### 🪜 ステップ 7：履歴管理と差分確認

- 「Repository → Commits」で履歴を一覧表示
- 「Repository → Compare」で任意の 2 ブランチ間の差分を確認可能

---

## 🔗 参考リンク（公式ドキュメント）

- [GitLab Docs – Repositories](https://docs.gitlab.com/ee/user/project/repository/)
- [GitLab Docs – Working with branches](https://docs.gitlab.com/ee/user/project/repository/branches/)
- [GitLab Docs – Merge requests](https://docs.gitlab.com/ee/user/project/merge_requests/)

---

## ✅ 補足：ブランチ戦略について

- **GitLab Flow**（公式推奨）：`main` に常にデプロイ可能な状態を保ち、`feature/*` や `fix/*` ブランチで並列開発し、マージリクエストで統合。
- **運用 Tips**：

  - `main` 直 Push を禁止（「Protected Branches」機能）
  - MR 作成時に CI/CD で自動テストを回す

---

以下に「**2.2 パイプライン機能（CI/CD）**」の詳細な使い方（ステップバイステップ）を示します。
`.gitlab-ci.yml` の作成から GitLab Runner による自動実行、実行結果の確認までをカバーします。

---

## 🔧 2.2 パイプライン機能（CI/CD）詳細手順

GitLab の CI/CD は `.gitlab-ci.yml` をプロジェクトのルートに置くだけで使えます。コードの変更を push すると、自動的にジョブが実行されます。

---

### 🪜 ステップ 1：GitLab Runner が設定されていることを確認

- 管理者権限がある場合、`/admin/runners` で確認
- プロジェクトレベルでも `Settings > CI/CD > Runners` に登録されているか確認

> 🔗 参考：[GitLab Docs – Runners](https://docs.gitlab.com/ee/ci/runners/)

---

### 🪜 ステップ 2：`.gitlab-ci.yml` を作成する

プロジェクトのルートディレクトリに以下のような CI 設定ファイルを追加します。

#### 例：Node.js プロジェクト用の簡単な CI 設定

```yaml
stages:
  - install
  - test

install-job:
  stage: install
  script:
    - echo "Installing dependencies..."
    - npm install
  cache:
    paths:
      - node_modules/

test-job:
  stage: test
  script:
    - echo "Running tests..."
    - npm run test
```

> 💡 `.gitlab-ci.yml` は YAML フォーマット。インデントはスペース 2 つ以上で厳密です。

---

### 🪜 ステップ 3：CI/CD の自動実行を確認する

1. `.gitlab-ci.yml` を `main` または任意のブランチにコミット & push：

```bash
git add .gitlab-ci.yml
git commit -m "Add GitLab CI config"
git push origin main
```

2. GitLab Web UI → 「**CI/CD > Pipelines**」にアクセス
3. 実行中または完了したパイプラインが表示されているはずです

---

### 🪜 ステップ 4：ジョブログやステータスの確認

1. 「Pipelines」一覧から実行されたものをクリック
2. 各ステージ（install, test）のジョブが表示されます
3. ジョブ名をクリックするとログ（標準出力）が見られます

---

### 🪜 ステップ 5：失敗時の通知・可視化

- ジョブが失敗した場合、赤い × 印で表示されます
- Slack やメール通知を設定している場合は通知が届きます
- 「Retry」ボタンで再実行可能

---

### 💡 応用：成果物やキャッシュの活用

#### 成果物の保存（例：test レポート）

```yaml
artifacts:
  paths:
    - coverage/
  expire_in: 1 week
```

#### キャッシュの利用（例：依存解決高速化）

```yaml
cache:
  paths:
    - node_modules/
```

---

## 🔗 公式ドキュメントリンク（参照）

- 📄 [GitLab CI/CD Pipelines 概要](https://docs.gitlab.com/ee/ci/pipelines/)
- ⚙️ [GitLab CI/CD YML 記述ガイド](https://docs.gitlab.com/ee/ci/yaml/)
- 🏃 [GitLab Runner ドキュメント](https://docs.gitlab.com/runner/)

---

## ✅ 補足：よく使う CI 構文（チートシート）

| 要素          | 説明                                    |
| ------------- | --------------------------------------- |
| `stages`      | 実行順序を定義（build → test → deploy） |
| `script`      | シェルで実行するコマンド                |
| `only/except` | 実行条件（特定ブランチのみなど）        |
| `artifacts`   | 出力ファイルをジョブ後に保存            |
| `cache`       | 依存などを再利用して実行時間を短縮      |

---以下に、**GitLab CI/CD でステージごとに通知（Slack など）を送る方法**の具体例を示します。

GitLab では通常、**パイプライン全体の成功/失敗に対して通知を送る**設定が多いですが、**ジョブ（ステージ）ごとに通知を出す方法**も可能です。
通知先としては Slack や Discord、メールなどが一般的です。

---

## ✅ 前提：Slack 通知のための準備

1. GitLab のプロジェクト設定から
   `Settings > Integrations > Slack notifications` を開く
   （もしくは `/your_project/hooks` に直接アクセス）

2. Slack の Webhook URL（Incoming Webhook）を入力

3. イベントごとに通知を有効化（例：Job succeeded/failed）

> 参考：
> 🔗 [GitLab Docs – Slack notifications](https://docs.gitlab.com/ee/user/project/integrations/slack.html)

---

## ✅ 方法 ①：ステージごとに `script:` で通知を送る（最も柔軟）

Slack 通知をカスタムで送りたい場合、Slack Webhook を直接叩きます。

```yaml
stages:
  - build
  - test

build:
  stage: build
  script:
    - echo "Building..."
    - curl -X POST -H 'Content-type: application/json' \
        --data '{"text":"🚧 Build stage started!"}' \
        https://hooks.slack.com/services/XXXX/YYYY/ZZZZ

test:
  stage: test
  script:
    - echo "Testing..."
    - curl -X POST -H 'Content-type: application/json' \
        --data '{"text":"🧪 Test stage completed!"}' \
        https://hooks.slack.com/services/XXXX/YYYY/ZZZZ
```

> 💡 `curl`で Webhook に POST するだけなので、他の通知サービス（Discord、Mattermost、LINE Notify など）にも応用可能。

---

## ✅ 方法 ②：パイプラインフック＋条件付き通知（成功/失敗別）

ステージ単位で通知のトーンを変えたい場合は、`after_script` + `$CI_JOB_STATUS` を使う手もあります：

```yaml
test:
  stage: test
  script:
    - ./run_tests.sh
  after_script:
    - >
      if [ "$CI_JOB_STATUS" = "success" ]; then
        curl -X POST -H 'Content-type: application/json' \
          --data '{"text":"✅ テスト成功"}' \
          https://hooks.slack.com/services/XXXX/YYYY/ZZZZ;
      else
        curl -X POST -H 'Content-type: application/json' \
          --data '{"text":"❌ テスト失敗"}' \
          https://hooks.slack.com/services/XXXX/YYYY/ZZZZ;
      fi
```

---

## ✅ 方法 ③：パイプライン全体の通知（ビルトイン）

```yaml
notifications:
  slack:
    webhook: https://hooks.slack.com/services/XXXX/YYYY/ZZZZ
    on_success: always
    on_failure: always
```

> これは `.gitlab-ci.yml` に直接書く方法ではなく、**GitLab UI で統合設定するパターン**です。

---

## ✅ 応用：テンプレート化する場合（複数ジョブ対応）

通知部分だけを `.gitlab-ci.yml` に関数化したいときは、YAML アンカーを使うと便利です：

```yaml
.default-slack-notify: &slack-notify
  script:
    - curl -X POST -H 'Content-type: application/json' \
        --data '{"text":"📦 $CI_JOB_NAME finished with status: $CI_JOB_STATUS"}' \
        https://hooks.slack.com/services/XXXX/YYYY/ZZZZ

notify:
  stage: notify
  <<: *slack-notify
  when: always
```

---

## 🔐 セキュリティ上の注意

- Slack Webhook URL は**変数（環境変数）に置く**のがベストです
  GitLab UI → `Settings > CI/CD > Variables` に登録し、`$SLACK_WEBHOOK` として使いましょう。

```yaml
script:
  - curl -X POST -H 'Content-type: application/json' \
      --data '{"text":"✅ Job done!"}' $SLACK_WEBHOOK
```

---はい、**GitLab からメールを送信するにはメールサーバー（SMTP サーバー）が必須**です。
ただし、**自前で用意しなくても、外部のメールサービス（Gmail, SendGrid, Amazon SES など）を使って送信可能**です。

以下に、メール通知の概要と、よく使われる SMTP サービスを利用した設定方法を説明します。

---

## ✅ GitLab のメール通知概要

### ✉️ GitLab が送る通知の例：

- ユーザー登録時の確認メール
- パイプライン（CI/CD）の成功・失敗通知
- マージリクエストの更新通知
- コメント、Issue のメンション通知など

> つまり **ユーザーに直接届く開発通知の中核**です。

---

## ✅ メールサーバー（SMTP）の選択肢

| 種類                | 説明                                       |
| ------------------- | ------------------------------------------ |
| Gmail               | 個人利用向け。制限あり。2 段階認証必須     |
| SendGrid            | 無料枠あり。API キーで認証。商用にも人気   |
| Amazon SES          | AWS アカウントがあれば利用可。低コスト     |
| SMTP2GO, Mailgun 等 | 他にも無料で使える SMTP サービスが複数ある |

---

## ✅ GitLab で SMTP を設定する方法（例：SendGrid）

### 1. `gitlab.rb` に以下を追加：

```ruby
gitlab_rails['smtp_enable'] = true
gitlab_rails['smtp_address'] = "smtp.sendgrid.net"
gitlab_rails['smtp_port'] = 587
gitlab_rails['smtp_user_name'] = "apikey"  # 固定文字列（SendGrid用）
gitlab_rails['smtp_password'] = "SG.xxxxxx"  # SendGridのAPIキー
gitlab_rails['smtp_domain'] = "example.com"
gitlab_rails['smtp_authentication'] = "plain"
gitlab_rails['smtp_enable_starttls_auto'] = true

gitlab_rails['gitlab_email_from'] = 'noreply@example.com'
```

> `example.com` → 自分のドメイン or 任意のメールアドレスに変更

### 2. 設定の反映：

```bash
sudo gitlab-ctl reconfigure
```

---

## ✅ テスト送信コマンド（メール確認用）

```bash
gitlab-rails console
Notify.test_email('your@email.com', 'テストメール', 'GitLabからの通知です').deliver_now
```

---

## ✅ CI/CD のジョブ失敗をメール通知で受けたいとき

これはユーザーの通知設定でできます：

1. GitLab の右上 → `Preferences`（プロフィール）
2. `Notifications` → Custom に設定
3. 「Failed pipeline」や「Merge Request events」などを有効化
4. `watch` 対象プロジェクトに「参加」している必要あり

---

## ✅ メールが届かない時のチェックリスト

| チェック項目          | 対策例                                             |
| --------------------- | -------------------------------------------------- |
| SMTP 情報に誤り       | ポート番号、ユーザー名、API キーを再確認           |
| 迷惑メール扱い        | 自分の受信箱を確認／ドメインをホワイトリストに     |
| GitLab 側の再起動忘れ | `gitlab-ctl restart`                               |
| メール認証不足        | SPF/DKIM の設定を DNS 側で確認（特に独自ドメイン） |

---

ご希望であれば：

- Gmail SMTP 用設定例
- SendGrid の無料アカウント設定手順
- `.env` ファイルによる Docker Compose との統合方法

なども提供可能です。お気軽にどうぞ！
結論から言うと、**オンプレの GitLab で通知メールを出すには、何らかのメール転送手段（MTA または外部 SMTP）が必須**です。GitLab 自体には MTA は同梱されていないため、以下 2 つのどちらかを用意・設定する必要があります。

---

### 1. サーバー内に MTA（Postfix など）を立てる

- GitLab は `/usr/sbin/sendmail` が使える環境なら自動でそれを呼び出してメールを送ります。
  その場合、`gitlab.rb` に追加の **SMTP 設定は不要** で、`gitlab_email_from` など送信元アドレスだけ指定すれば OK です。
- MTA をコンテナ外に置く場合は、25 番ポートを localhost で開けておくだけで動作します（Docker-Compose なら postfix 用コンテナを 1 つ追加してリンク）。

---

### 2. 外部 SMTP（Gmail, SES, SendGrid など）を経由する

- Omnibus パッケージ（Docker 版を含む）の場合は `/etc/gitlab/gitlab.rb` に下記のようなブロックを追加し、`gitlab-ctl reconfigure` を実行します。

```ruby
gitlab_rails['smtp_enable']              = true
gitlab_rails['smtp_address']             = "smtp.example.com"
gitlab_rails['smtp_port']                = 587        # SES なら 587
gitlab_rails['smtp_user_name']           = "USERNAME"
gitlab_rails['smtp_password']            = "PASSWORD"
gitlab_rails['smtp_domain']              = "example.com"
gitlab_rails['smtp_authentication']      = "login"
gitlab_rails['smtp_enable_starttls_auto']= true
gitlab_rails['gitlab_email_from']        = "[email protected]"
gitlab_rails['gitlab_email_reply_to']    = "noreply@example.com"
```

> **ポイント**
> • SMTP ポート（465/587/25）をファイアウォールで許可
> • パスワードに `'` などの区切り文字を含めない（YAML/Ruby の解釈事故防止）
> • 資格情報を平文で置きたくない場合は GitLab の「暗号化設定」機能で `smtp.yaml.enc` に分離可能

---

### 動作確認（テストメール送信）

```bash
# root で
gitlab-rails console
irb(main):001> Notify.test_email('[email protected]', 'GitLab テスト', 'メール送信テスト').deliver_now
```

送信に成功すればコンソールに `Delivered mail` と表示され、Sidekiq のジョブ失敗ログも出ません。

---

## まとめ

| ケース                      | 追加ソフト                | `gitlab.rb` での SMTP 設定           |
| --------------------------- | ------------------------- | ------------------------------------ |
| 同一ホストに Postfix / Exim | 必要なし（sendmail 経由） | **不要**（`gitlab_email_from` だけ） |
| 外部 SMTP を利用            | 不要                      | **必須**（`smtp_*` ブロックを記述）  |

> **メールサーバーがまったく無い環境では GitLab は通知を送れません。**
> 送信手段をどちらか決めて設定したうえで `gitlab-ctl reconfigure` → テストメール、が最短ルートです。
> 以下では **Ubuntu 22.04 ＋ Docker-GitLab**（Omnibus コンテナ版）を例に、「同一 EC2 インスタンス内に Postfix を“送信専用 MTA”として立て、GitLab から通知メールを飛ばす」までの手順をハンズオン形式でまとめました。―最短 15 分程度で動作確認できます。

---

## 0. 前提チェック

| 確認項目                 | 推奨値                                                                                                  |
| ------------------------ | ------------------------------------------------------------------------------------------------------- |
| OS                       | Ubuntu 22.04 LTS                                                                                        |
| GitLab                   | `gitlab/gitlab-ee:latest` など Omnibus コンテナ                                                         |
| ドメイン名               | `gitlab.example.com`（A/AAAA レコード済み）                                                             |
| EC2 セキュリティグループ | 送信用 TCP 25 / 465 / 587 の **Outbound** を許可（AWS は 25 番を既定で遮断。解除申請か SES 587 利用へ） |
| IAM・Root 権限           | `sudo` が使える                                                                                         |

---

## 1. Postfix の導入（Internet Site モード）

```bash
sudo apt update
sudo DEBIAN_FRONTEND=noninteractive \
     apt install -y postfix mailutils
```

- インストールウィザードが出たら **「Internet Site」** を選択し、
  **System mail name** にホスト名 `gitlab.example.com` を入力する
  → `/etc/postfix/main.cf` が自動生成される。

---

## 2. 「送信専用」に絞った最小構成

```bash
sudo postconf -e "myhostname = gitlab.example.com"
sudo postconf -e "inet_interfaces = loopback-only"      # 外部からの受信を遮断
sudo postconf -e "mydestination ="                      # 自分宛メールも配送しない
sudo postconf -e "relayhost ="                          # 直接配送（MX へ手渡し）
sudo postconf -e "mynetworks = 127.0.0.0/8 [::1]/128 172.17.0.0/16"
                                                       # Docker ブリッジを許可
sudo systemctl restart postfix
```

- 以上で **localhost:25** に Postfix が常駐。
- SPF レコードを例：`"v=spf1 mx a ip4:<EC2のIP>/32 -all"` として追加すると迷惑メール判定を避けやすい。
- 25 番が AWS でブロックされる場合は `relayhost = [email-smtp.ap-northeast-1.amazonaws.com]:587` など **SES**/外部 SMTP を指定し、587/TLS に切り替える（資格情報は `/etc/postfix/sasl_passwd` + `postmap`）。

---

## 3. GitLab 側の準備

1. **`/srv/gitlab/config/gitlab.rb`**（ボリュームの場所は compose により異なる）に **送信元だけ** 追記：

   ```ruby
   gitlab_rails['gitlab_email_from']  = '[email protected]'
   gitlab_rails['gitlab_email_reply_to'] = '[email protected]'
   # SMTP ブロックは書かない（Postfix に sendmail で渡すため）
   ```

2. 反映：

   ```bash
   docker exec -it gitlab gitlab-ctl reconfigure
   docker exec -it gitlab gitlab-ctl restart
   ```

> **補足**
> Omnibus コンテナには `/usr/sbin/sendmail` ラッパーが内蔵されており、
> SMTP 設定が空ならローカル MTA へフォールバックする設計です。
> そのため **追加パッケージやバイナリマウントは不要** です。

---

## 4. Postfix への疎通を確認

```bash
# ホスト側
echo "Subject: postfix-local-test\n\nOK" | sendmail -v [email protected]

# GitLab コンテナ内
docker exec -it gitlab bash -c \
  "echo 'Subject: gitlab-sendmail-test\n\nGitLab OK' | sendmail -v [email protected]"
```

- コンソールに `250 2.0.0 Ok: queued as ...` が出れば配送キュー投入完了。
- メールが届かない場合は `/var/log/mail.log`（ホスト）と
  `docker logs gitlab | grep sidekiq` を確認。

---

## 5. GitLab のテストメール

```bash
docker exec -it gitlab gitlab-rails console
irb(main):001> Notify.test_email('[email protected]', 'GitLab テスト', 'メール送信テスト').deliver_now
```

`Delivered mail` が返り、受信トレイにメールが来ればすべて完了です。

---

### よくあるハマりどころ

| 症状                       | 原因・対策                                                             |
| -------------------------- | ---------------------------------------------------------------------- |
| **Connection timed out**   | AWS が 25 番を遮断。SES 587/TLS へ変更か「Port 25 制限解除」申請。     |
| **Relay access denied**    | Postfix `mynetworks` に Docker ブリッジ (`172.17.0.0/16`) を追加漏れ。 |
| **SPF/DMARC で弾かれる**   | DNS に SPF（`v=spf1 a mx ip4:...`）と簡易 DMARC (`p=none`) を登録。    |
| **迷惑メールフォルダ行き** | 逆引き DNS をホスト名に合わせる＋ DKIM を後から設定。                  |

---

## まとめ

1. `apt install postfix` → Internet Site で最小構成。
2. `inet_interfaces = loopback-only`＆`mydestination =` で **送信専用** に。
3. GitLab 側は `gitlab_email_from` だけ設定し、`reconfigure`。
4. `sendmail` テスト → GitLab テストメールで受信確認。

## これで **外部 SMTP を借りずにオンプレ GitLab から通知メールを自給自足** できます。運用開始後は `mail.log` を週次でチェックし、バウンス率が高い場合は SPF/DKIM を強化してください。

了解しました！
以下に、**GitLab におけるアクセス権限の設定方法**と、\*\*アカウントの種類（権限）ごとの操作可否一覧（星取表）\*\*をまとめます。

---

## ✅ アクセス権限の設定方法（プロジェクト/グループ）

### ▶ プロジェクト単位でのユーザー招待

1. プロジェクト画面の右上 → 「**Settings > Members**」
2. 「**Invite member**」ボタンをクリック
3. 招待するユーザーの GitLab アカウント（ユーザー名またはメール）を入力
4. **ロール（Guest / Reporter / Developer / Maintainer）** を選択
5. 「Invite」ボタンで招待完了

### ▶ グループ単位でのロール設定

1. グループ画面 → 「**Group > Members**」
2. 同様にユーザーを追加
3. グループに属していれば、配下のプロジェクトすべてに自動的に権限が適用される

> 🔐 **注意**：`Owner` 権限はプロジェクトではなく **グループ単位** でのみ付与できます。

---

## ✅ アカウント権限別：機能操作可否（星取表）

| 機能                           | Guest | Reporter | Developer | Maintainer | Owner（※グループのみ） |
| ------------------------------ | :---: | :------: | :-------: | :--------: | :--------------------: |
| Issue の閲覧・作成             |  ✅   |    ✅    |    ✅     |     ✅     |           ✅           |
| コメントの投稿                 |  ✅   |    ✅    |    ✅     |     ✅     |           ✅           |
| ソースコードの閲覧（クローン） |  ❌   |    ✅    |    ✅     |     ✅     |           ✅           |
| ブランチ作成・Push             |  ❌   |    ❌    |    ✅     |     ✅     |           ✅           |
| マージリクエスト（MR）作成     |  ❌   |    ❌    |    ✅     |     ✅     |           ✅           |
| MR のマージ                    |  ❌   |    ❌    |    ❌     |     ✅     |           ✅           |
| CI/CD ジョブのトリガー／編集   |  ❌   |    ❌    |    ✅     |     ✅     |           ✅           |
| Protected Branch 設定          |  ❌   |    ❌    |    ❌     |     ✅     |           ✅           |
| Webhook や変数などの設定       |  ❌   |    ❌    |    ❌     |     ✅     |           ✅           |
| プロジェクトの削除             |  ❌   |    ❌    |    ❌     |     ✅     |           ✅           |
| グループメンバー管理           |  ❌   |    ❌    |    ❌     |     ❌     |           ✅           |

> ✅：可能　 ❌：不可

---

## 🔗 関連公式ドキュメント

- 🔐 [GitLab Docs – Project Members and Roles](https://docs.gitlab.com/ee/user/project/members/)
- 🧑‍🤝‍🧑 [GitLab Docs – Group Members](https://docs.gitlab.com/ee/user/group/members/)

---

もし **Guest だけが見えるビューを制限したい**、**CI 編集権限を更に細分化したい**などのケースがあれば、**Protected Branches / Custom Roles（Ultimate）** も活用できます。
追加のニーズがあればお知らせください！
良い質問です！
GitLab における「**Owner（オーナー）**」は、**グループにおける最上位の権限**であり、**プロジェクト単体では設定できない特別なロール**です。

---

## 🔹 Owner（オーナー）とは？

| 属性           | 説明                                                                                  |
| -------------- | ------------------------------------------------------------------------------------- |
| 対象           | **グループ**に対してのみ設定できる（プロジェクトには存在しない）                      |
| 権限レベル     | **Maintainer 以上**の全権限を持ち、グループやすべての配下プロジェクトを完全に操作可能 |
| できることの例 | グループ削除、名前変更、支払い情報の管理、SAML 設定、サブグループ管理など             |

---

## 🔧 Owner ができる主なこと（例）

| 操作内容                               | Owner | Maintainer |
| -------------------------------------- | :---: | :--------: |
| グループの名前・URL の変更             |  ✅   |     ❌     |
| グループの削除                         |  ✅   |     ❌     |
| グループメンバー（Owner）の追加・削除  |  ✅   |     ❌     |
| グループの可視性（Public/Private）設定 |  ✅   |     ❌     |
| サブグループの作成                     |  ✅   |     ❌     |
| SAML や LDAP 認証の設定                |  ✅   |     ❌     |
| GitLab のサブスクリプション/課金設定   |  ✅   |     ❌     |

---

## 📌 注意点

- Owner 権限は **強力すぎるため、安易に付与しないことが推奨**されます。
- プロジェクトレベルで一見 "管理者" に見える **Maintainer** とは明確に役割が違います。
- 誤って GitLab グループを削除されると、その配下のプロジェクトも一括で消える可能性があるため、**Owner は基本的に限られた管理者のみが持つべき権限**です。

---

## ✅ 関連公式ドキュメント

- [GitLab Docs – Roles and Permissions](https://docs.gitlab.com/ee/user/permissions.html#group-membership-permissions)

---

必要であれば、「オーナーによる事故防止策」や「複数 Owner 体制の是非」など、運用方針面のアドバイスも可能です！
GitLab におけるユーザー権限（ロール）は、**強い順に 5 段階**に分かれており、それぞれのロールには明確な役割と制限があります。

---

## ✅ GitLab のロール一覧（強い順）

| ロール名       | 適用対象     | 権限レベル（強さ） | 主な役割と特徴                                               |
| -------------- | ------------ | ------------------ | ------------------------------------------------------------ |
| **Owner**      | グループのみ | ★★★★★（最強）      | グループと全配下プロジェクトの全権限。請求情報、SSO 設定も可 |
| **Maintainer** | プロジェクト | ★★★★☆              | リポジトリ設定、CI/CD 設定、マージ権限あり。運用責任者に適任 |
| **Developer**  | プロジェクト | ★★★☆☆              | コード作成・ブランチ作成・MR 作成可。実装担当エンジニア向け  |
| **Reporter**   | プロジェクト | ★★☆☆☆              | コードの閲覧・クローン可能。分析・レビューに使いたい場合     |
| **Guest**      | プロジェクト | ★☆☆☆☆              | Issue や Wiki 閲覧程度。社外パートナーや見学者向け           |

---

## 🧑‍💻 各ロールの典型的な用途

| ロール         | こんな人に向いている                             |
| -------------- | ------------------------------------------------ |
| **Owner**      | 管理者、情報システム部門、SRE リーダー           |
| **Maintainer** | プロジェクト責任者、CI/CD 設計者、上級開発者     |
| **Developer**  | 通常の開発メンバー（プログラマ、デザイナーなど） |
| **Reporter**   | ビジネス側のレビュー担当、外部監査担当者など     |
| **Guest**      | 外注業者、クライアント、社外メンター、見学者など |

---

## ✅ 権限ごとの操作可能範囲（まとめ）

| 操作内容                   | Guest | Reporter | Developer | Maintainer | Owner（グループ） |
| -------------------------- | :---: | :------: | :-------: | :--------: | :---------------: |
| Issue 作成・閲覧           |  ✅   |    ✅    |    ✅     |     ✅     |        ✅         |
| ソースコード閲覧・クローン |  ❌   |    ✅    |    ✅     |     ✅     |        ✅         |
| ブランチ作成・Push         |  ❌   |    ❌    |    ✅     |     ✅     |        ✅         |
| Merge Request 作成         |  ❌   |    ❌    |    ✅     |     ✅     |        ✅         |
| Merge 操作                 |  ❌   |    ❌    |    ❌     |     ✅     |        ✅         |
| CI/CD 設定・ジョブの修正   |  ❌   |    ❌    |    ✅     |     ✅     |        ✅         |
| Protected Branch 設定      |  ❌   |    ❌    |    ❌     |     ✅     |        ✅         |
| プロジェクト削除           |  ❌   |    ❌    |    ❌     |     ✅     |        ✅         |
| グループ・支払い・SSO 設定 |  ❌   |    ❌    |    ❌     |     ❌     |        ✅         |

---

## 🔐 特に注意すべきポイント

- **Owner はグループ単位でしか付与できない**
- **Maintainer 以上がプロジェクト設定を変更可能**
- **CI/CD を編集できるのは Developer 以上**
- **Guest や Reporter では Push できない（誤操作リスクを減らす）**

---

ご希望があれば、**ロールごとの画面制限一覧**や、「**ロールを使った社内ルール例（権限の割り振り方）**」もご提案可能です。お気軽にお申し付けください。
とても重要な質問です！
GitLab を使い始めた方にとって、「**root ユーザー**」や「**グループ**」の意味を理解しておくことは、安全で効率的な運用に直結します。

---

## 🔐 root ユーザーとは？

### ✔ GitLab の「管理者ユーザー（＝最高権限アカウント）」のことです。

- GitLab を最初にインストールすると、**最初のアカウントが `root` という名前で作成**されます（変更可能）。
- **すべてのプロジェクト、グループ、ユーザーに対してフルアクセス**を持ちます。

### 💡 root ユーザーの特徴

| 項目                   | 内容                                                         |
| ---------------------- | ------------------------------------------------------------ |
| 権限レベル             | システム全体の管理者（プロジェクトの Owner よりも強力）      |
| できること             | 全ユーザー管理、すべてのプロジェクト閲覧・変更、設定変更など |
| ユースケース           | GitLab サーバの運用者、DevOps 管理者などが使用               |
| 通常のユーザーとの違い | root は他ユーザーのパスワード変更や削除も可能                |

> ⚠ 通常運用で開発者が root を使うことは推奨されません（誤操作リスクが高いため）

---

## 🏢 グループとは？

### ✔ 複数のプロジェクトをまとめて管理する「チームフォルダ」のような単位です。

たとえば：

```
gitlab.example.com/my-team/my-project-a
gitlab.example.com/my-team/my-project-b
```

この場合の `my-team` が「**グループ**」です。

### 💡 グループの主な役割

| 項目                 | 内容                                                                 |
| -------------------- | -------------------------------------------------------------------- |
| 複数プロジェクト管理 | グループに所属するプロジェクトをまとめて管理可能                     |
| 権限の一括管理       | グループメンバーに対して「全プロジェクトに共通のロール」を付与できる |
| サブグループ         | グループの中にさらにグループ（階層構造）を作ることができる           |
| SSO 設定             | グループ単位で SAML などの認証連携ができる（Enterprise 版向け）      |

### 🧑‍🤝‍🧑 メンバーの権限設定もグループ単位で可能！

- グループに `Developer` 権限を持つユーザーは、配下のすべてのプロジェクトでも同様の権限を持ちます。
- グループに `Owner` が 1 人いれば、その人が全プロジェクトを管理できます。

---

## ✍ まとめ（ざっくり説明）

| 用語          | ざっくり言うと…                                               |
| ------------- | ------------------------------------------------------------- |
| root ユーザー | GitLab サーバの「神」アカウント。全てに手を出せる管理者です。 |
| グループ      | プロジェクトをまとめるチームフォルダみたいなものです。        |

---

もし「root を無効にしたい」「グループ運用のベストプラクティスを知りたい」といった具体的な方針がある場合も、お手伝いできます！

## 5.2 アクセス制御（プロジェクトとロールの管理）

GitLab では **ユーザー（個人）** と **グループ（チーム）** にロールを割り当てることで、
「誰が・どのプロジェクトで・何をできるか」を細かく制御できます。
ここでは **ロールの詳細** と **操作可否の星取表**、**設定手順**、
さらに **root ユーザー** や **グループ** といった用語もまとめて解説します。

---

### 5.2.1 ロール（権限）の階層と役割

| ロール名       | 適用対象     | 強さ  | 主な役割・典型的な使い方                                                             |
| -------------- | ------------ | ----- | ------------------------------------------------------------------------------------ |
| **Owner**      | グループのみ | ★★★★★ | グループ全体の最上位。サブグループ作成・削除、SSO 設定、請求管理など運用責任者が担当 |
| **Maintainer** | プロジェクト | ★★★★☆ | 設定変更・Protected Branch 管理・マージ操作。リリース責任者やリードエンジニア向け    |
| **Developer**  | プロジェクト | ★★★☆☆ | ブランチ作成・Push・マージリクエスト作成・CI 編集。通常の開発メンバー                |
| **Reporter**   | プロジェクト | ★★☆☆☆ | ソース閲覧・クローン・Issue/コメント投稿。外部監査やビジネス側レビュワー             |
| **Guest**      | プロジェクト | ★☆☆☆☆ | Issue/Wiki 閲覧・コメント程度。クライアントや見学者向け                              |

> **root ユーザー**
> GitLab サーバを最初にセットアップするときに作成されるシステム管理者アカウント。
> すべてのグループ・プロジェクトを横断してフルアクセスできる「神アカウント」です。
> 通常の開発作業で使うのは推奨されません。

---

#### 操作可否一覧（星取表）

| 操作内容                   | Guest | Reporter | Developer | Maintainer | Owner |
| -------------------------- | :---: | :------: | :-------: | :--------: | :---: |
| Issue の閲覧・作成         |  ✅   |    ✅    |    ✅     |     ✅     |  ✅   |
| ソースコード閲覧／クローン |  ❌   |    ✅    |    ✅     |     ✅     |  ✅   |
| ブランチ作成・Push         |  ❌   |    ❌    |    ✅     |     ✅     |  ✅   |
| Merge Request 作成         |  ❌   |    ❌    |    ✅     |     ✅     |  ✅   |
| Merge 操作                 |  ❌   |    ❌    |    ❌     |     ✅     |  ✅   |
| CI/CD 設定変更             |  ❌   |    ❌    |    ✅     |     ✅     |  ✅   |
| Protected Branch 管理      |  ❌   |    ❌    |    ❌     |     ✅     |  ✅   |
| プロジェクト設定変更       |  ❌   |    ❌    |    ❌     |     ✅     |  ✅   |
| グループ名・SSO・課金設定  |  ❌   |    ❌    |    ❌     |     ❌     |  ✅   |

---

### 5.2.2 グループとプロジェクト

| 用語             | イメージ         | ポイント                                                               |
| ---------------- | ---------------- | ---------------------------------------------------------------------- |
| **グループ**     | チーム用フォルダ | 複数プロジェクトをまとめ、ロールを一括付与できる。サブグループも作成可 |
| **プロジェクト** | リポジトリ単体   | コード・Issue・CI/CD を保持。グループ配下か単独で存在                  |

```
gitlab.example.com/
└─ my-team (グループ)
   ├─ backend-api   (プロジェクト)
   └─ frontend-web  (プロジェクト)
```

---

### 5.2.3 設定手順

#### 1. プロジェクトにユーザーを招待する

1. **Project → Settings → Members**
2. **Invite member** をクリック
3. ユーザー名 / メールを入力
4. ロールを選択（Guest〜Maintainer）
5. Invite で追加

#### 2. グループにユーザーを招待する

1. **Group → Members**
2. Invite member → ロール選択（Guest〜Owner）
3. グループ配下のすべてのプロジェクトに権限が継承される

#### 3. root ユーザーの管理

- `gitlab-rails console` で root のパスワードリセット可能
- 誤操作防止のため、日常作業では **root ではなく個別アカウント** を使用

---

### 5.2.4 ベストプラクティス

| シーン           | 推奨設定                                                              |
| ---------------- | --------------------------------------------------------------------- |
| 外部委託や監査   | Reporter までに制限し **Push 禁止**                                   |
| CI/CD を守りたい | CI 用ファイルを **Protected Branch** に置き、Developer 以上だけ編集可 |
| 誤削除防止       | Owner を最小人数にとどめ、二段階認証を必須化                          |
| 権限レビュー     | 四半期ごとに Members 画面で棚卸し（不要 Guest/Reporter を削除）       |

---

### 5.2.5 公式ドキュメント

- [Project Members & Roles](https://docs.gitlab.com/ee/user/project/members/)
- [Group Members](https://docs.gitlab.com/ee/user/group/members/)
- [Roles and Permissions](https://docs.gitlab.com/ee/user/permissions.html)

---

この章を踏まえ、**安全な権限設計と定期的な棚卸し**で
チームの開発効率とリスク低減を両立させましょう。

### 5.2 アクセス制御（プロジェクトとロールの管理）— Planner 追加版

#### 5.2.1 ロール階層と典型的な役割

| ロール名       | 適用対象     | 強さ\* | 主な役割・典型的な使い方                                                                                                                                                                          |
| -------------- | ------------ | ------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Owner**      | グループ     | ★★★★★  | グループ最上位。サブグループ作成／削除、SSO・請求管理など全権限                                                                                                                                   |
| **Maintainer** | プロジェクト | ★★★★☆  | 設定変更・Protected Branch 管理・MR マージ。リリース責任者に最適                                                                                                                                  |
| **Developer**  | プロジェクト | ★★★☆☆  | ブランチ作成・Push・MR 作成・CI 編集。通常の実装メンバー                                                                                                                                          |
| **Planner**    | プロジェクト | ★★☆☆☆  | **エピック・ロードマップ・Issue ボード・OKR** 等の“計画系機能”にフルアクセス。<br>ソース閲覧や Push は不可 ─ プロダクト/プロジェクトマネージャ向け ([about.gitlab.com][1], [about.gitlab.com][2]) |
| **Reporter**   | プロジェクト | ★★☆☆☆  | ソース閲覧・クローン可能。外部監査やビジネス側レビュワー                                                                                                                                          |
| **Guest**      | プロジェクト | ★☆☆☆☆  | Issue／Wiki 閲覧・コメント程度。顧客・見学者                                                                                                                                                      |

\*★ はあくまで相対的な“権限幅”の目安。

---

#### 5.2.2 操作可否早見表（星取表）

| 操作内容               | Guest | Reporter | **Planner** | Developer | Maintainer | Owner |
| ---------------------- | :---: | :------: | :---------: | :-------: | :--------: | :---: |
| Issue／コメント        |  ✅   |    ✅    |     ✅      |    ✅     |     ✅     |  ✅   |
| エピック作成           |  ❌   |    ❌    |     ✅      |    ✅     |     ✅     |  ✅   |
| ロードマップ閲覧       |  ❌   |    ❌    |     ✅      |    ✅     |     ✅     |  ✅   |
| ソース閲覧／クローン   |  ❌   |    ✅    |     ❌      |    ✅     |     ✅     |  ✅   |
| ブランチ作成・Push     |  ❌   |    ❌    |     ❌      |    ✅     |     ✅     |  ✅   |
| MR 作成                |  ❌   |    ❌    |     ❌      |    ✅     |     ✅     |  ✅   |
| MR マージ              |  ❌   |    ❌    |     ❌      |    ❌     |     ✅     |  ✅   |
| CI/CD 設定編集         |  ❌   |    ❌    |     ❌      |    ✅     |     ✅     |  ✅   |
| Protected Branch 設定  |  ❌   |    ❌    |     ❌      |    ❌     |     ✅     |  ✅   |
| グループ課金・SSO 設定 |  ❌   |    ❌    |     ❌      |    ❌     |     ❌     |  ✅   |

---

#### 5.2.3 設定手順（Planner を含む）

| 操作                              | 手順                                                                                                                                          |
| --------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------- |
| **プロジェクトで Planner を付与** | 1. _Project → Settings → Members_ <br>2. **Invite member** → ユーザー入力 <br>3. **Role** ドロップダウンで **Planner** を選択 <br>4. _Invite_ |
| **グループで Owner／Planner**     | _Group → Members_ で同様にロール選択（Owner はグループのみ）                                                                                  |
| **root ユーザー管理**             | root は GitLab 全体管理者。通常開発には利用せず、<br>必要最小限の運用タスクに限定する                                                         |

> **ライセンス要件**
> Planner ロールは GitLab 17.7 以降で SaaS／Self-managed どちらでも利用可（Free 以上のすべてのエディション） ([about.gitlab.com][2])

---

#### 5.2.4 用語まとめ

| 用語              | 説明                                                                                    |
| ----------------- | --------------------------------------------------------------------------------------- |
| **root ユーザー** | GitLab サーバ初期作成の“神アカウント”。全プロジェクト／設定を操作できるシステム管理者。 |
| **グループ**      | プロジェクトをまとめる単位。ロールを一括付与でき、サブグループで階層管理も可能。        |
| **プロジェクト**  | 1 つの Git リポジトリ＋ Issue ＋ CI/CD 設定を保持する開発単位。                         |

---

#### 5.2.5 ベストプラクティス

- **Planner ロール活用**
  企画/PM がエピックやロードマップを編集でき、コード閲覧を不要にすることで情報漏えいリスクを低減。
- **Owner と root の分離**
  グループ運用は Owner、サーバ運用は root と役割を分け誤操作を防止。
- **定期棚卸し**
  四半期ごとに _Members_ 画面で不要な Planner／Reporter を失効。

---

##### 参考ドキュメント

- Roles & Permissions（最新版） ([docs.gitlab.com][3])
- Planner Role Release Note ([about.gitlab.com][1], [about.gitlab.com][2])

[1]: https://about.gitlab.com/blog/2024/11/25/introducing-gitlabs-new-planner-role-for-agile-planning-teams/?utm_source=chatgpt.com "Introducing GitLab's new Planner role for Agile planning teams"
[2]: https://about.gitlab.com/releases/2024/12/19/gitlab-17-7-released/?utm_source=chatgpt.com "GitLab 17.7 released with new Planner user role"
[3]: https://docs.gitlab.com/user/permissions/?utm_source=chatgpt.com "Roles and permissions - GitLab Docs"

### グループの作成手順（GitLab UI）

| 手順 | 操作                                                                     | 備考                                                                                                        |
| ---- | ------------------------------------------------------------------------ | ----------------------------------------------------------------------------------------------------------- |
| 1    | **左サイドバー最上部の「 ＋ （Create new）」→ 「New group」** をクリック | “Create new” が見当たらない場合は左上の **Menu ≡ → Groups** から「 New group」でも可 ([docs.gitlab.com][1]) |
| 2    | **Create group** を選択                                                  | テンプレートウィザード（Import group など）が出る場合は「Create blank group」を選択                         |
| 3    | **Group name** を入力                                                    | 例：`development`                                                                                           |
| 4    | **Group URL** を入力                                                     | 自動で name が入る。URL は後から変更可                                                                      |
| 5    | **可視性 (Visibility level)** を選択                                     | `Private / Internal / Public` ─ 機密情報がある場合は **Private** を推奨                                     |
| 6    | 必要なら **説明・アバター** を入力                                       | 200 kB 以内の PNG/JPG/GIF                                                                                   |
| 7    | **Create group** をクリック                                              | 数秒後にグループダッシュボードへ遷移し完了 ([docs.gitlab.com][2])                                           |

---

#### サブグループの作成

1. 既存グループ画面右上 **「 New subgroup」**
2. 上記と同じ要領で名称・URL を入力し **Create group**

サブグループに付与したロールは **親グループの設定を継承** します。

---

### CLI／API で作成したい場合

```bash
# GitLab API (v4) 例
curl --header "PRIVATE-TOKEN: <your_token>" \
     --data "name=backend&path=backend&visibility=private" \
     https://gitlab.example.com/api/v4/groups
```

| パラメータ   | 意味                              |
| ------------ | --------------------------------- |
| `name`       | 画面表示名                        |
| `path`       | URL パス（namespace）             |
| `visibility` | `private` / `internal` / `public` |

---

### グループ作成後の主な初期設定チェック

| 設定箇所                                  | 推奨内容                                      |
| ----------------------------------------- | --------------------------------------------- |
| **Settings → General → Path, Visibility** | URL を確定、可視性を Private に固定           |
| **Settings → Members**                    | Owner/Planner/Maintainer など必要最小限を招待 |
| **Settings → CI/CD → Variables**          | 共通環境変数（AWS KEY など）を追加            |
| **Settings → Integrations**               | Slack／メール通知をグループ全体で統一         |

---

### 参考リンク

- GitLab Docs — *Create a group* ([docs.gitlab.com][1])
- GitLab Docs — _Move personal project to group_（グループ作成チュートリアル内ステップ） ([docs.gitlab.com][2])

> **Tips**
>
> - グループを削除すると配下の全プロジェクトも削除対象になるため、**Owner を限定**し、バックアップを取得してから操作しましょう。
> - 既存の個人プロジェクトをまとめたい場合は「Transfer project」機能でグループ配下へ移動できます。

[1]: https://docs.gitlab.com/tutorials/manage_user/?utm_source=chatgpt.com "Tutorial: Set up your organization - GitLab Docs"
[2]: https://docs.gitlab.com/tutorials/move_personal_project_to_group/?utm_source=chatgpt.com "Tutorial: Move your personal project to a group - GitLab Docs"

## ローカル（Self-Managed）GitLab を前提にしたアクセス制御まとめ

バージョンは **GitLab 17.7 以降（Community Edition ＝ Free でも OK）** を想定しています。Planner ロールと Epics は 17.7 で Free tier にも標準搭載されました。([about.gitlab.com][1], [docs.gitlab.com][2])

---

### 1. ロール階層と代表的な役割

| ロール         | 適用対象     | 相対的な強さ | 主な用途・特徴                                                                                                  |
| -------------- | ------------ | ------------ | --------------------------------------------------------------------------------------------------------------- |
| **Owner**      | グループのみ | ★★★★★        | グループ全権限（SSO/課金/削除まで）。配下プロジェクトも一括管理                                                 |
| **Maintainer** | プロジェクト | ★★★★☆        | 設定・Protected Branch 管理・MR マージ。リリース責任者                                                          |
| **Developer**  | プロジェクト | ★★★☆☆        | ブランチ作成・Push・MR 作成・CI 編集。一般開発者                                                                |
| **Planner**    | プロジェクト | ★★☆☆☆        | **計画系機能（Epics・Roadmap・Issue Board）のみフルアクセス**。コード操作不可。PM/PO 用 ([about.gitlab.com][1]) |
| **Reporter**   | プロジェクト | ★★☆☆☆        | ソース閲覧・クローン・Issue 投稿。外部レビュー／監査                                                            |
| **Guest**      | プロジェクト | ★☆☆☆☆        | Issue/Wiki 閲覧とコメントのみ。顧客・見学者                                                                     |
| **root**       | インスタンス | —            | GitLab サーバ管理者アカウント（全プロジェクト／設定に無制限アクセス）                                           |

---

### 2. 操作可否早見表（星取表）

| 操作                   | Guest | Reporter | **Planner** | Dev | Maint. | Owner |
| ---------------------- | :---: | :------: | :---------: | :-: | :----: | :---: |
| Issue／コメント        |  ✅   |    ✅    |     ✅      | ✅  |   ✅   |  ✅   |
| Epic 作成／編集        |  ❌   |    ❌    |     ✅      | ✅  |   ✅   |  ✅   |
| ロードマップ閲覧       |  ❌   |    ❌    |     ✅      | ✅  |   ✅   |  ✅   |
| ソース閲覧／クローン   |  ❌   |    ✅    |     ❌      | ✅  |   ✅   |  ✅   |
| Push／ブランチ作成     |  ❌   |    ❌    |     ❌      | ✅  |   ✅   |  ✅   |
| MR 作成                |  ❌   |    ❌    |     ❌      | ✅  |   ✅   |  ✅   |
| MR マージ              |  ❌   |    ❌    |     ❌      | ❌  |   ✅   |  ✅   |
| CI/CD 編集             |  ❌   |    ❌    |     ❌      | ✅  |   ✅   |  ✅   |
| プロジェクト設定変更   |  ❌   |    ❌    |     ❌      | ❌  |   ✅   |  ✅   |
| グループ削除・SSO 設定 |  ❌   |    ❌    |     ❌      | ❌  |   ❌   |  ✅   |

---

### 3. 設定手順（ローカル GitLab UI）

1. **グループ作成**

   - 左上「 **＋ → New group** 」を選択し、Name／URL／Visibility（通常 **Private**）を設定して **Create group**。([pm.stackexchange.com][3])

2. **プロジェクト作成**

   - グループ内で **New project** → 「Blank project」→ 必要項目を入力 → **Create**。

3. **メンバー招待 & ロール付与**

   - _Project → Settings → Members_ → **Invite member**
   - ユーザー名／メール入力 → **Role** ドロップダウンで Guest/Reporter/Planner/Developer/Maintainer を選択 → **Invite**。
   - グループに招待すれば配下プロジェクトへロールが継承される。

4. **Planner ロールが選択肢にない場合**

   - GitLab 17.7 未満なら Planner 未対応。
   - 17.2〜17.6 の場合は管理者で `Feature flags → work_item_epics` を有効にし、ロール名は Reporter のまま（Planner 以前）。([simlab.ww.uni-erlangen.de][4])

---

### 4. Epics を有効活用するポイント（Self-Managed）

| ステップ             | 内容                                                                                                 |
| -------------------- | ---------------------------------------------------------------------------------------------------- |
| **Epics 有効化確認** | _Group Sidebar → Plan → Epics_ が表示されていれば機能は有効。                                        |
| **Epic 作成**        | グループ左 _Epics_ → **New epic** でタイトル・期日を入力。Planner 以上が必要。([docs.gitlab.com][5]) |
| **Issue 紐付け**     | Epic 右側 _Issues → Add_ から既存 Issue を追加、または Issue で `/epic #<ID>` とコメント。           |
| **ロードマップ表示** | グループ左 _Roadmap_ でエピックのタイムラインを俯瞰。                                                |
| **Epic Boards**      | _Plan → Epic boards_ でラベル別にエピックをカンバン管理。([forum.gitlab.com][6])                     |

> **CE（Community Edition）の場合**
> 17.7 以降はエピックと Planner ロールが Free で使えますが、**より古い CE** ではエピックは利用できません。その場合はラベル＋ Issue Board で代替してください。([pm.stackexchange.com][3])

---

### 5. ベストプラクティス

1. **最小権限の原則**

   - 開発者＝ Developer、PM ＝ Planner、CI 案件を壊せる Maintainer は限定。

2. **root の日常利用は禁止**

   - root は障害対応や初期設定のみ。普段は個人アカウント＋適切ロールで作業。

3. **四半期ごとに棚卸し**

   - _Members_ 画面で Guest/Reporter など不要ユーザーを失効。

4. **Protected Branch** で本番コードを保護

   - `main` を保護し、Maintainer だけが Write / Force Push できるように設定。

---

#### 参考ドキュメント

- Roles & Permissions （Planner 含む） ([docs.gitlab.com][2])
- GitLab 17.7 リリース（Planner ロール紹介） ([about.gitlab.com][1])
- Epics & Epic boards ガイド ([docs.gitlab.com][5], [forum.gitlab.com][6])
- Epic 作成に必要な Feature Flag history ([simlab.ww.uni-erlangen.de][4])

---

これで **ローカル GitLab** でもエピック＋ Planner を活かした権限設計が行えます。
バージョンが古い場合や Enterprise 機能を試したい場合は、
`gitlab-ee` をライセンスなしでインストール → 試用キーを発行する手もあります（30 日間）。

[1]: https://about.gitlab.com/releases/2024/12/19/gitlab-17-7-released/?utm_source=chatgpt.com "GitLab 17.7 released with new Planner user role"
[2]: https://docs.gitlab.com/user/permissions/?utm_source=chatgpt.com "Roles and permissions - GitLab Docs"
[3]: https://pm.stackexchange.com/questions/25038/how-to-implement-epics-on-gitlab-without-enterprise-edition?utm_source=chatgpt.com "How to implement Epics on Gitlab without Enterprise Edition?"
[4]: https://simlab.ww.uni-erlangen.de/help/user/group/epics/epic_work_items.md?utm_source=chatgpt.com "Epic work items · Epics · Group · User · Help - GitLab"
[5]: https://docs.gitlab.com/user/group/epics/manage_epics/?utm_source=chatgpt.com "Manage epics | GitLab Docs"
[6]: https://forum.gitlab.com/t/what-are-the-limitations-of-self-managed-gitlab-free-version/83917?utm_source=chatgpt.com "What are the limitations of self managed gitlab free version - General"

GitLab Community Edition (CE) version 18.0 is distributed under the **MIT License** (also known as MIT Expat) ([docs.gitlab.com][1]).

---

### ✅ まとめ

| 項目         | 内容                                               |
| ------------ | -------------------------------------------------- |
| エディション | GitLab Community Edition (CE) 18.0                 |
| ライセンス   | MIT License（MIT Expat）                           |
| 特徴         | 完全にオープンソース、商用利用・再配布・改変が可能 |

必要であれば、MIT ライセンスの全文や条項についてもご案内できますので、お気軽にお知らせください 😊

[1]: https://docs.gitlab.com/development/licensing/?utm_source=chatgpt.com "GitLab Licensing and Compatibility"

# 第 5 章：運用方法

GitLab は非常に高機能な開発プラットフォームですが、**長期的な運用においては「安全性」と「可用性」が鍵**となります。本章では、GitLab を組織で安心して運用するためのバックアップ、アクセス制御、認証統合、セキュリティ管理の方法を紹介します。

---

## 5.0 読者ガイド ─ あなたはどこを読む？

以下の表で、ご自身の "立場" と GitLab 上の "ロール" を照合し、**必読セクション** と **参考セクション** を確認してください。必要最小限の情報だけを拾えるため、オンボーディングやレビューの時短になります。

| ペルソナ (肩書き例)           | 想定 GitLab ロール | 本章で必読 (§)                                         | 補助的に参照 (§)              |
| ----------------------------- | ------------------ | ------------------------------------------------------ | ----------------------------- |
| **インフラ管理者／SRE**       | root               | 5.1 バックアップ / 5.3 認証統合 / 5.4 セキュリティ管理 | 5.2 アクセス制御              |
| **組織オーナー／部門長**      | Owner              | 5.2 アクセス制御 / 5.4 セキュリティ管理                | 5.1 バックアップ (概要)       |
| **リリース責任者／Tech Lead** | Maintainer         | 5.2 アクセス制御                                       | 5.1 バックアップ (概要) / 5.4 |
| **アプリ開発者**              | Developer          | 5.2 アクセス制御 (自分のロール理解)                    | 5.1 バックアップ (概要)       |
| **QA／監査担当**              | Reporter           | 5.2 アクセス制御 (閲覧系権限)                          | 5.4 セキュリティ管理          |
| **顧客／外部利用者**          | Guest              | 5.2 アクセス制御 (Guest 節)                            | ―                             |

> **使い方**
>
> 1. 左端のペルソナ列から自分に近い役割を探します。
> 2. "必読" 欄に挙がっている節をまず確認してください。
> 3. 余裕があれば "補助的に参照" 節を読み、全体像を掴むと良いでしょう。

---

## 5.1 バックアップ

### ▶ 定期バックアップの必要性

万が一の障害に備えて、GitLab では以下のデータを定期的にバックアップすることが推奨されます。

- リポジトリの内容
- Issue・Merge Request などのメタデータ
- CI/CD 設定
- コンテナ/パッケージレジストリ

### ▶ バックアップコマンド（例）

GitLab CE の場合：

```bash
sudo gitlab-backup create
```

デフォルトでは `/var/opt/gitlab/backups` に `.tar` ファイルが作成されます。

### ▶ 復元（リストア）方法

```bash
# 事前に GitLab を停止
sudo gitlab-ctl stop unicorn
sudo gitlab-ctl stop sidekiq

# 復元
sudo gitlab-backup restore BACKUP=1698201540_2023_10_25_13.2.4

# GitLab を再起動
sudo gitlab-ctl restart
```

> 💡 自動化には cron や systemd timer でのスケジューリングを推奨します。

---

## 5.2 アクセス制御（プロジェクトとロールの管理）

GitLab では、**個人やチームの役割に応じてアクセス権限を細かく設定**できます。

### ▶ 権限レベル

| 権限       | 説明                                       |
| ---------- | ------------------------------------------ |
| Guest      | 読み取り専用。Issue 閲覧は可能             |
| Reporter   | リポジトリをクローンして参照可能           |
| Developer  | ブランチ作成や Push が可能                 |
| Maintainer | 設定変更・マージ操作が可能                 |
| Owner      | グループの全権限を持つ（グループ単位のみ） |

### ▶ 利用例

- **外注開発者には Reporter に制限**
- **CI 設定を誤って壊さないよう、Maintainer 権限は限定メンバーのみ**

# 第 5 章：運用方法

GitLab は非常に高機能な開発プラットフォームですが、**長期的な運用においては「安全性」と「可用性」が鍵**となります。本章では、GitLab を組織で安心して運用するためのバックアップ、アクセス制御、認証統合、セキュリティ管理の方法を紹介します。

---

## 5.0 読者ガイド ─ あなたはどこを読む？

以下の表で、ご自身の "立場" と GitLab 上の "ロール" を照合し、**必読セクション** と **参考セクション** を確認してください。必要最小限の情報だけを拾えるため、オンボーディングやレビューの時短になります。

| 大分類ペルソナ                                     | 代表ロール                       | 本章で必読 (§)          | 補助的に参照 (§) |
| -------------------------------------------------- | -------------------------------- | ----------------------- | ---------------- |
| **システム管理者／オーナー層**<br>(root, Owner)    | root / Owner                     | 5.1, 5.3, 5.4           | 5.2              |
| **開発チーム**<br>(Maintainer, Developer, Planner) | Maintainer / Developer / Planner | 5.2                     | 5.1 (概要), 5.4  |
| **閲覧・外部ユーザー**<br>(Reporter, Guest)        | Reporter / Guest                 | 5.2 (Guest/Reporter 節) | —                |

> **使い方**
>
> 1. 左端のペルソナ列から自分に近い役割を探します。
> 2. "必読" 欄に挙がっている節をまず確認してください。
> 3. 余裕があれば "補助的に参照" 節を読み、全体像を掴むと良いでしょう。

\---------------------------------|--------------------|----------------------------------------------|----------------------------------|
\| **インフラ管理者／SRE** | root | 5.1 バックアップ / 5.3 認証統合 / 5.4 セキュリティ管理 | 5.2 アクセス制御 |
\| **組織オーナー／部門長** | Owner | 5.2 アクセス制御 / 5.4 セキュリティ管理 | 5.1 バックアップ (概要) |
\| **リリース責任者／Tech Lead** | Maintainer | 5.2 アクセス制御 | 5.1 バックアップ (概要) / 5.4 |
\| **アプリ開発者** | Developer | 5.2 アクセス制御 (自分のロール理解) | 5.1 バックアップ (概要) |
\| **QA／監査担当** | Reporter | 5.2 アクセス制御 (閲覧系権限) | 5.4 セキュリティ管理 |
\| **顧客／外部利用者** | Guest | 5.2 アクセス制御 (Guest 節) | ― |

> **使い方**
>
> 1. 左端のペルソナ列から自分に近い役割を探します。
> 2. "必読" 欄に挙がっている節をまず確認してください。
> 3. 余裕があれば "補助的に参照" 節を読み、全体像を掴むと良いでしょう。

---

## 5.1 バックアップ

### ▶ 定期バックアップの必要性

万が一の障害に備えて、GitLab では以下のデータを定期的にバックアップすることが推奨されます。

- リポジトリの内容
- Issue・Merge Request などのメタデータ
- CI/CD 設定
- コンテナ/パッケージレジストリ

### ▶ バックアップコマンド（例）

GitLab CE の場合：

```bash
sudo gitlab-backup create
```

デフォルトでは `/var/opt/gitlab/backups` に `.tar` ファイルが作成されます。

### ▶ 復元（リストア）方法

```bash
# 事前に GitLab を停止
sudo gitlab-ctl stop unicorn
sudo gitlab-ctl stop sidekiq

# 復元
sudo gitlab-backup restore BACKUP=1698201540_2023_10_25_13.2.4

# GitLab を再起動
sudo gitlab-ctl restart
```

> 💡 自動化には cron や systemd timer でのスケジューリングを推奨します。

---

## 5.2 アクセス制御（プロジェクトとロールの管理）

GitLab では、**個人やチームの役割に応じてアクセス権限を細かく設定**できます。

### ▶ 権限レベル

| 権限       | 説明                                       |
| ---------- | ------------------------------------------ |
| Guest      | 読み取り専用。Issue 閲覧は可能             |
| Reporter   | リポジトリをクローンして参照可能           |
| Developer  | ブランチ作成や Push が可能                 |
| Maintainer | 設定変更・マージ操作が可能                 |
| Owner      | グループの全権限を持つ（グループ単位のみ） |

### ▶ 利用例

- **外注開発者には Reporter に制限**
- **CI 設定を誤って壊さないよう、Maintainer 権限は限定メンバーのみ**
  GitLab EE に切り替えたあとに行う、**ユーザーのロール設定・グループ／プロジェクトへの招待方法と、プロジェクト単位での "Owner" 権限に相当するもの**について、以下に整理して解説します。

---

## ✅ ユーザーにロールを設定する方法

GitLab では、**ユーザーのロール（アクセスレベル）** をグループまたはプロジェクトに対して付与します。

### 🎯 1. グループにユーザーを招待する

1. **\[GitLab にログイン]** → 左サイドバーの「Groups」から対象のグループを選択
2. 「**Group information > Members**」に移動
3. 「**Invite member**（メンバーを招待）」ボタンをクリック
4. メールアドレス or ユーザー名を入力
5. \*\*Access level（ロール）\*\*を選択（例：Developer、Maintainer、Owner）
6. 「Invite」または「Add to group」ボタンで追加完了

### 🎯 2. プロジェクトにユーザーを招待する

1. 対象のプロジェクトページに移動
2. 左サイドバーの「**Project information > Members**」を開く
3. 「**Invite member**」からユーザーを追加し、ロールを選ぶ
4. 同様に「Invite」または「Add to project」

---

## 👑 ロール（アクセスレベル）の一覧と権限

| ロール         | 権限概要                                                                        |
| -------------- | ------------------------------------------------------------------------------- |
| **Guest**      | 読み取り専用。Issue 閲覧やコメントなど軽微な操作が可能。                        |
| **Reporter**   | 読み取り + レポート系操作（パイプライン閲覧・Issue 作成など）                   |
| **Developer**  | 書き込み・Push、マージリクエスト、CI/CD 編集など。                              |
| **Maintainer** | プロジェクトのほぼ全操作。設定変更、メンバー追加（ただし Owner 追加不可）など。 |
| **Owner**      | **グループにのみ存在**。グループ全体の管理・設定・削除が可能。                  |

---

## ❓ Owner ロールはプロジェクト単位に存在するか？

👉 **存在しません。**

- **Owner はグループ単位にしか存在しません。**
- プロジェクト単位で最も強いロールは **Maintainer** です。

---

### 🔍 結論（あなたの質問への回答）：

> **「OWNER はグループ単位だけど、プロジェクト単位の OWNER に当たるのは何？」**

→ **Maintainer が最上位ロールに相当します。**
ただし、**プロジェクトを削除したり移譲する権限は Maintainer にありますが、グループの削除や課金管理などはできません**。

---

## ✳️ よくある補足

- CE/EE 問わず、ロール構成は共通です。
- **グループにユーザーを Owner として招待すれば、そのユーザーはグループ配下のすべてのプロジェクトに Maintainer 相当でアクセスできます。**
- **プロジェクト単体に招待された場合は Maintainer までが選べるロールです。**

---

必要であれば、「ロール別操作可能な内容一覧表」もご案内できます！
承知しました。以下に、**GitLab CE → EE への移行**と**最新バージョンへのアップデート**の両方を反映した、\*\*完成形の `docker-compose.yml`（最小構成・永続ボリュームあり）\*\*を提示します。

---

## ✅ GitLab EE 用 `docker-compose.yml`（移行＋アップデート対応）

```yaml
version: "3.9"

services:
  gitlab:
    image: gitlab/gitlab-ee:17.1.0-ee.0 # ← EE の最新安定版に変更（任意で latest でもOK）
    container_name: gitlab
    hostname: gitlab.example.com # 例: EC2のパブリックIPでもOK
    restart: always
    shm_size: 256m
    ports:
      - "80:80"
      - "443:443"
      - "22:22"
    volumes:
      - /srv/gitlab/config:/etc/gitlab
      - /srv/gitlab/logs:/var/log/gitlab
      - /srv/gitlab/data:/var/opt/gitlab
    environment:
      GITLAB_ROOT_PASSWORD: "ChangeMeStrong!" # 初回ログイン用 root パスワード
```

---

## ✅ 利用手順（移行＋アップデート）

```bash
# 1. 旧CEコンテナを停止・削除（データは残す）
docker compose down

# 2. イメージを EE に変更（上記 yml 編集済み）

# 3. 新しい EE イメージを取得
docker compose pull

# 4. コンテナを起動（EE + 最新バージョン）
docker compose up -d

# 5. バージョンとEdition確認
docker exec -it gitlab gitlab-rake gitlab:env:info
```

出力に `Version: 17.1.0-ee` のように表示されていれば成功です。

---

## ✅ 任意：ライセンス登録する場合

Web UI の管理画面から：

1. `http://<IP or ドメイン>/admin/license` にアクセス
2. `.gitlab-license` をアップロード

---

## 💬 必要であれば…

- **HTTP(S)用の自己署名 or Let's Encrypt 証明書設定**
- **GitLab 用の外部 DB 連携**
- **GITLAB_OMNIBUS_CONFIG 環境変数での追加設定**
- **複数コンテナ構成 (nginx 分離など)**

なども組み込んだ `docker-compose.yml` の拡張例もご案内できます。

必要に応じてお知らせください！

### GitLab ロール別 ★ 星取表（主要プロジェクト権限の抜粋）

| 権限 / ロール                                        | Guest | Planner | Reporter | Developer | Maintainer | Owner |
| ---------------------------------------------------- | :---: | :-----: | :------: | :-------: | :--------: | :---: |
| **ソースコード閲覧 / Clone**                         |   ★   |    ★    |    ★     |     ★     |     ★      |   ★   |
| **非保護ブランチ Push**                              |  －   |   －    |    －    |     ★     |     ★      |   ★   |
| **保護ブランチ管理**<br>(Push / 削除 / 保護設定変更) |  －   |   －    |    －    |    －     |     ★      |   ★   |
| **Issue 作成**                                       |   ★   |    ★    |    ★     |     ★     |     ★      |   ★   |
| **Merge Request 作成**                               |  －   |   －    |    ★     |     ★     |     ★      |   ★   |
| **Release 管理**                                     |  －   |   －    |    －    |     ★     |     ★      |   ★   |
| **CI/CD パイプライン実行**                           |  －   |   －    |    －    |     ★     |     ★      |   ★   |
| **プロジェクト設定変更**                             |  －   |   －    |    －    |    －     |     ★      |   ★   |
| **メンバー管理**                                     |  －   |   －    |    －    |    －     |     ★      |   ★   |
| **プロジェクト削除**                                 |  －   |   －    |    －    |    －     |     －     |   ★   |

**凡例**

- **★** = 権限あり
- **－** = 権限なし（あるいは上位ロールに限定）

> **Owner** は常にすべての操作が可能です。Planner ロール（GitLab 17.7 で追加）は主にプロジェクト計画機能に限った権限を持ち、コード操作や設定変更は行えません。

---

#### 参考にした公式ドキュメントの主な該当箇所

- **コード閲覧 / Push / protected branch 管理** – リポジトリ権限表
- **Issue / MR** – プロジェクト計画・MR 権限表
- **Release / 設定変更 / プロジェクト削除** – プロジェクト機能権限表
- **CI/CD 実行** – CI/CD 権限表
- **メンバー管理** – ユーザー管理権限表

([docs.gitlab.com][1], [docs.gitlab.com][1], [docs.gitlab.com][1], [docs.gitlab.com][1])

[1]: https://docs.gitlab.com/user/permissions/ "Roles and permissions | GitLab Docs"

はい、**「メンバー管理」には “ユーザーを追加・削除し、ロール（アクセスレベル）を変更する” 作業も含まれます**。

| スコープ         | ロール                                 | できること                                                                        | 制限・補足                                                                                                                                 |
| ---------------- | -------------------------------------- | --------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------ |
| **プロジェクト** | **Maintainer**                         | _メンバーを招待／削除_<br>_既存メンバーのロールを Guest〜Maintainer の範囲で変更_ | - **Owner ロールの付与・削除は不可**<br>- Owner からの降格や Owner への昇格、Owner へのアクセス要求の承認はできない ([docs.gitlab.com][1]) |
|                  | **Owner**                              | 上記に加え、**Owner ロールそのものを含むすべてのロール操作が可能**                | プロジェクトの最上位権限                                                                                                                   |
|                  | Guest / Planner / Reporter / Developer | メンバー管理権限なし                                                              |                                                                                                                                            |

| スコープ                                   | ロール          | できること                                             | 制限・補足                                                             |
| ------------------------------------------ | --------------- | ------------------------------------------------------ | ---------------------------------------------------------------------- |
| **グループ（トップレベル／サブグループ）** | **Owner**       | _メンバーの招待・削除_<br>_ロール変更（Owner を含む）_ | **メンバーのロールを変更できるのは Owner のみ** ([docs.gitlab.com][2]) |
|                                            | Maintainer 以下 | **メンバー管理は不可**                                 | （サブグループ作成など一部管理は可能だが、メンバー権限は変更不可）     |

### まとめ

- **プロジェクトレベル**では Maintainer までが “チームメンバー管理” を実行できます。ただし Owner ロールの扱いだけは Owner 自身（またはインスタンス管理者）に限られます。
- **グループレベル**では **Owner だけ** がメンバーを直接操作でき、Maintainer には権限がありません。
- 個別の GitLab インスタンスやグループ設定で「メンバーは新しいユーザーやグループを招待できない」などの制限をかけている場合、上表よりさらに権限が絞られることがあります（Settings ▸ Permissions & group features で設定可能）。

このように “メンバー管理” の実体は **「招待・削除・ロール変更」** であり、どのロールまで操作できるかは Maintainer と Owner で明確に線引きされています。

[1]: https://docs.gitlab.com/user/permissions/ "Roles and permissions | GitLab Docs"
[2]: https://docs.gitlab.com/user/group/subgroups/ "Subgroups | GitLab Docs"

### GitLab ロール別 ★ 星取表（**Private プロジェクト** を想定）

| 権限 / ロール                                            | Guest | Planner | Reporter | Developer | Maintainer | Owner |
| -------------------------------------------------------- | :---: | :-----: | :------: | :-------: | :--------: | :---: |
| **ソースコード clone**                                   |  －   |   －    |    ★     |     ★     |     ★      |   ★   |
| **非保護ブランチ Push**                                  |  －   |   －    |    －    |     ★     |     ★      |   ★   |
| **保護ブランチの管理**<br>(保護設定変更・直接 Push/削除) |  －   |   －    |    －    |    －     |     ★      |   ★   |
| **Issue 作成**                                           |   ★   |    ★    |    ★     |     ★     |     ★      |   ★   |
| **Merge Request 作成**                                   |  －   |   －    |    －    |     ★     |     ★      |   ★   |
| **Release 作成 / 更新 / 削除**                           |  －   |   －    |    －    |     ★     |     ★      |   ★   |
| **CI/CD パイプライン実行**                               |  －   |   －    |    －    |     ★     |     ★      |   ★   |
| **プロジェクト設定変更**                                 |  －   |   －    |    －    |    －     |     ★      |   ★   |
| **メンバー招待・ロール変更**                             |  －   |   －    |    －    |    －     |    ★\*     |   ★   |
| **プロジェクト削除**                                     |  －   |   －    |    －    |    －     |     －     |   ★   |

**凡例**

- ★ = 権限あり
- － = 権限なし
- ★\* = Maintainer も「Owner ロールの付与・削除」だけは不可

#### 主な根拠

- **clone** – _Reporter 以上が可能_ ([docs.gitlab.com][1])
- **Push（非保護）** – _Developer は default ブランチが「Partially/Not protected」なら push 可_ ([docs.gitlab.com][2])
- **保護ブランチ管理** – _保護ブランチの作成・設定変更は Maintainer 以上_ ([docs.gitlab.com][3])
- **Issue 作成 (Guest 以上)** – _Issue board から作成できる最小ロールは Guest_ ([docs.gitlab.com][4])
- **Merge Request 作成** – _MR 作成には Developer 以上が必要_ ([docs.gitlab.com][5])
- **Release 操作** – _API では “Developer level access is required to create a release”_ ([docs.gitlab.com][6])
- **CI/CD 実行** – _「Run CI/CD pipeline」権限は Developer 以上_ ([docs.gitlab.com][7])
- **プロジェクト設定変更** – _「Edit project settings」= Maintainer 以上_ ([docs.gitlab.com][2])
- **メンバー管理** – _Maintainer は Guest〜Maintainer のロール操作可 / Owner 操作は Owner のみ_ ([docs.gitlab.com][1])
- **プロジェクト削除** – _削除には Owner ロール必須_ ([docs.gitlab.com][8])

#### 注意点・補足

1. **Public / Internal** プロジェクトでは Guest や非メンバーでも clone 可能です。上表は _Private_ を前提にしています。
2. ブランチ保護設定を緩めれば Developer でも default ブランチへ push 可ですが、保護を解除できるのは Maintainer 以上です。
3. **Planner** は計画系（Issue／Task／OKR など）の操作権限が追加されたロールで、コード操作は Guest と同等です。
4. **Custom Roles** を用いれば「Guest でも clone だけ許可」のような細かい権限付与が可能です。

これで「Guest でも clone 可能」と誤っていた箇所を修正した最新版の星取表になりました。

[1]: https://docs.gitlab.com/user/project/members/ "Members of a project | GitLab Docs"
[2]: https://docs.gitlab.com/user/permissions/?utm_source=chatgpt.com "Roles and permissions - GitLab Docs"
[3]: https://docs.gitlab.com/user/project/repository/branches/protected/?utm_source=chatgpt.com "Protected branches - GitLab Docs"
[4]: https://docs.gitlab.com/user/project/issues/create_issues/?utm_source=chatgpt.com "Create an issue - GitLab Docs"
[5]: https://docs.gitlab.com/user/project/merge_requests/creating_merge_requests/ "Creating merge requests | GitLab Docs"
[6]: https://docs.gitlab.com/api/releases/?utm_source=chatgpt.com "Project release API - GitLab Docs"
[7]: https://docs.gitlab.com/user/permissions/ "Roles and permissions | GitLab Docs"
[8]: https://docs.gitlab.com/user/project/working_with_projects/?utm_source=chatgpt.com "Manage projects - GitLab Docs"

### GitLab 権限・操作早見表（**Private プロジェクト** 基準）

| 操作 / 権限                  | Guest | Planner | Reporter | Developer | Maintainer | Owner |
| ---------------------------- | :---: | :-----: | :------: | :-------: | :--------: | :---: |
| **リポジトリ閲覧 / Clone**   |  －   |   －    |    ★     |     ★     |     ★      |   ★   |
| **非保護ブランチへ Push**    |  －   |   －    |    －    |    ★¹     |     ★      |   ★   |
| **保護ブランチ設定・解除**   |  －   |   －    |    －    |    －     |     ★²     |   ★   |
| **Issue / Task 作成**        |   ★   |    ★    |    ★     |     ★     |     ★      |   ★   |
| **Merge Request 作成**       |  －   |   －    |    －    |    ★³     |     ★      |   ★   |
| **Release 作成・更新**       |  －   |   －    |    －    |    ★⁴     |     ★      |   ★   |
| **CI/CD パイプライン実行**   |  －   |   －    |    －    |    ★⁵     |     ★      |   ★   |
| **プロジェクト設定変更**     |  －   |   －    |    －    |    －     |     ★⁶     |   ★   |
| **メンバー招待・ロール変更** |  －   |   －    |    －    |    －     |    ★\*     |   ★   |
| **プロジェクト削除**         |  －   |   －    |    －    |    －     |     －     |  ★⁷   |

**凡例**
★ = 操作可能  | － = 不可  | ★\* = Maintainer は Owner の付与・取り消しのみ不可

---

#### 1 行ずつの根拠

| №                                                                                                             | 主な根拠ドキュメント |
| ------------------------------------------------------------------------------------------------------------- | -------------------- |
| 1. Developer は default ブランチ保護が _Partially_／_Not protected_ の場合のみ Push 可 ([docs.gitlab.com][1]) |                      |
| 2. 保護ブランチの作成・設定変更には Maintainer 以上が必要 ([docs.gitlab.com][2], [docs.gitlab.com][2])        |                      |
| 3. Merge Request を作成するには Developer 以上が必要 ([docs.gitlab.com][3])                                   |                      |
| 4. Release 操作には Developer 以上が必要 ([docs.gitlab.com][4], [docs.gitlab.com][5])                         |                      |
| 5. MR パイプライン・スケジュール実行など CI/CD は Developer 以上 ([docs.gitlab.com][6], [docs.gitlab.com][7]) |                      |
| 6. 「Edit project settings」は Maintainer 以上 ([docs.gitlab.com][1])                                         |                      |
| 7. プロジェクト削除は Owner 必須 ([docs.gitlab.com][8])                                                       |                      |

> **Planner ロール**（GitLab 17.7 で追加）
> Issue・OKR など計画系ワークアイテムを Guest より広く操作できますが、コード／CI／設定系の権限は Guest と同等です。([docs.gitlab.com][1])

---

### メンバー管理権限

| スコープ         | 操作できるロール   | 実行者に必要なロール | 備考                                   |
| ---------------- | ------------------ | -------------------- | -------------------------------------- |
| **プロジェクト** | Guest〜Maintainer  | **Maintainer**       | Maintainer は Owner の昇格・降格は不可 |
|                  | Owner を含むすべて | **Owner**            | 最上位権限                             |
| **グループ**     | すべて             | **Owner**            | Maintainer ではメンバー管理不可        |

([docs.gitlab.com][9], [docs.gitlab.com][9])

---

### 保護ブランチとは？

- **目的**: 誤 push／force-push／削除から重要ブランチを守るガードレール
- **主な設定項目**

  - _Allowed to push / merge / force-push_（ロール・個別ユーザー・グループを指定）
  - _Code Owner 承認必須_
  - _ブランチ削除禁止_

- **既定**: プロジェクトの default ブランチは自動で保護状態。Maintainer 以上のみが push / merge 可。
- **設定場所**: **Settings ▸ Repository ▸ Protected branches**

([docs.gitlab.com][2], [docs.gitlab.com][2])

---

### Clone 可否と可視性の関係

| プロジェクト可視性 | Guest の Clone 権限      |
| ------------------ | ------------------------ |
| **Private**        | × 不可                   |
| **Internal**       | ○ 認証ユーザーとして可能 |
| **Public**         | ○ 匿名でも可能           |

([docs.gitlab.com][10])
※Private プロジェクトで Guest にコード閲覧だけ許可したい場合は **Custom Role** で _View repository code_ 権限を付与する方法があります。([docs.gitlab.com][11])

---

#### まとめ

- **Guest** は Private プロジェクトのコードには触れられません。Reporter から閲覧・clone が可能。
- **Developer** は「開発作業」一式（push／MR／CI／Release）を担当。Default branch を守りたい場合は保護ブランチと組み合わせてガバナンスを取ります。
- **Maintainer** は設定・メンバー管理・保護ブランチ制御など「運用」レベルを扱う役割。
- **Owner** はプロジェクトライフサイクル全体（削除・完全なロール操作）を司る最上位。
- **Planner** はコード操作を伴わない“計画専用”権限。

この一覧をベースに、自組織のワークフローやセキュリティ要件に応じて **保護ブランチ** と **カスタムロール** を組み合わせると、最小権限の原則を保ちながら柔軟な運用が可能になります。

[1]: https://docs.gitlab.com/user/permissions/?utm_source=chatgpt.com "Roles and permissions - GitLab Docs"
[2]: https://docs.gitlab.com/user/project/repository/branches/protected/?utm_source=chatgpt.com "Protected branches - GitLab Docs"
[3]: https://docs.gitlab.com/user/project/merge_requests/creating_merge_requests/?utm_source=chatgpt.com "Creating merge requests - GitLab Docs"
[4]: https://docs.gitlab.com/user/project/releases/?utm_source=chatgpt.com "Releases - GitLab Docs"
[5]: https://docs.gitlab.com/api/releases/?utm_source=chatgpt.com "Project release API - GitLab Docs"
[6]: https://docs.gitlab.com/ci/pipelines/merge_request_pipelines/?utm_source=chatgpt.com "Merge request pipelines - GitLab Docs"
[7]: https://docs.gitlab.com/ci/pipelines/schedules/?utm_source=chatgpt.com "Scheduled pipelines - GitLab Docs"
[8]: https://docs.gitlab.com/user/project/working_with_projects/?utm_source=chatgpt.com "Manage projects - GitLab Docs"
[9]: https://docs.gitlab.com/user/project/members/?utm_source=chatgpt.com "Members of a project - GitLab Docs"
[10]: https://docs.gitlab.com/user/public_access/?utm_source=chatgpt.com "Project and group visibility - GitLab Docs"
[11]: https://docs.gitlab.com/administration/guest_users/?utm_source=chatgpt.com "Guest users - GitLab Docs"
