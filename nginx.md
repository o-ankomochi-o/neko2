ä»¥ä¸‹ã®æ‰‹é †ã§ **(1) nginx ã‚³ãƒ³ãƒ†ãƒŠã‚’ç«‹ã¦ã‚‹ â†’ (2) GitLab ã‹ã‚‰è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ CI/CD** ã‚’ä»•ä¸Šã’ã¾ã™ã€‚
_GitLabï¼ˆ:8181/8443ï¼‰ãƒ»GitLab Runner ã¯æ—¢ã« Docker ä¸Šã§ç¨¼åƒã—ã¦ã„ã‚‹å‰æã§ã™ã€‚_

---

## 0. ã–ã£ãã‚Šå…¨ä½“åƒ

```text
EC2
â”œâ”€ GitLab            :8181 / 8443   ï¼ˆæ—¢ã«èµ·å‹•æ¸ˆã¿ï¼‰
â”œâ”€ GitLab Runner     docker executorï¼ˆæ—¢ã«ç™»éŒ²æ¸ˆã¿ï¼‰
â””â”€ nginx-app         :80            â† ã“ã‚Œã‚’è¿½åŠ 
        â–²
        â””â”€ /srv/site  â€¦ HTML ã‚’ç½®ãã ã‘
              â–²
              â””â”€ GitLab repo ã® site/ ã‚’ CI ãŒ rsync
```

---

## 1. ãƒ›ã‚¹ãƒˆå´ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª & ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸

```bash
sudo mkdir -p /srv/site
sudo chown $(whoami):$(whoami) /srv/site

echo "Hello GitLab CI/CD! â€“ $(date)" > /srv/site/index.html
```

---

## 2. nginx-app ã‚µãƒ¼ãƒ“ã‚¹ã‚’ docker-compose ã«è¿½è¨˜

### 2-1 æ—¢å­˜ `docker-compose.yml` ã¸è¿½åŠ ï¼ˆä¾‹ï¼‰

```yaml
services:
  gitlab: # ã™ã§ã«ã‚ã‚‹ GitLab å®šç¾© â€¦
  gitlab-runner: # ã™ã§ã«ã‚ã‚‹ Runner å®šç¾© â€¦

  nginx-app: # â˜… è¿½åŠ 
    image: nginx:alpine
    container_name: nginx-app
    volumes:
      - /srv/site:/usr/share/nginx/html:ro
    ports:
      - "80:80" # 80 ç•ªã‚’å…¬é–‹
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost || exit 1"]
      interval: 30s
      timeout: 3s
      retries: 3
```

```bash
docker compose up -d nginx-app
curl http://localhost          #=> â€œHello GitLab CI/CD!â€
```

---

## 3. GitLab Runner ã‹ã‚‰ãƒ›ã‚¹ãƒˆã® `/srv/site` ã¨ Docker ã«è§¦ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹

`/srv/gitlab-runner/config/config.toml` ã‚’ç·¨é›†ã—ã¦ **volumes ã« `/srv/site:/srv/site`** ã‚’è¿½åŠ ã€‚
ï¼ˆ`/var/run/docker.sock` ã¯ç™»éŒ²æ™‚ã«ä»˜ã‘ã¦ã„ã‚Œã° OKï¼‰

```toml
[[runners]]
  executor = "docker"
  [runners.docker]
    privileged = true
    volumes = ["/var/run/docker.sock:/var/run/docker.sock", "/srv/site:/srv/site"]
    # ä»–ã®è¨­å®šã¯ãã®ã¾ã¾
```

> è¨­å®šå¤‰æ›´å¾Œï¼š`docker restart gitlab-runner`

---

## 4. GitLab ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦ã‚³ãƒ¼ãƒ‰ã‚’ push

```bash
git clone <your_repo>.git
cd your_repo
mkdir site
echo "Hello GitLab CI/CD from Git!" > site/index.html
git add site/index.html
git commit -m "init: add static site"
git push
```

---

## 5. `.gitlab-ci.yml` ã‚’ç½®ã

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç›´ä¸‹ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¦ commit â†’ pushã€‚
**ã‚¿ã‚° `docker` ã¯ runner ç™»éŒ²æ™‚ã«è¨­å®šã—ãŸã‚‚ã®ã¨åˆã‚ã›ã¦ãã ã•ã„ã€‚**

```yaml
stages: [test, deploy]

.default_rules: &default_rules
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: always
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'
      when: always
    - when: never

test:
  stage: test
  image: alpine
  <<: *default_rules
  script:
    - test -f site/index.html

deploy:
  stage: deploy
  tags: [docker]
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'
      when: always
  script:
    - rsync -av --delete site/ /srv/site/
    - docker compose exec nginx-app nginx -s reload
  environment:
    name: production
    url: http://$CI_SERVER_HOST
```

---

## 6. å‹•ä½œç¢ºèªãƒ•ãƒ­ãƒ¼

| æ‰‹é †                                         | æœŸå¾…å‹•ä½œ                                      |
| -------------------------------------------- | --------------------------------------------- |
| â‘  MR ã‚’ä½œæˆ                                  | `test` ã‚¸ãƒ§ãƒ–ãŒèµ°ã‚Šã€index.html æœ‰ç„¡ãƒã‚§ãƒƒã‚¯  |
| â‘¡ main ã«ãƒãƒ¼ã‚¸ / ç›´æ¥ push                  | `deploy` ã‚¸ãƒ§ãƒ–ãŒå®Ÿè¡Œ â†’ `/srv/site/` ã¸ rsync |
| â‘¢ ã‚¸ãƒ§ãƒ–å®Œäº†å¾Œãƒ–ãƒ©ã‚¦ã‚¶ã‚’æ›´æ–°                 | å¤‰æ›´ãŒåæ˜ ã•ã‚Œã¦ã„ã‚Œã°æˆåŠŸ                    |
| â‘£ `docker logs nginx-app` ã§ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ç¢ºèª | ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã‚¢ã‚¯ã‚»ã‚¹ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª  |

---

## 7. HTTPS ã‚’ä»˜ã‘ãŸã„å ´åˆï¼ˆä»»æ„ï¼‰

1. `nginxproxy/nginx-proxy` ï¼‹ `acme-companion` ã‚’ compose ã«è¿½åŠ ã€‚
2. `nginx-app` ã«ã¯ `VIRTUAL_HOST=example.com` ç’°å¢ƒå¤‰æ•°ã‚’ä»˜ä¸ã€‚
3. GitLab ã¯å¼•ãç¶šã 8181/8443ã€å…¬é–‹ nginx ã¯ 80/443 ã§åˆ†é›¢ã€‚

---

## 8. ã‚ˆãã‚ã‚‹ãƒãƒã‚Šãƒã‚¤ãƒ³ãƒˆ

| ç—‡çŠ¶ / ã‚¨ãƒ©ãƒ¼                        | åŸå›                                 | è§£æ±ºç­–                                                    |
| ------------------------------------ | ----------------------------------- | --------------------------------------------------------- |
| `deploy` ã‚¸ãƒ§ãƒ–ã§ `/srv/site` ãŒç„¡ã„ | Runner ã‚³ãƒ³ãƒ†ãƒŠã« volume æœªãƒã‚¦ãƒ³ãƒˆ | `config.toml` ã® `volumes` ã« `/srv/site:/srv/site` è¿½åŠ   |
| `docker compose exec` ãŒå¤±æ•—         | Runner â†’ docker.sock ãŒç„¡æ¨©é™       | `privileged = true` & `/var/run/docker.sock` ã‚’ãƒã‚¦ãƒ³ãƒˆ   |
| ãƒ–ãƒ©ã‚¦ã‚¶ãŒå¤ã„å†…å®¹ã‚’è¡¨ç¤º             | ã‚­ãƒ£ãƒƒã‚·ãƒ¥                          | `Ctrl+F5` or nginx ã§ `add_header Cache-Control no-store` |
| 443 ã§ GitLab/å…¬é–‹ nginx ãŒè¡çª      | ä¸¡æ–¹ãŒåŒãƒãƒ¼ãƒˆä½¿ç”¨                  | GitLab ã¯ 8443ã€å…¬é–‹ nginx ã¯ 443 ã§ãƒãƒ¼ãƒˆåˆ†é›¢            |

---

### ã“ã‚Œã§å®Œæˆ ğŸ‰

- **EC2 ä¸Šã® 3 ã‚³ãƒ³ãƒ†ãƒŠï¼ˆGitLab / Runner / nginx-appï¼‰ã ã‘** ã§é™çš„ã‚µã‚¤ãƒˆã® CI/CD ãŒå›ã‚Šã¾ã™ã€‚
- SPA ã‚„ API ã‚µãƒ¼ãƒãƒ¼ã«å·®ã—æ›¿ãˆã‚‹å ´åˆã¯

  1. `build` ã‚¹ãƒ†ãƒƒãƒ—ã§æˆæœç‰©ã‚’ `site/` ã¸ã‚³ãƒ”ãƒ¼ã—ã€
  2. `deploy` ã§åŒã˜ rsync â†’ reload ã‚’è¡Œãˆã° OKã€‚

ã¾ãšã¯ `index.html` ã‚’ã¡ã‚‡ã£ã¨æ›¸ãæ›ãˆã¦ push â†’ è‡ªå‹•åæ˜ ã‚’ç¢ºèªã—ã¦ã¿ã¦ãã ã•ã„ï¼

**ä»¥ä¸‹ã§ã¯ **ã‚·ã‚§ãƒ«ã§æ‰“ã¤ã‚³ãƒãƒ³ãƒ‰** ã¨ **YAML ã®å„è¡Œ\*_ ã‚’ 1 è¡Œãšã¤å–ã‚Šä¸Šã’ã€ã€Œä½•ãŒèµ·ã“ã‚‹ã‹ã€ã€Œãªãœå¿…è¦ã‹ã€ã‚’ä¸å¯§ã«è§£èª¬ã—ã¾ã™ã€‚
_â€•â€•è¦‹ãªãŒã‚‰æ‰‹ã‚’å‹•ã‹ã›ã°ã€ä»•çµ„ã¿ãŒã‚¹ãƒƒã¨é ­ã«å…¥ã‚‹ã¯ãšã§ã™ã€‚\*

---

## 1. ãƒ›ã‚¹ãƒˆå´ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª & ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸

| ã‚³ãƒãƒ³ãƒ‰                                                      | ä½•ã‚’ã™ã‚‹ï¼Ÿ                                                                                                | ãªãœå¿…è¦ï¼Ÿ                                                                                          |
| ------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------- |
| `sudo mkdir -p /srv/site`                                     | `/srv/site` ã¨ã„ã†ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ **root æ¨©é™**ã§ä½œæˆã€‚`-p` ã§é€”ä¸­ã®è¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒç„¡ãã¦ã‚‚ã¾ã¨ã‚ã¦ä½œã‚‹ã€‚ | nginx ã‚³ãƒ³ãƒ†ãƒŠãŒ â€œã“ã“ã‚’ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ«ãƒ¼ãƒˆã«ã™ã‚‹â€ ãŸã‚ã® **å®Ÿä½“** ã‚’ç”¨æ„ã€‚                          |
| `sudo chown $(whoami):$(whoami) /srv/site`                    | ã§ããŸ `/srv/site` ã‚’ã€Œä»Šãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ (whoami)ã€ã«æ‰€æœ‰æ¨©å¤‰æ›´ã€‚                                  | `rsync` ã§æ›¸ãè¾¼ã¿ã‚’è¡Œã†ã®ã¯ Runner â†’ ãƒ›ã‚¹ãƒˆã® `/srv/site`ã€‚root ã®ã¾ã¾ã ã¨æ›¸ãè¾¼ã¿æ¨©é™ã§ã‚³ã‚±ãŒã¡ã€‚ |
| `echo "Hello GitLab CI/CD! â€“ $(date)" > /srv/site/index.html` | ãƒ†ã‚¹ãƒˆç”¨ã® `index.html` ã‚’ä¸€ç™ºç”Ÿæˆã€‚`$(date)` ã§ç¾åœ¨æ™‚åˆ»ã‚‚åŸ‹ã‚è¾¼ã¿ã€‚                                      | nginx ãŒæ­£ã—ãç«‹ã¡ä¸ŠãŒã£ãŸã‹ `curl` ã§ç¢ºèªã™ã‚‹è¶³ãŒã‹ã‚Šã€‚                                            |

---

## 2. docker-compose.yml ã®è¿½åŠ è¡Œã‚’åˆ†è§£

```yaml
nginx-app:
  image: nginx:alpine # â‘ 
  container_name: nginx-app # â‘¡
  volumes: # â‘¢
    - /srv/site:/usr/share/nginx/html:ro
  ports:
    - "80:80" # â‘£
  restart: always # â‘¤
  healthcheck: # â‘¥
    test: ["CMD-SHELL", "wget -qO- http://localhost || exit 1"]
    interval: 30s
    timeout: 3s
    retries: 3
```

| ç•ªå· | è¡Œ                                              | æ„å‘³                                                                                                     |
| ---- | ----------------------------------------------- | -------------------------------------------------------------------------------------------------------- |
| â‘     | `image: nginx:alpine`                           | å…¬å¼ nginx ã® **æœ€å°ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼ˆAlpine Linux ãƒ™ãƒ¼ã‚¹ï¼‰** ã‚’ä½¿ã†ã€‚ã‚µã‚¤ã‚º â‰ˆ5 MB ã¨æ¿€è»½ã€‚                      |
| â‘¡    | `container_name: nginx-app`                     | ã‚³ãƒ³ãƒ†ãƒŠã«å›ºå®šåã‚’ä»˜ã‘ã‚‹ã€‚`docker compose exec nginx-app` ã§å‚ç…§ã—ã‚„ã™ãã™ã‚‹ãŸã‚ã€‚                       |
| â‘¢    | `volumes:` `/srv/site:/usr/share/nginx/html:ro` | ãƒ›ã‚¹ãƒˆ `/srv/site` ã‚’ **ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ«ãƒ¼ãƒˆ**ã«ãƒã‚¤ãƒ³ãƒ‰ã€‚`:ro` ã§èª­ã¿å–ã‚Šå°‚ç”¨ï¼èª¤ä¸Šæ›¸ãã‚’é˜²æ­¢ã€‚ |
| â‘£    | `ports: "80:80"`                                | ãƒ›ã‚¹ãƒˆã® **80 ç•ªãƒãƒ¼ãƒˆ** ã‚’ã‚³ãƒ³ãƒ†ãƒŠã® 80 ç•ªã«å…¬é–‹ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ãŒ `http://<EC2_IP>/` ã§è¦‹ã‚‰ã‚Œã‚‹ã€‚            |
| â‘¤    | `restart: always`                               | EC2 å†èµ·å‹•ã‚„ nginx ãŒã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ã¦ã‚‚ **è‡ªå‹•å†èµ·å‹•**ã€‚é‹ç”¨ã§ã‚ã‚ŠãŒã¡ãªã€Œãªãœã‹è½ã¡ã¦ãŸã€ã‚’å›é¿ã€‚         |
| â‘¥    | `healthcheck:`                                  | 30 ç§’ã”ã¨ã« `wget` ã§è‡ªå·±ãƒã‚§ãƒƒã‚¯ã€‚å¿œç­”ãŒç„¡ã„ã¨ **Docker ãŒçŠ¶æ…‹ã‚’ unhealthy ã«** â†’ ç›£è¦–ã§æ¤œçŸ¥ã—ã‚„ã™ã„ã€‚  |

### èµ·å‹•ã‚³ãƒãƒ³ãƒ‰

| ã‚³ãƒãƒ³ãƒ‰                         | ä½•ã‚’ã™ã‚‹ï¼Ÿ                                                                             |
| -------------------------------- | -------------------------------------------------------------------------------------- |
| `docker compose up -d nginx-app` | `-d` ã§ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰èµ·å‹•ã€‚`docker ps` ã§ `Up` çŠ¶æ…‹ç¢ºèªå¯ã€‚                          |
| `curl http://localhost`          | **EC2 å†…ã‹ã‚‰** HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã€‚`Hello GitLab CI/CD!` ãŒè¿”ã‚Œã° nginx + volume ãŒæ­£å¸¸ã€‚ |

---

## 3. Runner ã® `config.toml` è¿½è¨˜

```toml
volumes = [
 "/var/run/docker.sock:/var/run/docker.sock",
 "/srv/site:/srv/site"
]
```

| è¡Œ                                          | æ„å‘³                                                                                                                                      |
| ------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------- |
| `/var/run/docker.sock:/var/run/docker.sock` | Runner ã‚³ãƒ³ãƒ†ãƒŠå†…ã‹ã‚‰ **ãƒ›ã‚¹ãƒˆã® Docker ãƒ‡ãƒ¼ãƒ¢ãƒ³** ã‚’å©ã‘ã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚ã€Œã‚³ãƒ³ãƒ†ãƒŠ in ã‚³ãƒ³ãƒ†ãƒŠã€ã®å®šç•ªè¨­å®šã€‚`privileged = true` ã‚‚å¿˜ã‚Œãšã€‚ |
| `/srv/site:/srv/site`                       | Runner ãŒ **ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ç›´æ¥ãƒ›ã‚¹ãƒˆã¸ rsync** ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚ãƒ‘ã‚¹ã‚’åŒã˜ã«ã™ã‚‹ã¨æ··ä¹±ãŒãªã„ã€‚                                           |

```bash
docker restart gitlab-runner
```

> `config.toml` ã¯èª­ã¿è¾¼ã¿æ™‚ã«ã—ã‹åæ˜ ã•ã‚Œãªã„ã®ã§ **å¿…ãšå†èµ·å‹•**ã€‚

---

## 4. Git æ“ä½œ

| ã‚³ãƒãƒ³ãƒ‰                             | æ„å‘³                                                        |
| ------------------------------------ | ----------------------------------------------------------- |
| `git clone <your_repo>.git`          | GitLab ã«ä½œã£ãŸç©ºãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã¸è¤‡è£½ã€‚               |
| `mkdir site`                         | CI ãŒæ‹¾ã† â€œé™çš„ã‚µã‚¤ãƒˆç½®ãå ´â€ã€‚                              |
| `echo "Hello ..." > site/index.html` | ã‚µãƒ³ãƒ—ãƒ«ãƒšãƒ¼ã‚¸ã‚’ã‚³ãƒŸãƒƒãƒˆå¯¾è±¡ã«ã€‚                            |
| `git add`, `commit`, `push`          | GitLab ã«ã‚³ãƒ¼ãƒ‰ã‚’åæ˜  â‡’ Push æ™‚ç‚¹ã§ CI ãŒèµ°ã‚‹ä»•æ›ã‘ã«ãªã‚‹ã€‚ |

---

## 5. `.gitlab-ci.yml` ã®å„ãƒ–ãƒ­ãƒƒã‚¯è§£èª¬

### ãƒ˜ãƒƒãƒ€

```yaml
stages: [test, deploy]
```

- **ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¯ 2 æ®µéš**ï¼š`test` â†’ `deploy`ã€‚ä¸ŠæµãŒè½ã¡ã‚Œã°ä¸‹æµã¯å‹•ã‹ãªã„ã€‚

### ãƒ«ãƒ¼ãƒ«å…±é€šéƒ¨åˆ†

```yaml
.default_rules: &default_rules
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"' # (1)
      when: always
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"' # (2)
      when: always
    - when: never # ã©ã¡ã‚‰ã§ã‚‚ãªã‘ã‚Œã°å®Ÿè¡Œã—ãªã„
```

| ãƒ©ãƒ™ãƒ« | æ„å‘³                                                   |
| ------ | ------------------------------------------------------ |
| (1)    | **MR ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³**ï¼ˆãƒ¬ãƒ“ãƒ¥ãƒ¼æ™‚ï¼‰ã§ã‚‚å‹•ã‹ã™ã€‚          |
| (2)    | **main ç›´ push**ï¼ˆãƒãƒ¼ã‚¸å¾Œ or ç›´ã‚³ãƒŸãƒƒãƒˆï¼‰ã§ã‚‚å‹•ã‹ã™ã€‚ |

### test ã‚¸ãƒ§ãƒ–

```yaml
test:
  stage: test
  image: alpine                # 3 MB ã®æ±ç”¨ Linux
  <<: *default_rules
  script:
    - test -f site/index.html  # (A)
```

| è¡Œ  | æ„å‘³                                                                               |
| --- | ---------------------------------------------------------------------------------- |
| (A) | `site/index.html` ãŒç„¡ã‘ã‚Œã° `exit 1` â†’ ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å¤±æ•—ã€‚**æœ€ä½é™ã®å“è³ªã‚²ãƒ¼ãƒˆ**ã€‚ |

### deploy ã‚¸ãƒ§ãƒ–

```yaml
deploy:
  stage: deploy
  tags: [docker] # Runner ã‚’é¸æŠ
  rules: # main ã« push ã—ãŸæ™‚ã ã‘
    - if: '$CI_COMMIT_BRANCH=="main" && $CI_PIPELINE_SOURCE=="push"'
      when: always
  script:
    - rsync -av --delete site/ /srv/site/ # (B)
    - docker compose exec nginx-app nginx -s reload # (C)
  environment:
    name: production
    url: http://$CI_SERVER_HOST
```

| ãƒ©ãƒ™ãƒ« | ã‚³ãƒãƒ³ãƒ‰                                        | ä½œç”¨                                                                               |
| ------ | ----------------------------------------------- | ---------------------------------------------------------------------------------- |
| (B)    | `rsync -av --delete site/ /srv/site/`           | **å·®åˆ†åŒæœŸ + å¤ã„ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤**ã€‚`a` ã¯ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ä¿æŒã€`v` ã¯ verboseã€‚        |
| (C)    | `docker compose exec nginx-app nginx -s reload` | nginx ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒ—ãƒ­ã‚»ã‚¹ã¸ **å†èª­è¾¼ã‚·ã‚°ãƒŠãƒ«**ã€‚è¨­å®šå¤‰æ›´ãªã— & ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ ã»ã¼ã‚¼ãƒ­ã€‚ |

---

## 6. å‹•ä½œç¢ºèªãƒ•ãƒ­ãƒ¼

| æ‰‹é †                      | ä½•ãŒèµ·ã“ã‚‹ï¼Ÿ                                                           |
| ------------------------- | ---------------------------------------------------------------------- |
| â‘  MR ä½œæˆ                 | Push ãƒˆãƒªã‚¬ã§ **`test` ã‚¸ãƒ§ãƒ–**ã®ã¿å®Ÿè¡Œ â†’ OK/NG ãŒãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»é¢ã«è¡¨ç¤ºã€‚ |
| â‘¡ main ã¸ãƒãƒ¼ã‚¸           | ãƒãƒ¼ã‚¸ã‚³ãƒŸãƒƒãƒˆãŒ push ã•ã‚Œ **`deploy` ã‚¸ãƒ§ãƒ–** ã‚‚å®Ÿè¡Œã€‚                |
| â‘¢ ãƒ–ãƒ©ã‚¦ã‚¶ç¢ºèª            | `/srv/site` ãŒæ›´æ–° â†’ nginx ãŒ reload â†’ æ–°ã—ã„ãƒšãƒ¼ã‚¸ãŒè¿”ã‚‹ã€‚            |
| â‘£ `docker logs nginx-app` | ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ãŒæ™‚åˆ»ä»˜ãã§å‡ºã‚‹ã®ã§ã€Œæœ¬å½“ã«è¦‹ãˆã¦ã‚‹ã‹ã€æ¤œè¨¼ã«ä¾¿åˆ©ã€‚       |

---

## 7. HTTPS åŒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³ä¸€è¨€

- `nginxproxy/nginx-proxy` ãŒ **è‡ªå‹•ã§ vhost ã‚’ç”Ÿæˆ**ã€‚
- `acme-companion` ãŒ **Letâ€™s Encrypt è¨¼æ˜æ›¸ã‚’å–å¾—ãƒ»æ›´æ–°**ã€‚
- ã‚³ãƒ³ãƒ†ãƒŠç’°å¢ƒå¤‰æ•° `VIRTUAL_HOST, LETSENCRYPT_HOST` ã ã‘ã§å®Œçµã™ã‚‹ã®ã§ã€GitLab æœ¬ä½“ã‚’ 8443ã€å…¬é–‹ nginx ã‚’ 443 ã«ã—ã¦ãƒãƒ¼ãƒˆã‚’åˆ†ã‘ã‚‹ã®ãŒæœ€ã‚‚ãƒ©ã‚¯ã€‚

---

## 8. ãƒãƒã‚Šãƒã‚¤ãƒ³ãƒˆå†æ²ï¼ˆåŸå›  â†’ å¯¾å‡¦ã®å› æœãŒè‚ï¼‰

| ç—‡çŠ¶                             | ç›´æ¥åŸå›                        | æ ¹æœ¬å¯¾ç­–                                            |
| -------------------------------- | ------------------------------ | --------------------------------------------------- |
| `/srv/site` ãŒç„¡ã„               | Runner ã‹ã‚‰è¦‹ãˆãªã„            | Runner ã® **volumes è¿½è¨˜** & å†èµ·å‹•                 |
| `docker compose exec` æ¨©é™ã‚¨ãƒ©ãƒ¼ | docker.sock ãŒ read-only       | `privileged=true` + `/var/run/docker.sock` ãƒã‚¦ãƒ³ãƒˆ |
| åæ˜ ã•ã‚Œãªã„                     | ãƒ–ãƒ©ã‚¦ã‚¶ã‚­ãƒ£ãƒƒã‚·ãƒ¥             | `Ctrl+F5` or `Cache-Control: no-store`              |
| 443 ãƒãƒ¼ãƒˆè¡çª                   | GitLab & å…¬é–‹ nginx ä¸¡æ–¹ãŒ 443 | **GitLab â†’ 8443ã€å…¬é–‹ nginx â†’ 443** ã«æ•´ç†          |

---

### âœ… ã¾ã¨ã‚

1. **/srv/site** ã‚’ â€œå…±æœ‰ãƒ•ã‚©ãƒ«ãƒ€â€ ã«è¦‹ç«‹ã¦ã¦ nginx ã¨ Runner ã§å…±æœ‰ã€‚
2. **rsync â†’ nginx reload** ã® 2 è¡Œã ã‘ã§ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ã€‚
3. ä½•ã‹å‹•ã‹ãªããªã£ãŸã‚‰ **volumes / æ¨©é™ / ãƒãƒ¼ãƒˆè¡çª** ã‚’ç–‘ã†ã¨å¤§æŠµå½“ãŸã‚Šã¾ã™ã€‚

ã‚³ãƒãƒ³ãƒ‰ã®æ„å‘³ã¾ã§è…¹è½ã¡ã—ãŸã‚‰ã€ã‚ã¨ã¯ `site/` ã‚’ **React ãƒ“ãƒ«ãƒ‰æˆæœç‰©** ã«å·®ã—æ›¿ãˆã‚‹ãªã©è‡ªç”±è‡ªåœ¨ã§ã™ã€‚ã¾ãšã¯ `index.html` ã®æ–‡è¨€ã‚’å¤‰ãˆã¦ push â¡ï¸ è‡ªå‹•åæ˜ ã‚’ä½“é¨“ã—ã¦ã¿ã¦ãã ã•ã„ ğŸš€
\*\*
