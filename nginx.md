ä»¥ä¸‹ã®æ‰‹é †ã§ **(1) nginx ã‚³ãƒ³ãƒ†ãƒŠã‚’ç«‹ã¦ã‚‹ â†’ (2) GitLab ã‹ã‚‰è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ CI/CD** ã‚’ä»•ä¸Šã’ã¾ã™ã€‚
_GitLabï¼ˆ:8181/8443ï¼‰ãƒ»GitLab Runner ã¯æ—¢ã« Docker ä¸Šã§ç¨¼åƒã—ã¦ã„ã‚‹å‰æã§ã™ã€‚_

---

## 0. ã–ã£ãã‚Šå…¨ä½“åƒ

```text
EC2
â”œâ”€ GitLab            :8181 / 8443   ï¼ˆæ—¢ã«èµ·å‹•æ¸ˆã¿ï¼‰
â”œâ”€ GitLab Runner     docker executorï¼ˆæ—¢ã«ç™»éŒ²æ¸ˆã¿ï¼‰
â””â”€ nginx-app         :80            â† ã“ã‚Œã‚’è¿½åŠ 
        â–²
        â””â”€ /srv/site  â€¦ HTML ã‚’ç½®ãã ã‘
              â–²
              â””â”€ GitLab repo ã® site/ ã‚’ CI ãŒ rsync
```

---

## 1. ãƒ›ã‚¹ãƒˆå´ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª & ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸

```bash
sudo mkdir -p /srv/site
sudo chown $(whoami):$(whoami) /srv/site

echo "Hello GitLab CI/CD! â€“ $(date)" > /srv/site/index.html
```

---

## 2. nginx-app ã‚µãƒ¼ãƒ“ã‚¹ã‚’ docker-compose ã«è¿½è¨˜

### 2-1 æ—¢å­˜ `docker-compose.yml` ã¸è¿½åŠ ï¼ˆä¾‹ï¼‰

```yaml
services:
  gitlab: # ã™ã§ã«ã‚ã‚‹ GitLab å®šç¾© â€¦
  gitlab-runner: # ã™ã§ã«ã‚ã‚‹ Runner å®šç¾© â€¦

  nginx-app: # â˜… è¿½åŠ 
    image: nginx:alpine
    container_name: nginx-app
    volumes:
      - /srv/site:/usr/share/nginx/html:ro
    ports:
      - "80:80" # 80 ç•ªã‚’å…¬é–‹
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost || exit 1"]
      interval: 30s
      timeout: 3s
      retries: 3
```

```bash
docker compose up -d nginx-app
curl http://localhost          #=> â€œHello GitLab CI/CD!â€
```

---

## 3. GitLab Runner ã‹ã‚‰ãƒ›ã‚¹ãƒˆã® `/srv/site` ã¨ Docker ã«è§¦ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹

`/srv/gitlab-runner/config/config.toml` ã‚’ç·¨é›†ã—ã¦ **volumes ã« `/srv/site:/srv/site`** ã‚’è¿½åŠ ã€‚
ï¼ˆ`/var/run/docker.sock` ã¯ç™»éŒ²æ™‚ã«ä»˜ã‘ã¦ã„ã‚Œã° OKï¼‰

```toml
[[runners]]
  executor = "docker"
  [runners.docker]
    privileged = true
    volumes = ["/var/run/docker.sock:/var/run/docker.sock", "/srv/site:/srv/site"]
    # ä»–ã®è¨­å®šã¯ãã®ã¾ã¾
```

> è¨­å®šå¤‰æ›´å¾Œï¼š`docker restart gitlab-runner`

---

## 4. GitLab ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦ã‚³ãƒ¼ãƒ‰ã‚’ push

```bash
git clone <your_repo>.git
cd your_repo
mkdir site
echo "Hello GitLab CI/CD from Git!" > site/index.html
git add site/index.html
git commit -m "init: add static site"
git push
```

---

## 5. `.gitlab-ci.yml` ã‚’ç½®ã

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç›´ä¸‹ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¦ commit â†’ pushã€‚
**ã‚¿ã‚° `docker` ã¯ runner ç™»éŒ²æ™‚ã«è¨­å®šã—ãŸã‚‚ã®ã¨åˆã‚ã›ã¦ãã ã•ã„ã€‚**

```yaml
stages: [test, deploy]

.default_rules: &default_rules
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: always
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'
      when: always
    - when: never

test:
  stage: test
  image: alpine
  <<: *default_rules
  script:
    - test -f site/index.html

deploy:
  stage: deploy
  tags: [docker]
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'
      when: always
  script:
    - rsync -av --delete site/ /srv/site/
    - docker compose exec nginx-app nginx -s reload
  environment:
    name: production
    url: http://$CI_SERVER_HOST
```

---

## 6. å‹•ä½œç¢ºèªãƒ•ãƒ­ãƒ¼

| æ‰‹é †                                         | æœŸå¾…å‹•ä½œ                                      |
| -------------------------------------------- | --------------------------------------------- |
| â‘  MR ã‚’ä½œæˆ                                  | `test` ã‚¸ãƒ§ãƒ–ãŒèµ°ã‚Šã€index.html æœ‰ç„¡ãƒã‚§ãƒƒã‚¯  |
| â‘¡ main ã«ãƒãƒ¼ã‚¸ / ç›´æ¥ push                  | `deploy` ã‚¸ãƒ§ãƒ–ãŒå®Ÿè¡Œ â†’ `/srv/site/` ã¸ rsync |
| â‘¢ ã‚¸ãƒ§ãƒ–å®Œäº†å¾Œãƒ–ãƒ©ã‚¦ã‚¶ã‚’æ›´æ–°                 | å¤‰æ›´ãŒåæ˜ ã•ã‚Œã¦ã„ã‚Œã°æˆåŠŸ                    |
| â‘£ `docker logs nginx-app` ã§ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ç¢ºèª | ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã‚¢ã‚¯ã‚»ã‚¹ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª  |

---

## 7. HTTPS ã‚’ä»˜ã‘ãŸã„å ´åˆï¼ˆä»»æ„ï¼‰

1. `nginxproxy/nginx-proxy` ï¼‹ `acme-companion` ã‚’ compose ã«è¿½åŠ ã€‚
2. `nginx-app` ã«ã¯ `VIRTUAL_HOST=example.com` ç’°å¢ƒå¤‰æ•°ã‚’ä»˜ä¸ã€‚
3. GitLab ã¯å¼•ãç¶šã 8181/8443ã€å…¬é–‹ nginx ã¯ 80/443 ã§åˆ†é›¢ã€‚

---

## 8. ã‚ˆãã‚ã‚‹ãƒãƒã‚Šãƒã‚¤ãƒ³ãƒˆ

| ç—‡çŠ¶ / ã‚¨ãƒ©ãƒ¼                        | åŸå›                                 | è§£æ±ºç­–                                                    |
| ------------------------------------ | ----------------------------------- | --------------------------------------------------------- |
| `deploy` ã‚¸ãƒ§ãƒ–ã§ `/srv/site` ãŒç„¡ã„ | Runner ã‚³ãƒ³ãƒ†ãƒŠã« volume æœªãƒã‚¦ãƒ³ãƒˆ | `config.toml` ã® `volumes` ã« `/srv/site:/srv/site` è¿½åŠ   |
| `docker compose exec` ãŒå¤±æ•—         | Runner â†’ docker.sock ãŒç„¡æ¨©é™       | `privileged = true` & `/var/run/docker.sock` ã‚’ãƒã‚¦ãƒ³ãƒˆ   |
| ãƒ–ãƒ©ã‚¦ã‚¶ãŒå¤ã„å†…å®¹ã‚’è¡¨ç¤º             | ã‚­ãƒ£ãƒƒã‚·ãƒ¥                          | `Ctrl+F5` or nginx ã§ `add_header Cache-Control no-store` |
| 443 ã§ GitLab/å…¬é–‹ nginx ãŒè¡çª      | ä¸¡æ–¹ãŒåŒãƒãƒ¼ãƒˆä½¿ç”¨                  | GitLab ã¯ 8443ã€å…¬é–‹ nginx ã¯ 443 ã§ãƒãƒ¼ãƒˆåˆ†é›¢            |

---

### ã“ã‚Œã§å®Œæˆ ğŸ‰

- **EC2 ä¸Šã® 3 ã‚³ãƒ³ãƒ†ãƒŠï¼ˆGitLab / Runner / nginx-appï¼‰ã ã‘** ã§é™çš„ã‚µã‚¤ãƒˆã® CI/CD ãŒå›ã‚Šã¾ã™ã€‚
- SPA ã‚„ API ã‚µãƒ¼ãƒãƒ¼ã«å·®ã—æ›¿ãˆã‚‹å ´åˆã¯

  1. `build` ã‚¹ãƒ†ãƒƒãƒ—ã§æˆæœç‰©ã‚’ `site/` ã¸ã‚³ãƒ”ãƒ¼ã—ã€
  2. `deploy` ã§åŒã˜ rsync â†’ reload ã‚’è¡Œãˆã° OKã€‚

ã¾ãšã¯ `index.html` ã‚’ã¡ã‚‡ã£ã¨æ›¸ãæ›ãˆã¦ push â†’ è‡ªå‹•åæ˜ ã‚’ç¢ºèªã—ã¦ã¿ã¦ãã ã•ã„ï¼

**ä»¥ä¸‹ã§ã¯ **ã‚·ã‚§ãƒ«ã§æ‰“ã¤ã‚³ãƒãƒ³ãƒ‰** ã¨ **YAML ã®å„è¡Œ\*_ ã‚’ 1 è¡Œãšã¤å–ã‚Šä¸Šã’ã€ã€Œä½•ãŒèµ·ã“ã‚‹ã‹ã€ã€Œãªãœå¿…è¦ã‹ã€ã‚’ä¸å¯§ã«è§£èª¬ã—ã¾ã™ã€‚
_â€•â€•è¦‹ãªãŒã‚‰æ‰‹ã‚’å‹•ã‹ã›ã°ã€ä»•çµ„ã¿ãŒã‚¹ãƒƒã¨é ­ã«å…¥ã‚‹ã¯ãšã§ã™ã€‚\*

---

## 1. ãƒ›ã‚¹ãƒˆå´ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª & ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸

| ã‚³ãƒãƒ³ãƒ‰                                                      | ä½•ã‚’ã™ã‚‹ï¼Ÿ                                                                                                | ãªãœå¿…è¦ï¼Ÿ                                                                                          |
| ------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------- |
| `sudo mkdir -p /srv/site`                                     | `/srv/site` ã¨ã„ã†ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ **root æ¨©é™**ã§ä½œæˆã€‚`-p` ã§é€”ä¸­ã®è¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒç„¡ãã¦ã‚‚ã¾ã¨ã‚ã¦ä½œã‚‹ã€‚ | nginx ã‚³ãƒ³ãƒ†ãƒŠãŒ â€œã“ã“ã‚’ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ«ãƒ¼ãƒˆã«ã™ã‚‹â€ ãŸã‚ã® **å®Ÿä½“** ã‚’ç”¨æ„ã€‚                          |
| `sudo chown $(whoami):$(whoami) /srv/site`                    | ã§ããŸ `/srv/site` ã‚’ã€Œä»Šãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ (whoami)ã€ã«æ‰€æœ‰æ¨©å¤‰æ›´ã€‚                                  | `rsync` ã§æ›¸ãè¾¼ã¿ã‚’è¡Œã†ã®ã¯ Runner â†’ ãƒ›ã‚¹ãƒˆã® `/srv/site`ã€‚root ã®ã¾ã¾ã ã¨æ›¸ãè¾¼ã¿æ¨©é™ã§ã‚³ã‚±ãŒã¡ã€‚ |
| `echo "Hello GitLab CI/CD! â€“ $(date)" > /srv/site/index.html` | ãƒ†ã‚¹ãƒˆç”¨ã® `index.html` ã‚’ä¸€ç™ºç”Ÿæˆã€‚`$(date)` ã§ç¾åœ¨æ™‚åˆ»ã‚‚åŸ‹ã‚è¾¼ã¿ã€‚                                      | nginx ãŒæ­£ã—ãç«‹ã¡ä¸ŠãŒã£ãŸã‹ `curl` ã§ç¢ºèªã™ã‚‹è¶³ãŒã‹ã‚Šã€‚                                            |

---

## 2. docker-compose.yml ã®è¿½åŠ è¡Œã‚’åˆ†è§£

```yaml
nginx-app:
  image: nginx:alpine # â‘ 
  container_name: nginx-app # â‘¡
  volumes: # â‘¢
    - /srv/site:/usr/share/nginx/html:ro
  ports:
    - "80:80" # â‘£
  restart: always # â‘¤
  healthcheck: # â‘¥
    test: ["CMD-SHELL", "wget -qO- http://localhost || exit 1"]
    interval: 30s
    timeout: 3s
    retries: 3
```

| ç•ªå· | è¡Œ                                              | æ„å‘³                                                                                                     |
| ---- | ----------------------------------------------- | -------------------------------------------------------------------------------------------------------- |
| â‘     | `image: nginx:alpine`                           | å…¬å¼ nginx ã® **æœ€å°ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼ˆAlpine Linux ãƒ™ãƒ¼ã‚¹ï¼‰** ã‚’ä½¿ã†ã€‚ã‚µã‚¤ã‚º â‰ˆ5 MB ã¨æ¿€è»½ã€‚                      |
| â‘¡    | `container_name: nginx-app`                     | ã‚³ãƒ³ãƒ†ãƒŠã«å›ºå®šåã‚’ä»˜ã‘ã‚‹ã€‚`docker compose exec nginx-app` ã§å‚ç…§ã—ã‚„ã™ãã™ã‚‹ãŸã‚ã€‚                       |
| â‘¢    | `volumes:` `/srv/site:/usr/share/nginx/html:ro` | ãƒ›ã‚¹ãƒˆ `/srv/site` ã‚’ **ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ«ãƒ¼ãƒˆ**ã«ãƒã‚¤ãƒ³ãƒ‰ã€‚`:ro` ã§èª­ã¿å–ã‚Šå°‚ç”¨ï¼èª¤ä¸Šæ›¸ãã‚’é˜²æ­¢ã€‚ |
| â‘£    | `ports: "80:80"`                                | ãƒ›ã‚¹ãƒˆã® **80 ç•ªãƒãƒ¼ãƒˆ** ã‚’ã‚³ãƒ³ãƒ†ãƒŠã® 80 ç•ªã«å…¬é–‹ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ãŒ `http://<EC2_IP>/` ã§è¦‹ã‚‰ã‚Œã‚‹ã€‚            |
| â‘¤    | `restart: always`                               | EC2 å†èµ·å‹•ã‚„ nginx ãŒã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ã¦ã‚‚ **è‡ªå‹•å†èµ·å‹•**ã€‚é‹ç”¨ã§ã‚ã‚ŠãŒã¡ãªã€Œãªãœã‹è½ã¡ã¦ãŸã€ã‚’å›é¿ã€‚         |
| â‘¥    | `healthcheck:`                                  | 30 ç§’ã”ã¨ã« `wget` ã§è‡ªå·±ãƒã‚§ãƒƒã‚¯ã€‚å¿œç­”ãŒç„¡ã„ã¨ **Docker ãŒçŠ¶æ…‹ã‚’ unhealthy ã«** â†’ ç›£è¦–ã§æ¤œçŸ¥ã—ã‚„ã™ã„ã€‚  |

### èµ·å‹•ã‚³ãƒãƒ³ãƒ‰

| ã‚³ãƒãƒ³ãƒ‰                         | ä½•ã‚’ã™ã‚‹ï¼Ÿ                                                                             |
| -------------------------------- | -------------------------------------------------------------------------------------- |
| `docker compose up -d nginx-app` | `-d` ã§ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰èµ·å‹•ã€‚`docker ps` ã§ `Up` çŠ¶æ…‹ç¢ºèªå¯ã€‚                          |
| `curl http://localhost`          | **EC2 å†…ã‹ã‚‰** HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã€‚`Hello GitLab CI/CD!` ãŒè¿”ã‚Œã° nginx + volume ãŒæ­£å¸¸ã€‚ |

---

## 3. Runner ã® `config.toml` è¿½è¨˜

```toml
volumes = [
 "/var/run/docker.sock:/var/run/docker.sock",
 "/srv/site:/srv/site"
]
```

| è¡Œ                                          | æ„å‘³                                                                                                                                      |
| ------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------- |
| `/var/run/docker.sock:/var/run/docker.sock` | Runner ã‚³ãƒ³ãƒ†ãƒŠå†…ã‹ã‚‰ **ãƒ›ã‚¹ãƒˆã® Docker ãƒ‡ãƒ¼ãƒ¢ãƒ³** ã‚’å©ã‘ã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚ã€Œã‚³ãƒ³ãƒ†ãƒŠ in ã‚³ãƒ³ãƒ†ãƒŠã€ã®å®šç•ªè¨­å®šã€‚`privileged = true` ã‚‚å¿˜ã‚Œãšã€‚ |
| `/srv/site:/srv/site`                       | Runner ãŒ **ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ç›´æ¥ãƒ›ã‚¹ãƒˆã¸ rsync** ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚ãƒ‘ã‚¹ã‚’åŒã˜ã«ã™ã‚‹ã¨æ··ä¹±ãŒãªã„ã€‚                                           |

```bash
docker restart gitlab-runner
```

> `config.toml` ã¯èª­ã¿è¾¼ã¿æ™‚ã«ã—ã‹åæ˜ ã•ã‚Œãªã„ã®ã§ **å¿…ãšå†èµ·å‹•**ã€‚

---

## 4. Git æ“ä½œ

| ã‚³ãƒãƒ³ãƒ‰                             | æ„å‘³                                                        |
| ------------------------------------ | ----------------------------------------------------------- |
| `git clone <your_repo>.git`          | GitLab ã«ä½œã£ãŸç©ºãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã¸è¤‡è£½ã€‚               |
| `mkdir site`                         | CI ãŒæ‹¾ã† â€œé™çš„ã‚µã‚¤ãƒˆç½®ãå ´â€ã€‚                              |
| `echo "Hello ..." > site/index.html` | ã‚µãƒ³ãƒ—ãƒ«ãƒšãƒ¼ã‚¸ã‚’ã‚³ãƒŸãƒƒãƒˆå¯¾è±¡ã«ã€‚                            |
| `git add`, `commit`, `push`          | GitLab ã«ã‚³ãƒ¼ãƒ‰ã‚’åæ˜  â‡’ Push æ™‚ç‚¹ã§ CI ãŒèµ°ã‚‹ä»•æ›ã‘ã«ãªã‚‹ã€‚ |

---

## 5. `.gitlab-ci.yml` ã®å„ãƒ–ãƒ­ãƒƒã‚¯è§£èª¬

### ãƒ˜ãƒƒãƒ€

```yaml
stages: [test, deploy]
```

- **ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¯ 2 æ®µéš**ï¼š`test` â†’ `deploy`ã€‚ä¸ŠæµãŒè½ã¡ã‚Œã°ä¸‹æµã¯å‹•ã‹ãªã„ã€‚

### ãƒ«ãƒ¼ãƒ«å…±é€šéƒ¨åˆ†

```yaml
.default_rules: &default_rules
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"' # (1)
      when: always
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"' # (2)
      when: always
    - when: never # ã©ã¡ã‚‰ã§ã‚‚ãªã‘ã‚Œã°å®Ÿè¡Œã—ãªã„
```

| ãƒ©ãƒ™ãƒ« | æ„å‘³                                                   |
| ------ | ------------------------------------------------------ |
| (1)    | **MR ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³**ï¼ˆãƒ¬ãƒ“ãƒ¥ãƒ¼æ™‚ï¼‰ã§ã‚‚å‹•ã‹ã™ã€‚          |
| (2)    | **main ç›´ push**ï¼ˆãƒãƒ¼ã‚¸å¾Œ or ç›´ã‚³ãƒŸãƒƒãƒˆï¼‰ã§ã‚‚å‹•ã‹ã™ã€‚ |

### test ã‚¸ãƒ§ãƒ–

```yaml
test:
  stage: test
  image: alpine                # 3 MB ã®æ±ç”¨ Linux
  <<: *default_rules
  script:
    - test -f site/index.html  # (A)
```

| è¡Œ  | æ„å‘³                                                                               |
| --- | ---------------------------------------------------------------------------------- |
| (A) | `site/index.html` ãŒç„¡ã‘ã‚Œã° `exit 1` â†’ ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å¤±æ•—ã€‚**æœ€ä½é™ã®å“è³ªã‚²ãƒ¼ãƒˆ**ã€‚ |

### deploy ã‚¸ãƒ§ãƒ–

```yaml
deploy:
  stage: deploy
  tags: [docker] # Runner ã‚’é¸æŠ
  rules: # main ã« push ã—ãŸæ™‚ã ã‘
    - if: '$CI_COMMIT_BRANCH=="main" && $CI_PIPELINE_SOURCE=="push"'
      when: always
  script:
    - rsync -av --delete site/ /srv/site/ # (B)
    - docker compose exec nginx-app nginx -s reload # (C)
  environment:
    name: production
    url: http://$CI_SERVER_HOST
```

| ãƒ©ãƒ™ãƒ« | ã‚³ãƒãƒ³ãƒ‰                                        | ä½œç”¨                                                                               |
| ------ | ----------------------------------------------- | ---------------------------------------------------------------------------------- |
| (B)    | `rsync -av --delete site/ /srv/site/`           | **å·®åˆ†åŒæœŸ + å¤ã„ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤**ã€‚`a` ã¯ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ä¿æŒã€`v` ã¯ verboseã€‚        |
| (C)    | `docker compose exec nginx-app nginx -s reload` | nginx ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒ—ãƒ­ã‚»ã‚¹ã¸ **å†èª­è¾¼ã‚·ã‚°ãƒŠãƒ«**ã€‚è¨­å®šå¤‰æ›´ãªã— & ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ ã»ã¼ã‚¼ãƒ­ã€‚ |

---

## 6. å‹•ä½œç¢ºèªãƒ•ãƒ­ãƒ¼

| æ‰‹é †                      | ä½•ãŒèµ·ã“ã‚‹ï¼Ÿ                                                           |
| ------------------------- | ---------------------------------------------------------------------- |
| â‘  MR ä½œæˆ                 | Push ãƒˆãƒªã‚¬ã§ **`test` ã‚¸ãƒ§ãƒ–**ã®ã¿å®Ÿè¡Œ â†’ OK/NG ãŒãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»é¢ã«è¡¨ç¤ºã€‚ |
| â‘¡ main ã¸ãƒãƒ¼ã‚¸           | ãƒãƒ¼ã‚¸ã‚³ãƒŸãƒƒãƒˆãŒ push ã•ã‚Œ **`deploy` ã‚¸ãƒ§ãƒ–** ã‚‚å®Ÿè¡Œã€‚                |
| â‘¢ ãƒ–ãƒ©ã‚¦ã‚¶ç¢ºèª            | `/srv/site` ãŒæ›´æ–° â†’ nginx ãŒ reload â†’ æ–°ã—ã„ãƒšãƒ¼ã‚¸ãŒè¿”ã‚‹ã€‚            |
| â‘£ `docker logs nginx-app` | ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ãŒæ™‚åˆ»ä»˜ãã§å‡ºã‚‹ã®ã§ã€Œæœ¬å½“ã«è¦‹ãˆã¦ã‚‹ã‹ã€æ¤œè¨¼ã«ä¾¿åˆ©ã€‚       |

---

## 7. HTTPS åŒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³ä¸€è¨€

- `nginxproxy/nginx-proxy` ãŒ **è‡ªå‹•ã§ vhost ã‚’ç”Ÿæˆ**ã€‚
- `acme-companion` ãŒ **Letâ€™s Encrypt è¨¼æ˜æ›¸ã‚’å–å¾—ãƒ»æ›´æ–°**ã€‚
- ã‚³ãƒ³ãƒ†ãƒŠç’°å¢ƒå¤‰æ•° `VIRTUAL_HOST, LETSENCRYPT_HOST` ã ã‘ã§å®Œçµã™ã‚‹ã®ã§ã€GitLab æœ¬ä½“ã‚’ 8443ã€å…¬é–‹ nginx ã‚’ 443 ã«ã—ã¦ãƒãƒ¼ãƒˆã‚’åˆ†ã‘ã‚‹ã®ãŒæœ€ã‚‚ãƒ©ã‚¯ã€‚

---

## 8. ãƒãƒã‚Šãƒã‚¤ãƒ³ãƒˆå†æ²ï¼ˆåŸå›  â†’ å¯¾å‡¦ã®å› æœãŒè‚ï¼‰

| ç—‡çŠ¶                             | ç›´æ¥åŸå›                        | æ ¹æœ¬å¯¾ç­–                                            |
| -------------------------------- | ------------------------------ | --------------------------------------------------- |
| `/srv/site` ãŒç„¡ã„               | Runner ã‹ã‚‰è¦‹ãˆãªã„            | Runner ã® **volumes è¿½è¨˜** & å†èµ·å‹•                 |
| `docker compose exec` æ¨©é™ã‚¨ãƒ©ãƒ¼ | docker.sock ãŒ read-only       | `privileged=true` + `/var/run/docker.sock` ãƒã‚¦ãƒ³ãƒˆ |
| åæ˜ ã•ã‚Œãªã„                     | ãƒ–ãƒ©ã‚¦ã‚¶ã‚­ãƒ£ãƒƒã‚·ãƒ¥             | `Ctrl+F5` or `Cache-Control: no-store`              |
| 443 ãƒãƒ¼ãƒˆè¡çª                   | GitLab & å…¬é–‹ nginx ä¸¡æ–¹ãŒ 443 | **GitLab â†’ 8443ã€å…¬é–‹ nginx â†’ 443** ã«æ•´ç†          |

---

### âœ… ã¾ã¨ã‚

1. **/srv/site** ã‚’ â€œå…±æœ‰ãƒ•ã‚©ãƒ«ãƒ€â€ ã«è¦‹ç«‹ã¦ã¦ nginx ã¨ Runner ã§å…±æœ‰ã€‚
2. **rsync â†’ nginx reload** ã® 2 è¡Œã ã‘ã§ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ã€‚
3. ä½•ã‹å‹•ã‹ãªããªã£ãŸã‚‰ **volumes / æ¨©é™ / ãƒãƒ¼ãƒˆè¡çª** ã‚’ç–‘ã†ã¨å¤§æŠµå½“ãŸã‚Šã¾ã™ã€‚

ã‚³ãƒãƒ³ãƒ‰ã®æ„å‘³ã¾ã§è…¹è½ã¡ã—ãŸã‚‰ã€ã‚ã¨ã¯ `site/` ã‚’ **React ãƒ“ãƒ«ãƒ‰æˆæœç‰©** ã«å·®ã—æ›¿ãˆã‚‹ãªã©è‡ªç”±è‡ªåœ¨ã§ã™ã€‚ã¾ãšã¯ `index.html` ã®æ–‡è¨€ã‚’å¤‰ãˆã¦ push â¡ï¸ è‡ªå‹•åæ˜ ã‚’ä½“é¨“ã—ã¦ã¿ã¦ãã ã•ã„ ğŸš€
\*\*

## ã“ã‚Œã‹ã‚‰ã‚„ã‚‹ã“ã¨ â€• ã–ã£ãã‚Š 3 è¡Œã¾ã¨ã‚

1. **â€œWeb ãƒšãƒ¼ã‚¸ã®ç½®ãå ´â€** ã‚’ `/srv/site` ã«ç”¨æ„ã—ã€nginx ã‚³ãƒ³ãƒ†ãƒŠã§å…¬é–‹ã™ã‚‹ã€‚
2. GitLab ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã« **`site/` ãƒ•ã‚©ãƒ«ãƒ€**ã‚’ç½®ãã€GitLab Runner ãŒ `/srv/site` ã¸ã‚³ãƒ”ãƒ¼ã™ã‚‹ä»•çµ„ã¿ï¼ˆCI/CDï¼‰ã‚’æ›¸ãã€‚
3. `main` ãƒ–ãƒ©ãƒ³ãƒã« push ã™ã‚‹ã¨ **è‡ªå‹•ã§åæ˜ **ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã€‚

ä»¥ä¸‹ã€å°‚é–€ç”¨èªã‚’ã‹ã¿ç •ããªãŒã‚‰ **å®Œå…¨åˆå¿ƒè€…ãƒ¢ãƒ¼ãƒ‰** ã§é€²ã‚ã¾ã™ ğŸ”°

---

## 0. ã‚´ãƒ¼ãƒ«ã¨ç¾åœ¨åœ°ã®ç¢ºèª

| é …ç›®             | ä»Šã©ã“ï¼Ÿ                                    | ã‚´ãƒ¼ãƒ«                       |
| ---------------- | ------------------------------------------- | ---------------------------- |
| GitLab æœ¬ä½“      | Docker ã§èµ·å‹•æ¸ˆã¿ï¼ˆ`http://<EC2_IP>:8181`ï¼‰ | ãã®ã¾ã¾ä½¿ã†                 |
| GitLab Runner    | Docker ã§èµ·å‹• & ç™»éŒ²æ¸ˆã¿                    | nginx ç”¨ã®ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œ       |
| nginx            | ã¾ã ç„¡ã„                                    | Docker ã‚³ãƒ³ãƒ†ãƒŠã§å…¬é–‹        |
| `.gitlab-ci.yml` | ã¾ã ç„¡ã„                                    | **1 ãƒ•ã‚¡ã‚¤ãƒ«**ã§è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ |

---

## 1. ç”¨èªã‚’ 3 ã¤ã ã‘è¦šãˆã‚‹

| ç”¨èª                        | ã–ã£ãã‚Šèª¬æ˜                                                                      |
| --------------------------- | --------------------------------------------------------------------------------- |
| **ã‚¸ãƒ§ãƒ– (job)**            | â€œã“ã‚Œã‚„ã£ã¨ã„ã¦â€ ã¨ã„ã† **1 ã¤ã®ä½œæ¥­å˜ä½**ï¼ˆãƒ†ã‚¹ãƒˆã‚’èµ°ã‚‰ã›ã‚‹ã€ãƒ“ãƒ«ãƒ‰ã™ã‚‹â€¦ï¼‰       |
| **ã‚¹ãƒ†ãƒ¼ã‚¸ (stage)**        | ã‚¸ãƒ§ãƒ–ã‚’ã‚°ãƒ«ãƒ¼ãƒ—ã«ã—ãŸã‚‚ã®ã€‚ä¸ŠæµãŒæˆåŠŸã™ã‚‹ã¨ä¸‹æµãŒå‹•ãã€‚<br>ä¾‹ï¼š`test` â†’ `deploy` |
| **ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ (pipeline)** | ã‚¸ãƒ§ãƒ–ã¨ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’ **å…¨éƒ¨ã¾ã¨ã‚ãŸæµã‚Œ**ã€‚push ã—ãŸã‚‰è‡ªå‹•ã§å§‹ã¾ã‚‹ã€‚                |

---

## 2. ãƒ›ã‚¹ãƒˆã«å…¬é–‹ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œã‚‹

```bash
# 1) å…¬é–‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œã‚‹
sudo mkdir -p /srv/site

# 2) è‡ªåˆ†ï¼ˆec2-user ãªã©ï¼‰ã«æ›¸ãè¾¼ã¿æ¨©ã‚’æ¸¡ã™
sudo chown $(whoami):$(whoami) /srv/site

# 3) ã¨ã‚Šã‚ãˆãšãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸
echo "åˆã‚ã¦ã® GitLab CI/CD! $(date)" > /srv/site/index.html
```

> **ã“ã“ãŒãƒã‚¤ãƒ³ãƒˆ**
>
> - /srv/site ãŒ **å®Ÿç‰©ã® Web ãƒ«ãƒ¼ãƒˆ** ã«ãªã‚‹ã€‚
> - Runner ã‹ã‚‰ã‚‚ nginx ã‹ã‚‰ã‚‚è¦‹ãˆã‚‹ã‚ˆã†ã« â€œå…±é€šã®ãƒ•ã‚©ãƒ«ãƒ€â€ ã«ã—ã¦ãŠãã€‚

---

## 3. nginx ã‚³ãƒ³ãƒ†ãƒŠã‚’ 1 åˆ†ã§ç«‹ã¦ã‚‹

1. **docker-compose.yml**ï¼ˆæ–°è¦ã‹æ—¢å­˜ã«è¿½åŠ ï¼‰

   ```yaml
   services:
     nginx-app: # åå‰ã¯è‡ªç”±
       image: nginx:alpine
       container_name: nginx-app
       volumes:
         - /srv/site:/usr/share/nginx/html:ro
       ports:
         - "80:80"
       restart: always
   ```

2. èµ·å‹•

   ```bash
   docker compose up -d nginx-app
   curl http://localhost        # ã•ã£ãã®ãƒ†ã‚­ã‚¹ãƒˆãŒè¿”ã‚Œã° OK
   ```

---

## 4. Runner ã‹ã‚‰ /srv/site ã‚’è§¦ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹

`/srv/gitlab-runner/config/config.toml` ã‚’é–‹ãã€**volumes** ã«è¿½è¨˜ï¼š

```toml
volumes = [
  "/var/run/docker.sock:/var/run/docker.sock",  # docker åˆ¶å¾¡ç”¨
  "/srv/site:/srv/site"                         # å…¬é–‹ãƒ•ã‚©ãƒ«ãƒ€
]
```

```bash
docker restart gitlab-runner    # å¤‰æ›´ã‚’åæ˜ 
```

---

## 5. GitLab ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”¨æ„ã—ã¦ã‚³ãƒ¼ãƒ‰ã‚’ push

```bash
git clone http://<EC2_IP>:8181/<namespace>/<project>.git
cd <project>
mkdir site
echo "Git ã‹ã‚‰æ¥ãŸã‚ˆï¼" > site/index.html
git add site/index.html
git commit -m "feat: first page"
git push -u origin main
```

---

## 6. `.gitlab-ci.yml` ã‚’ 18 è¡Œã§æ›¸ã

> ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã® **ãƒ«ãƒ¼ãƒˆ** ã«é…ç½® â†’ commit â†’ push

```yaml
stages: [test, deploy] # 1) ã¾ãšæ®µéšã‚’ä¸¦ã¹ã‚‹

unit-test: # ------------ test ã‚¸ãƒ§ãƒ– ------------
  stage: test
  image: alpine
  script:
    - test -f site/index.html # 2) ãƒ•ã‚¡ã‚¤ãƒ«ãŒç„¡ã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼ã§çµ‚äº†

deploy-to-nginx: # ------------ deploy ã‚¸ãƒ§ãƒ– ------------
  stage: deploy
  tags: [docker] # Runner ç™»éŒ²æ™‚ã® tag ã¨ä¸€è‡´ã•ã›ã‚‹
  rules: # main ãƒ–ãƒ©ãƒ³ãƒã« push ã—ãŸæ™‚ã ã‘
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE=="push"'
      when: always
  script:
    - rsync -av --delete site/ /srv/site/ # 3) ã‚³ãƒ”ãƒ¼
    - docker compose exec nginx-app nginx -s reload # 4) nginx ã‚’å†èª­è¾¼
  environment:
    name: production
    url: http://$CI_SERVER_HOST
```

### è¡Œã”ã¨ã®æ„å‘³

| è¡Œ                       | å½¹å‰²                                                                        |
| ------------------------ | --------------------------------------------------------------------------- |
| `stages`                 | ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãŒ **test â†’ deploy** ã®é †ã«æµã‚Œã‚‹å®£è¨€                           |
| `unit-test` ã‚¸ãƒ§ãƒ–       | æœ€ä½é™ â€œindex.html ãŒã‚ã‚‹ã‹â€ ã ã‘ç¢ºèª                                       |
| `deploy-to-nginx` ã‚¸ãƒ§ãƒ– | - `rsync` ã§ /srv/site ã‚’ä¸¸ã”ã¨æ›´æ–°<br>- `nginx -s reload` ã§æ•°ç§’ã§åˆ‡ã‚Šæ›¿ãˆ |
| `rules`                  | main ã¸ã® push ã§ã—ã‹ deploy ã—ãªã„å®‰å…¨å¼                                   |
| `tags`                   | ã©ã® Runner ãŒå‹•ãã‹æŒ‡å®šï¼ˆdocker executor ã® Runnerï¼‰                       |

---

## 7. å‹•ã‹ã—ã¦ã¿ã‚‹

1. `index.html` ã®ä¸­èº«ã‚’ç·¨é›†ã—ã¦ commit / push
2. GitLab ã® **CI/CD â€º Pipelines** ã‚’é–‹ã
3. `unit-test` â†’ `deploy-to-nginx` ãŒã©ã¡ã‚‰ã‚‚ âœ… ã«ãªã£ãŸã‚‰æˆåŠŸ
4. ãƒ–ãƒ©ã‚¦ã‚¶ã§ `http://<EC2_IP>/` ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ â†’ æ–°ã—ã„æ–‡è¨€ãŒå‡ºã‚Œã° OK

---

## 8. ã‚‚ã†å°‘ã—å…ˆã¸ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ»ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®â€œã•ã‚ã‚Šâ€ã ã‘ï¼‰

| æ©Ÿèƒ½                   | 1 è¡Œã¾ã¨ã‚                                                   | ä¾‹ã‚’æ›¸ãã¨â€¦                                                     |
| ---------------------- | ------------------------------------------------------------ | --------------------------------------------------------------- |
| **cache:**             | â€œæ¬¡ã®ã‚¸ãƒ§ãƒ–ï¼æ¬¡ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§ã‚‚å†åˆ©ç”¨ã—ãŸã„ãƒ•ã‚¡ã‚¤ãƒ«ç½®ãå ´â€ | `cache: {paths: [node_modules/]}` ã§ npm install ã‚’é«˜é€ŸåŒ–       |
| **artifacts:**         | â€œã‚ã¨ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„ or æ¬¡ã®ã‚¸ãƒ§ãƒ–ã«æ¸¡ã—ãŸã„æˆæœç‰©â€     | `artifacts: {paths: [build.zip], expire_in: 1 week}`            |
| **Container Registry** | GitLab ä»˜å±ã® **Docker Hub ã‚‚ã©ã**                          | `docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA`                 |
| **Generic Packages**   | ZIP ã‚„ãƒã‚¤ãƒŠãƒªã‚’ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä»˜ãã§ä¿å­˜                         | API ã§ `/packages/generic/<name>/<ver>/file.zip` ã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ |

> ã¾ãšã¯ **å‹•ããƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’ä½“é¨“** â†’ æ…£ã‚ŒãŸã‚‰ `cache` ã§ãƒ“ãƒ«ãƒ‰é«˜é€ŸåŒ–ã€`Registry` ã§ã‚¤ãƒ¡ãƒ¼ã‚¸ç®¡ç†ã«ã‚¹ãƒ†ãƒƒãƒ—ã‚¢ãƒƒãƒ—ã™ã‚‹ã®ãŒãŠã™ã™ã‚ã§ã™ã€‚

---

### ğŸ“Œ ã¾ã¨ã‚

- **ä»Šã‚„ã£ãŸã“ã¨**ï¼š`site/` â†’ `/srv/site/` â†’ `nginx reload` ã‚’ GitLab ã«è‚©ä»£ã‚ã‚Šã•ã›ãŸã€‚
- **è¦šãˆã‚‹ã‚­ãƒ¢**ï¼š

  1. `script:` ã¯ â€œå®Ÿéš›ã« EC2 ã§å©ãã‚·ã‚§ãƒ«ã‚³ãƒãƒ³ãƒ‰â€ ãŒãã®ã¾ã¾å…¥ã‚‹ã€‚
  2. Runner ãŒè¦‹ãˆã‚‹ãƒ•ã‚©ãƒ«ãƒ€ã« **volume ãƒã‚¦ãƒ³ãƒˆ** ã—ã¦ãŠãã¨ã‚³ãƒ”ãƒ¼ãŒæ¥½ã€‚
  3. ãƒˆãƒ©ãƒ–ãƒ«æ™‚ã¯ **volumes / æ¨©é™ / ãƒãƒ¼ãƒˆç«¶åˆ** ã‚’ã¾ãšç–‘ã†ã€‚

ã“ã‚Œã§ **â€œpush â†’ è‡ªå‹•å…¬é–‹â€** ã®åŸºæœ¬ãŒå®Œæˆã§ã™ã€‚
ã‚‚ã—è¡Œãè©°ã¾ã£ãŸã‚‰ _ã©ã®ã‚³ãƒãƒ³ãƒ‰ãŒã‚¨ãƒ©ãƒ¼ã‚’å‡ºã—ã¦ã„ã‚‹ã‹_ ã‚’ãƒ­ã‚°ã§ç¢ºèª â†’ å¯¾è±¡ã®ã‚³ãƒ³ãƒ†ãƒŠã« `docker exec -it <name> sh` ã§å…¥ã£ã¦æ‰‹ä½œæ¥­ã™ã‚‹ã¨åŸå› ãŒè¦‹ã¤ã‹ã‚Šã‚„ã™ã„ã§ã™ã‚ˆã€‚

### ã©ã†ã¾ã¨ã‚ã‚‹ï¼Ÿâ”€â”€ã€Œå…·ä½“ã™ããš âœ• æŠ½è±¡ã™ããšã€ã®ãƒãƒ©ãƒ³ã‚¹æ¡ˆ

> **ã‚´ãƒ¼ãƒ«**ï¼š
> ç¬¬ 4 ç« ã‚’èª­ã‚“ã èª­è€…ãŒ
>
> 1. **è‡ªç¤¾ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«åˆã‚ã›ã¦ `.gitlab-ci.yml` ã‚’æ›¸ã‘ã‚‹**
> 2. ãƒ“ãƒ«ãƒ‰æ™‚é–“çŸ­ç¸®ã‚„æˆæœç‰©ç®¡ç†ã¾ã§è¸ã¿è¾¼ã‚ã‚‹
>    â€• ã“ã“ã¾ã§åˆ°é”ã§ãã‚Œã°ååˆ†ã§ã™ã€‚
>    ãã®ãŸã‚ã« **â€œæ±ç”¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼‹ãƒŸãƒ‹å…·ä½“ä¾‹â€** ã®äºŒæ®µæ§‹ãˆãŒæœ€ã‚‚ä¼ã‚ã‚Šã‚„ã™ããªã‚Šã¾ã™ã€‚

---

## æ¨å¥¨æ§‹æˆï¼ˆç« ã‚¿ã‚¤ãƒˆãƒ«ã¨è¦‹å‡ºã—ä¾‹ï¼‰

| ç¯€   | è¦‹å‡ºã—                                    | ã­ã‚‰ã„                                                                            | æ›¸ãæ–¹ã®ãƒ’ãƒ³ãƒˆ                                                       |
| ---- | ----------------------------------------- | --------------------------------------------------------------------------------- | -------------------------------------------------------------------- |
| 4-1  | `.gitlab-ci.yml` ã®å…¨ä½“æ§‹æˆ               | **æœ€å° 4 è¦ç´ **<br>`image / variables / stages / jobs` ã‚’å›³è§£                     | 4 è¡Œã‚µãƒ³ãƒ—ãƒ« â†’ ç®±å›³ã§ã€Œä¸Šã‹ã‚‰ä¸‹ã¸æµã‚Œã‚‹ã€ã‚’è¦–è¦šåŒ–                    |
| 4-2  | ã‚ˆãä½¿ã†ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ & ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé›†       | **include / extends / rules / parallel** ãªã© â€œè¦šãˆã‚‹ã¨ä¸–ç•ŒãŒå¤‰ã‚ã‚‹â€ å˜èªã‚’ä¸€è¦§åŒ– | 1 è¡Œã‚µãƒ³ãƒ—ãƒ«ï¼‹ç”¨é€”ãƒ¡ãƒ¢ã ã‘ã«æŠ‘ãˆã€è©³ç´°ã¯å…¬å¼ URL ã¸ãƒªãƒ³ã‚¯            |
| 4-3  | ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ              | **â‘  å·®åˆ†ãƒ“ãƒ«ãƒ‰é«˜é€ŸåŒ– â‘¡ æˆæœç‰©å—ã‘æ¸¡ã—** ã‚’ 1 ãƒšãƒ¼ã‚¸ã§æ¯”è¼ƒ                         | npm ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‹ãƒ¬ãƒãƒ¼ãƒˆå…±æœ‰ã® _æ±ç”¨_ ä¾‹ã‚’è¼‰ã›ã‚‹                     |
| 4-4  | GitLab Packages ã§æˆæœç‰©ç®¡ç†              | **Container Registry / Generic Package / npm Registry** ã‚’è¡¨ã«æ•´ç†                | **å›³ï¼šé–‹ç™º â†’ CI â†’ Registry â†’ æœ¬ç•ª** ã®æµã‚Œã§ â€œãªãœå¿…è¦ã‹â€ ã‚’å…ˆã«ç¤ºã™ |
| ä»˜éŒ² | ãƒŸãƒ‹å…·ä½“ä¾‹ï¼šé™çš„ã‚µã‚¤ãƒˆã‚’ nginx ã§ãƒ‡ãƒ—ãƒ­ã‚¤ | _æœ€å°å‹•ä½œ_ ã‚’ 30 è¡Œã§æç¤ºï¼ˆnginx ä¾‹ï¼‰ã€‚æœ¬æ–‡ãƒªãƒ³ã‚¯ã ã‘ã€‚                           | ä»˜éŒ²ãªã®ã§ã€Œå‹•ã‹ã—ãŸã„äººã¯ã“ã“ã‚’ã‚³ãƒ”ãƒšã€ã§æ¸ˆã‚€                       |

---

### 4-1 `.gitlab-ci.yml` ã®éª¨æ ¼ï¼ˆ5 è¡Œã ã‘ã®è¶…ãƒŸãƒ‹ä¾‹ï¼‰

```yaml
image: alpine # 1. å®Ÿè¡Œç’°å¢ƒ
stages: [test, deploy] # 2. ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ®µéš

unit-test: # 3. ã‚¸ãƒ§ãƒ–â‘ 
  stage: test
  script: echo OK

deploy-prod: # 4. ã‚¸ãƒ§ãƒ–â‘¡
  stage: deploy
  script: echo deploy
```

> _ã“ã“ã§ä¼ãˆã‚‹ã“ã¨_
>
> - â€œä¸Šã‹ã‚‰é †â€ ã«æµã‚Œã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸
> - **ã‚¸ãƒ§ãƒ–ã¯ã€Œã‚­-ãƒãƒª (key-value)ã€ã®å¡Š** â€• è¦šãˆã‚‹ã‚¿ã‚°ã¯ `stage / script / rules` ã® 3 ã¤ã‹ã‚‰å§‹ã‚ã‚‹

---

### 4-2 ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé›†ï¼ˆæŠœç²‹ï¼‰

| ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰   | åŠ¹æœ                     | 1 è¡Œã‚µãƒ³ãƒ—ãƒ«                                                     |
| ------------ | ------------------------ | ---------------------------------------------------------------- |
| **include**  | å…¬å¼ã‚„å…±é€š CI ã‚’å–ã‚Šè¾¼ã‚€ | `include: {template: 'Go.gitlab-ci.yml'}`                        |
| **extends**  | ã‚¸ãƒ§ãƒ–ã®ç¶™æ‰¿             | `extends: .docker-build`                                         |
| **rules**    | ç™ºç«æ¡ä»¶                 | <small>`rules: {if: '$CI_COMMIT_TAG', when: on_success}`</small> |
| **parallel** | è¡Œåˆ—ãƒ“ãƒ«ãƒ‰               | <small>`parallel: {matrix: [{PY: 3.9}, {PY: 3.12}]}`</small>     |

> ğŸ™‹â€â™‚ï¸ **ãƒã‚¤ãƒ³ãƒˆ**ï¼šã€Œã©ã†ä½¿ã†ï¼Ÿã€ã‚ˆã‚Šã€Œä½•ãŒå‡ºæ¥ã‚‹ï¼Ÿã€ã‚’å…ˆã«ä¸¦ã¹ã‚‹ã¨åˆå¿ƒè€…ãŒè¿·ã‚ãªã„ã€‚

---

### 4-3 ã‚­ãƒ£ãƒƒã‚·ãƒ¥ vs ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆå¯¾æ¯”è¡¨

| æ¯”è¼ƒé …ç›®           | **cache** (é«˜é€ŸåŒ–)                          | **artifacts** (æˆæœç‰©)     |
| ------------------ | ------------------------------------------- | -------------------------- |
| ä¿å­˜ã‚¿ã‚¤ãƒŸãƒ³ã‚°     | ã‚¸ãƒ§ãƒ– _é–‹å§‹æ™‚_ ã«å¾©å…ƒ<br>çµ‚äº†æ™‚ã«ä¿å­˜      | ã‚¸ãƒ§ãƒ–çµ‚äº†å¾Œã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ |
| å…±æœ‰ç¯„å›²           | ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’è¶…ãˆã¦å†åˆ©ç”¨å¯                | å¾Œç¶šã‚¸ãƒ§ãƒ–ï¼ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç”¨ |
| ä»£è¡¨ç”¨é€”           | `node_modules/`, `~/.m2`                    | HTML ãƒ¬ãƒãƒ¼ãƒˆ, JAR, ZIP    |
| ã‚­ãƒ¼æŒ‡å®š           | `key:` å¿…é ˆ â†’ è¡çªé˜²æ­¢                      | ä¸è¦ï¼ˆå¸¸ã«ä¸€æ„ã® IDï¼‰      |
| ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ | ã‚­ãƒ¼ã« `$CI_COMMIT_REF_SLUG` ã§ãƒ–ãƒ©ãƒ³ãƒåˆ†é›¢ | `expire_in` ã§è‡ªå‹•å‰Šé™¤     |

---

### 4-4 GitLab Packages ã®ä½¿ã„åˆ†ã‘æ—©è¦‹

| æˆæœç‰©ã‚¿ã‚¤ãƒ—        | ä¿å­˜å…ˆ             | push ã‚³ãƒãƒ³ãƒ‰ä¾‹                                                 | pull ã‚³ãƒãƒ³ãƒ‰ä¾‹    |
| ------------------- | ------------------ | --------------------------------------------------------------- | ------------------ |
| **Docker ã‚¤ãƒ¡ãƒ¼ã‚¸** | Container Registry | `docker push $CI_REGISTRY_IMAGE:tag`                            | `docker pull ...`  |
| **ZIP/Binary**      | Generic Packages   | `curl --upload-file .../file.zip $API_URL/packages/generic/...` | åŒ URL ã‚’ wget     |
| **npm ãƒ©ã‚¤ãƒ–ãƒ©ãƒª**  | npm Registry       | `npm publish --registry $GL_NPM_REGISTRY`                       | `npm i @scope/pkg` |

> ğŸ”‘ **ã‚³ãƒ„**ï¼šå…ˆã« â€œé‹ç”¨èª²é¡Œâ€ ã‚’æ›¸ã â†’ Packages ãŒè§£æ±ºç­–ã«ãªã‚‹æ§‹æˆã«ã™ã‚‹ã¨ç´å¾—æ„ŸãŒé«˜ã„ã€‚

---

## ä»˜éŒ²ãƒªãƒ³ã‚¯ä¾‹ï¼ˆnginx ãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰

> _ã€Œã¾ãšã¯å‹•ã‹ã—ãŸã„ã€èª­è€…å‘ã‘ã«ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§æ¸ˆã‚€å®Ÿç”¨ã‚µãƒ³ãƒ—ãƒ«_ > [https://gitlab.example.com/snippets/1234](https://gitlab.example.com/snippets/1234)

---

### ã¾ã¨ã‚ â€“ ãªãœã“ã®æ§‹æˆï¼Ÿ

- **ãƒ¡ã‚¤ãƒ³æœ¬æ–‡**ï¼šæŠ½è±¡åº¦ã‚’ãã‚ãˆ _â€œå‹â€_ ã‚’å­¦ã°ã›ã‚‹ã€‚
- **ä»˜éŒ²**ï¼šã‚³ãƒ”ãƒ¼ã ã‘ã§å‹•ãå…·ä½“ä¾‹ã‚’ç½®ã â€œä½“é¨“â€ ã‚’ä¿è¨¼ã€‚
- ã“ã†ã™ã‚‹ã¨ **åˆå¿ƒè€…** ã‚‚ **çµŒé¨“è€…** ã‚‚èª­ã¿é£›ã°ã—ã‚„ã™ãã€é‹ç”¨ã‚¬ã‚¤ãƒ‰ã¨ã—ã¦éä¸è¶³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚

> **çµè«–**ï¼šã€Œnginx ã®ä¸¸ã”ã¨æ‰‹é †ã€ã¯ä»˜éŒ²ã¸åˆ†é›¢ã—ã€æœ¬æ–‡ã¯ä»Šã®â€œæ±ç”¨ãƒ†ãƒ³ãƒ—ãƒ¬ï¼‹å¯¾æ¯”è¡¨â€ã‚¹ã‚¿ã‚¤ãƒ«ã§ä¸€èˆ¬åŒ–ã™ã‚‹ã®ãŒæœ€é©ã§ã™ã€‚
> ä»¥ä¸‹ã‚’ **ã¾ã‚‹ã”ã¨ ZIP ã§æ¸¡ã™ã‹ã€GitLab â€œImport repositoryâ€ ã§å–ã‚Šè¾¼ã‚€** ã ã‘ã§
> é™çš„ã‚µã‚¤ãƒˆã® CIâ†’CD ãŒã™ãã«ä½“é¨“ã§ãã‚‹æœ€å°ã‚µãƒ³ãƒ—ãƒ«ã§ã™ã€‚
> ï¼ˆRunner ã¯ docker-executorã€ã‚¿ã‚° `docker` ãŒä»˜ã„ã¦ã„ã‚‹å‰æï¼‰

---

## 1ï¸âƒ£ ãƒªãƒã‚¸ãƒˆãƒªæ§‹æˆ

```
quick-start-nginx/
â”œâ”€â”€ README.md
â”œâ”€â”€ .gitlab-ci.yml          â† ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®šç¾©ï¼ˆ18 è¡Œï¼‰
â”œâ”€â”€ site/                   â† ãã®ã¾ã¾ Web ã«å‡ºã‚‹ãƒ•ã‚©ãƒ«ãƒ€
â”‚   â””â”€â”€ index.html
â””â”€â”€ docker-compose.yml      â† EC2 ã§å‹•ã‹ã™ nginx ã‚³ãƒ³ãƒ†ãƒŠ
```

### ä¸»è¦ãƒ•ã‚¡ã‚¤ãƒ«

**site/index.html**

```html
<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>Hello GitLab CI/CD</title>
  </head>
  <body>
    <h1>Hello GitLab CI/CD!</h1>
    <p>æ›´æ–°æ—¥æ™‚: <span id="ts"></span></p>
    <script>
      document.getElementById("ts").textContent = new Date();
    </script>
  </body>
</html>
```

**docker-compose.yml**

```yaml
version: "3.9"
services:
  nginx-app:
    image: nginx:alpine
    container_name: nginx-app
    volumes:
      - /srv/site:/usr/share/nginx/html:ro
    ports:
      - "80:80"
    restart: always
```

**.gitlab-ci.yml**

```yaml
stages: [test, deploy]

unit-test: # 1. HTML ãŒã‚ã‚‹ã‹ã ã‘ç¢ºèª
  stage: test
  image: alpine
  script: test -f site/index.html

deploy-to-nginx: # 2. main ã¸ push ã—ãŸã‚‰å…¬é–‹
  stage: deploy
  tags: [docker] # â˜… Runner ç™»éŒ²æ™‚ã«ä»˜ã‘ãŸ tag
  rules:
    - if: '$CI_COMMIT_BRANCH=="main" && $CI_PIPELINE_SOURCE=="push"'
      when: always
  script:
    - rsync -av --delete site/ /srv/site/
    - docker compose exec nginx-app nginx -s reload
  environment:
    name: production
    url: http://$CI_SERVER_HOST
```

---

## 2ï¸âƒ£ ä½¿ã„æ–¹ï¼ˆæ‰€è¦ 3 åˆ†ï¼‰

### A. EC2 å´ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆåˆå›ã ã‘ï¼‰

```bash
## 1) ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ«ãƒ¼ãƒˆ & ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸
sudo mkdir -p /srv/site && sudo chown $(whoami) /srv/site
echo "First deploy @ $(date)" > /srv/site/index.html

## 2) nginx ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•
docker compose -f docker-compose.yml up -d nginx-app
```

> ãƒ–ãƒ©ã‚¦ã‚¶ã§ `http://<EC2_IP>/` ãŒè¦‹ãˆãŸã‚‰ OKã€‚

### B. ã‚µãƒ³ãƒ—ãƒ«ã‚’ GitLab ã«å–ã‚Šè¾¼ã‚€

1. GitLab â€º New Project â€º **â€œImport projectâ€ â†’ â€œUpload .zipâ€**
   ZIP ã¯ãã®ã¾ã¾ quick-start-nginx ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å›ºã‚ã‚‹ã ã‘ã€‚
   ï¼ˆã¾ãŸã¯ `git clone` â†’ origin å¤‰æ›´ã§ push ã§ã‚‚å¯ï¼‰
2. **Settings â€º CI/CD â€º Runners** ã§
   docker-runner ã« **Tag = `docker`** ãŒä»˜ã„ã¦ã„ã‚‹ã‹ç¢ºèªã€‚
3. ãƒªãƒã‚¸ãƒˆãƒªã® **`site/index.html` ã‚’ 1 è¡Œç·¨é›†** â†’ commit â†’ push

### C. ç¢ºèª

| è¦‹ã‚‹å ´æ‰€                    | æœŸå¾…çµæœ                              |
| --------------------------- | ------------------------------------- |
| **CI/CD â€º Pipelines**       | `unit-test`â†’`deploy-to-nginx` ãŒç·‘ âœ… |
| ãƒ–ãƒ©ã‚¦ã‚¶ `http://<EC2_IP>/` | å¤‰æ›´å¾Œã®æ–‡è¨€ãŒå³åæ˜                   |
| `docker logs nginx-app`     | æœ€æ–°ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹          |

---

## 3ï¸âƒ£ ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã®é“ã—ã‚‹ã¹

| ã‚„ã‚ŠãŸã„ã“ã¨     | è§¦ã‚‹å ´æ‰€                               | å¤‰æ›´ä¾‹                                                         |
| ---------------- | -------------------------------------- | -------------------------------------------------------------- |
| ä¾å­˜ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« | `.gitlab-ci.yml` ã® `unit-test` ã‚¸ãƒ§ãƒ– | `image: node:20-alpine` â†’ `npm ci && npm test`                 |
| SPA ãƒ“ãƒ«ãƒ‰       | åŒä¸Š                                   | `npm run build` â†’ `rsync build/ /srv/site/`                    |
| HTTPS            | `docker-compose.yml`                   | `nginxproxy/nginx-proxy` + `acme-companion` ã‚’è¿½åŠ              |
| è¤‡æ•°ç’°å¢ƒ         | `deploy-to-nginx` ã‚¸ãƒ§ãƒ–               | `environment: name: review/$CI_COMMIT_REF_SLUG` ã§ Review Apps |

---

## 4ï¸âƒ£ â€œãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯â€ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ URL ä¾‹ï¼ˆè‡ªç¤¾ GitLab ç”¨ï¼‰

```
https://gitlab.example.com/projects/new#import_project
```

- ç”»é¢ã« ZIP ã‚’ãƒ‰ãƒ©ãƒƒã‚° & ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹ã ã‘
- ã‚ã‚‹ã„ã¯ **ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚°ãƒ«ãƒ¼ãƒ—**ã‚’ç”¨æ„ã—
  `include: {project: devops/ci-templates, file: /static-nginx.yml}`
  ã¨æ›¸ã‘ã°ã©ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã‚‚ 1 è¡Œã§æµç”¨ã§ãã¾ã™ã€‚

---

> **ã“ã®ã‚µãƒ³ãƒ—ãƒ«è‡ªä½“ã‚’é‹ç”¨ã‚¬ã‚¤ãƒ‰ã®ä»˜éŒ²ã¨ã—ã¦ç½®ã**
>
> - æœ¬æ–‡ï¼šæ±ç”¨çš„ãªèª¬æ˜ã§ â€œå‹â€ ã‚’è§£èª¬
> - ä»˜éŒ²ï¼šZIP or Snippet ã§ **å³å‹•ãã‚³ãƒ¼ãƒ‰**
>   ã¨ã„ã†æ§‹æˆã«ã™ã‚Œã°ã€åˆå¿ƒè€…ã¯ã‚³ãƒ”ãƒ¼ã€çµŒé¨“è€…ã¯æ”¹é€ ã¨ã€ä¸¡æ–¹ãƒ•ã‚©ãƒ­ãƒ¼ã§ãã¾ã™ã€‚
