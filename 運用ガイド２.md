# GitLab CI/CD é–‹å§‹ãƒ»é‹ç”¨ã‚¬ã‚¤ãƒ‰ï¼ˆAWS Ã— Docker ç·¨ï¼‰

---

## ç¬¬ä¸€ç«  ã¯ã˜ã‚ã«

### 1-1 ç›®çš„

- **æœ€å°ãƒªã‚½ãƒ¼ã‚¹**ã§ GitLab CI/CD ã‚’æ§‹ç¯‰ã—ã€ãƒ—ãƒ«ãƒªã‚¯ï¼ˆMerge Requestï¼‰ã§ã® **ãƒ“ãƒ«ãƒ‰ï¼ãƒ†ã‚¹ãƒˆ** ã¨ `main` ã¸ã® push æ™‚ã® **è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤** ã‚’ 1 å°ã® EC2 ã§å®Ÿç¾ã™ã‚‹ã€‚
- PoC ã‹ã‚‰æœ¬ç•ªã¸æ®µéšçš„ã«ã‚¹ã‚±ãƒ¼ãƒ«ã§ãã‚‹åœŸå°ã‚’ç”¨æ„ã™ã‚‹ã€‚

### 1-2 å¯¾è±¡èª­è€…

| ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹   | æƒ³å®šãƒ¬ãƒ™ãƒ«                                 |
| ------------ | ------------------------------------------ |
| ã‚¤ãƒ³ãƒ•ãƒ©é‹ç”¨ | AWS åŸºæœ¬æ“ä½œï¼ˆVPC, EC2, SGï¼‰ã¨ Docker åˆç´š |
| ã‚¢ãƒ—ãƒªé–‹ç™º   | Git æ“ä½œã¨ YAML èª­è§£                       |
| ç¾è¡Œç’°å¢ƒ     | Azure DevOps ãªã©åˆ¥ CI/CD ã‚’åˆ©ç”¨ä¸­         |

### 1-3 ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆæ¦‚è¦

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EC2 (t3.medium, Ubuntu 22.04)     â”‚
â”‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€ GitLab (ports 8181â€¦) â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚                                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”Œâ”€â”€â”€â”€â”€ GitLab Runner (docker exec) â”€â”€â”€â”€â”
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”Œâ”€â”€â”€â”€â”€ nginx-app (å…¬é–‹ãƒšãƒ¼ã‚¸ :80) â”€â”€â”€â”€â”€â”
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â€» 3 ã‚³ãƒ³ãƒ†ãƒŠã¨ã‚‚åŒä¸€ãƒ›ã‚¹ãƒˆï¼åŒä¸€ Docker                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- **é–‹ç™ºãƒ•ãƒ­ãƒ¼**

  1. å¤–éƒ¨ Git ãƒªãƒã‚¸ãƒˆãƒª â†’ GitLab ã¸ _Pull Mirroring_ï¼ˆ5 åˆ†ã”ã¨ï¼‰
  2. PR â†’ GitLab MR ç™ºè¡Œ â†’ _build_ãƒ»_test_ ã‚¹ãƒ†ãƒ¼ã‚¸å®Ÿè¡Œ
  3. `main` ã¸ push â†’ _deploy_ ã‚¹ãƒ†ãƒ¼ã‚¸å®Ÿè¡Œï¼ˆ`rsync` + `nginx reload`ï¼‰

---

## ç¬¬äºŒç«  CI/CD å°å…¥æ‰‹é †

### 2-1 GitLab ã‚³ãƒ³ãƒ†ãƒŠæ§‹ç¯‰

```bash
mkdir -p /srv/gitlab/{config,logs,data}
docker run -d --name gitlab \
  -p 8181:80 -p 8443:443 -p 2222:22 \
  -v /srv/gitlab/config:/etc/gitlab \
  -v /srv/gitlab/logs:/var/log/gitlab \
  -v /srv/gitlab/data:/var/opt/gitlab \
  -e GITLAB_ROOT_PASSWORD="ChangeMe!" \
  gitlab/gitlab-ee:17.0.1-ee.0     # CE å¯
```

> åˆå›ãƒ­ã‚°ã‚¤ãƒ³: `http://<EC2_IP>:8181` â†’ `root / ChangeMe!`

### 2-2 GitLab Runner ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆåŒãƒ›ã‚¹ãƒˆï¼‰

```bash
docker run -d --name gitlab-runner --restart always \
  -v /var/run/docker.sock:/var/run/docker.sock \
  -v /srv/gitlab-runner:/etc/gitlab-runner \
  gitlab/gitlab-runner:alpine

docker exec -it gitlab-runner gitlab-runner register
# GitLab URL: http://localhost:8181
# Token    : [Admin > Runners > Registration token]
# Executor : docker   (image ã¯ alpine ã§å¯)
# Tag      : docker
```

### 2-3 GitLab CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ§‹ç¯‰

**`docker-compose.yml`ï¼ˆæŠœç²‹ï¼šnginx-appï¼‰**

```yaml
nginx-app:
  image: nginx:alpine
  volumes:
    - /srv/site:/usr/share/nginx/html:ro # é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚¦ãƒ³ãƒˆ
  ports:
    - "80:80"
  restart: always
```

**`.gitlab-ci.yml`**

```yaml
stages: [test, deploy]

.default: &rules
  rules:
    - if: '$CI_PIPELINE_SOURCE=="merge_request_event"'
      when: always
    - if: '$CI_COMMIT_BRANCH=="main" && $CI_PIPELINE_SOURCE=="push"'
      when: always
    - when: never

test:
  stage: test
  image: alpine
  <<: *rules
  script: test -f site/index.html

deploy:
  stage: deploy
  tags: [docker]
  rules:
    - if: '$CI_COMMIT_BRANCH=="main" && $CI_PIPELINE_SOURCE=="push"'
      when: always
    - when: never
  script: |
    rsync -av --delete site/ /srv/site/
    docker compose exec nginx-app nginx -s reload
  environment:
    name: production
    url: http://$CI_SERVER_HOST
```

### 2-4 ãƒ‡ãƒ—ãƒ­ã‚¤å‡¦ç†ã®è‡ªå‹•åŒ–ï¼ˆCDï¼‰

- **æˆæœç‰©åŒæœŸ**ï¼š`rsync` ã§ãƒ›ã‚¹ãƒˆ `/srv/site/` ã‚’æ›´æ–°
- **ã‚µãƒ¼ãƒ“ã‚¹åæ˜ **ï¼š`nginx -s reload` ã§ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ ç„¡ã—ãƒªãƒ­ãƒ¼ãƒ‰
- **å¯è¦–åŒ–**ï¼šMR ç”»é¢ã§ _test_ ç·‘ â†’ main ãƒãƒ¼ã‚¸å¾Œã« _deploy_ å®Œäº†ã‚’ç¢ºèª

---

## ç¬¬ä¸‰ç«  GitLab CI/CD ã®é‹ç”¨

| é …ç›®           | æ“ä½œ                               | æ¨å¥¨é »åº¦  |
| -------------- | ---------------------------------- | --------- |
| ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—   | `gitlab-backup create` â†’ S3 ã¸è»¢é€ | 1 æ—¥ 1 å› |
| ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ | `docker pull` â†’ `docker restart`   | æœˆæ¬¡      |
| ãƒ‡ã‚£ã‚¹ã‚¯æƒé™¤   | `docker system prune -af`          | é€±æ¬¡      |
| ãƒŸãƒ©ãƒ¼å¤±æ•—ç›£è¦– | ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ or Prometheus ã‚¢ãƒ©ãƒ¼ãƒˆ  | éšæ™‚      |

---

## ç¬¬å››ç«  ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»ç®¡ç†

1. **ãƒãƒ¼ãƒˆåˆ¶é™**ï¼šSG ã§ 8181/8443/22/80 ã‚’ç¤¾å†… IP ã®ã¿ã«
2. **HTTPS**ï¼šLetâ€™s Encrypt â†’ `external_url "https://gitlab.example.com"`
3. **CI å¤‰æ•°ã®ä¿è­·**ï¼š`protected` & `masked` ãƒ•ãƒ©ã‚°å¿…é ˆ
4. **æœ€å°æ¨©é™**ï¼šRunner ç”¨ IAM ã‚­ãƒ¼ã¯ä¸è¦ï¼ˆä»Šå›ã¯ãƒ­ãƒ¼ã‚«ãƒ«æ“ä½œã®ã¿ï¼‰
5. **ç›£æŸ»ãƒ­ã‚°**ï¼š`/var/log/gitlab/gitlab-rails/audit_json.log`

---

## ç¬¬äº”ç«  ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

| ç—‡çŠ¶                      | åŸå›                      | å¯¾å‡¦                              |
| ------------------------- | ------------------------ | --------------------------------- |
| Runner ãŒ `unhealthy`     | ã‚³ãƒ³ãƒ†ãƒŠå¤šé‡èµ·å‹•ãƒ»é«˜è² è· | `docker restart gitlab-runner`    |
| MR ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãŒå‹•ã‹ãªã„ | Pull Mirroring å¤±æ•—      | PAT æ¨©é™ç¢ºèª / æ‰‹å‹• â€œUpdate nowâ€  |
| ãƒ‡ã‚£ã‚¹ã‚¯ä¸è¶³              | ãƒ­ã‚°ãƒ»æ—§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è‚¥å¤§ | `du -sh`, `gitlab-backup rm`      |
| `502` ã‚¨ãƒ©ãƒ¼              | Puma ãƒ¡ãƒ¢ãƒªä¸è¶³          | `gitlab-ctl restart` + CPU/RAM å¢— |

---

## ç¬¬å…­ç«  Azure DevOps ã¨ã®æ¯”è¼ƒã¨ç§»è¡Œãƒ¡ãƒ¢

| é …ç›®             | Azure DevOps                 | GitLab (æœ¬æ§‹æˆ)                   | ç§»è¡Œãƒã‚¤ãƒ³ãƒˆ             |
| ---------------- | ---------------------------- | --------------------------------- | ------------------------ |
| ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°     | SaaS                         | Self-host (EC2)                   | ã‚³ã‚¹ãƒˆã¯å°æ•°ä¾å­˜ã ãŒæŸ”è»Ÿ |
| ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³è¨˜æ³• | YAML (`azure-pipelines.yml`) | YAML (`.gitlab-ci.yml`)           | æ§‹æ–‡å·®åˆ†ã‚’å¤‰æ›è¡¨ã§ç½®æ›   |
| ãƒªãƒã‚¸ãƒˆãƒªé€£æº   | DevOps å†… Git / GitHub       | **Pull Mirroring** ã§å¤–éƒ¨å–ã‚Šè¾¼ã¿ | PAT ç™ºè¡ŒãŒå¿…è¦           |
| å¤‰æ•°ç®¡ç†         | Library / KeyVault é€£æº      | Settings â€º CI/CD â€º Variables      | `protected` ã‚’å¿˜ã‚Œãš     |
| ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆ       | Azure Pipelines Release      | ä»»æ„ (ssh/rsync/Docker)           | Cloud-agnostic ã§è»½é‡    |
| ãƒ©ã‚¤ã‚»ãƒ³ã‚¹       | å¾“é‡èª²é‡‘                     | CEï¼šç„¡æ–™ / EEï¼šæœ‰æ–™               | PoC ã¯ CE ã§ååˆ†         |

> **ç§»è¡Œã‚¹ãƒ†ãƒƒãƒ—ã¾ã¨ã‚**
>
> 1. DevOps ãƒªãƒã‚¸ãƒˆãƒª â†’ GitLab Pull Mirroring
> 2. Azure Pipelines YAML â†’ `.gitlab-ci.yml` ç½®æ›
> 3. ç’°å¢ƒå¤‰æ•°ãƒ»ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç§»è¨­
> 4. Runner ã‚¿ã‚°è¨­å®š â†’ ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œç¢ºèª
> 5. Azure å´ã‚¸ãƒ§ãƒ–ã‚’åœæ­¢

---

### ãŠã‚ã‚Šã«

- **EC2 Ã—1 å°**ã§ â€œMRâ†’ ãƒ“ãƒ«ãƒ‰ï¼ãƒ†ã‚¹ãƒˆã€mainâ†’ ãƒ‡ãƒ—ãƒ­ã‚¤â€ ã®ä½“é¨“ç’°å¢ƒãŒå®Œæˆã€‚
- æ©Ÿèƒ½è¿½åŠ ã¯ã‚³ãƒ³ãƒ†ãƒŠã‚’åˆ†å‰² or ECS/EKS ã«ç½®ãæ›ãˆã‚‹ã ã‘ã§æ®µéšçš„ã«æ‹¡å¼µå¯èƒ½ã€‚
- _PoC ã§å°ã•ãå§‹ã‚ã€å¤§ããè‚²ã¦ã‚‹_ â€• æœ¬ã‚¬ã‚¤ãƒ‰ãŒç¬¬ä¸€æ­©ã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚

### â“ ãªãœã‚µãƒ³ãƒ—ãƒ«ã« _nginx_ ã‚’æ¡ç”¨ã—ãŸã®ã‹

| è¦³ç‚¹             | nginx ã®ãƒ¡ãƒªãƒƒãƒˆ                                                 | ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ç”¨é€”ã¸ã®é©åˆåº¦                                           |
| ---------------- | ---------------------------------------------------------------- | -------------------------------------------------------------------- |
| **è»½é‡æ€§**       | `nginx:alpine` ã¯ â‰ˆ5 MBã€‚EC2 Ã— 1 å°æ§‹æˆã§ã‚‚ CPU/RAM ã‚’åœ§è¿«ã—ãªã„ | **â—** â€“ PoC ã«æœ€é©                                                   |
| **ãƒ“ãƒ«ãƒ‰ä¸è¦**   | å…¬å¼ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ pull ã—ã¦é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚¦ãƒ³ãƒˆã™ã‚‹ã ã‘           | **â—** â€“ Dockerfileãƒ»ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã®æ¦‚å¿µãŒã¾ã æ›–æ˜§ãªèª­è€…ã§ã‚‚å®Ÿè¡Œã—ã‚„ã™ã„ |
| **è¨€èªéä¾å­˜**   | HTML ã•ãˆç½®ã‘ã°å‹•ã â†’ .NET/JAVA/Node ãªã©æœ¬ç•ªè¨€èªã«å·¦å³ã•ã‚Œãªã„  | **â—‹** â€“ â€œCI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®å‹â€ ã‚’ç¤ºã™ç›®çš„ã«åˆã†                    |
| **ç½®ãæ›ãˆå®¹æ˜“** | ã‚³ãƒ³ãƒ†ãƒŠåã¨ reload ã‚³ãƒãƒ³ãƒ‰ã‚’å¤‰ãˆã‚‹ã ã‘ã§åˆ¥ã‚¢ãƒ—ãƒªã«è»¢ç”¨å¯èƒ½     | **â—‹** â€“ å¾Œæ®µã®ã‚¹ãƒ†ãƒƒãƒ—ã‚¢ãƒƒãƒ—ä¾‹ã«ç¹‹ã’ã‚„ã™ã„                           |

> **çµè«–ï¼š** _ã€Œæœ€å°æ§‹æˆã§ CI/CD å‹•ç·šã‚’ä½“é¨“ã—ã¦ã‚‚ã‚‰ã†ã€ã¨ã„ã†ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã®ç‹™ã„ã«ã¯ååˆ†ãµã•ã‚ã—ã„_
> â€“ â€œã‚¢ãƒ—ãƒªã®ç¨®é¡â€ã§ã¯ãªãâ€œGitLab ã®æµã‚Œâ€ã‚’å­¦ã¶ã“ã¨ãŒä¸»çœ¼ã ã‹ã‚‰ã§ã™ã€‚

---

### ğŸŒ± ãŸã ã—â€•â€•èª­è€…ãŒ .NETï¼Java ç­‰ã‚’æƒ³å®šã—ã¦ã„ã‚‹å ´åˆã®ãƒ•ã‚©ãƒ­ãƒ¼

1. **ã‚µãƒ³ãƒ—ãƒ«ã‚’å·®ã—æ›¿ãˆã‚‹éš›ã®ã‚¬ã‚¤ãƒ‰ã‚’ä½µè¨˜ã™ã‚‹**

   - ä¾‹ï¼š`.NET 6 WebAPI` ãªã‚‰

     ```yaml
     image: mcr.microsoft.com/dotnet/sdk:6.0
     script:
       - dotnet restore
       - dotnet test
       - dotnet publish -c Release -o publish
     ```

   - ãƒ‡ãƒ—ãƒ­ã‚¤ã¯ `scp`â†’`systemctl restart myapp` ãªã©ã«èª­ã¿æ›¿ãˆã€‚

2. **ç« æœ«ã«ã€Œã‚¢ãƒ—ãƒªåˆ¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé›†ã€ã¸ã®ãƒªãƒ³ã‚¯**

   - Node / Java Spring / Go ãªã© 1 ãƒ•ã‚¡ã‚¤ãƒ«ãšã¤ä¾‹ç¤ºã—
   - ã€ŒåŸºæœ¬ã¯ rules ã¨ stages ã®æ›¸ãæ›ãˆã ã‘ã€ã¨å¼·èª¿ã€‚

3. **Azure DevOps â†’ GitLab ã® YAML å¤‰æ›æ—©è¦‹è¡¨**

   - `pool:` â†’ `tags:`
   - `steps:` â†’ `script:`
   - ãªã©ã€è¨€èªä¾å­˜ã—ãªã„æ§‹æ–‡å¤‰æ›ã‚’ç¤ºã™ã€‚

---

### ğŸ›  ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³æœ¬æ–‡ã«è¿½è¨˜ã—ã¦ãŠãã¨è¦ªåˆ‡ãªä¸€æ–‡

> **tip:**
> ã“ã®ã‚¬ã‚¤ãƒ‰ã§ã¯è»½é‡ãª _nginx_ ã‚’ä¾‹ã«ã—ã¦ã„ã¾ã™ãŒã€ãƒ“ãƒ«ãƒ‰ï¼ãƒ†ã‚¹ãƒˆï¼ãƒ‡ãƒ—ãƒ­ã‚¤ã®å„ã‚¸ãƒ§ãƒ–ã¯ **ä»»æ„ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ç½®ãæ›ãˆ**ã‚‰ã‚Œã¾ã™ã€‚
> ç½®ãæ›ãˆæ™‚ã¯
>
> 1. `image:`ï¼ˆãƒ“ãƒ«ãƒ‰ç’°å¢ƒï¼‰ã€
> 2. `script:`ï¼ˆãƒ“ãƒ«ãƒ‰ï¼ãƒ†ã‚¹ãƒˆæ‰‹é †ï¼‰ã€
> 3. `deploy` ã‚¸ãƒ§ãƒ–ã®ã‚³ãƒãƒ³ãƒ‰
>    ã‚’è‡ªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ‰‹é †ã«åˆã‚ã›ã¦ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚

---

### ğŸ“Œ ã¾ã¨ã‚

- **ç›®çš„é‡è¦–**ï¼šCI/CD ã®ã€Œæµã‚Œã€ã‚’å­¦ã¶ â†’ _nginx_ ã§ååˆ†
- **æ±ç”¨åŒ–**ï¼šèª­è€…ãŒåˆ¥ã‚¹ã‚¿ãƒƒã‚¯ã§ã‚‚å¿œç”¨ã§ãã‚‹ã‚ˆã†â€œå·®ã—æ›¿ãˆãƒã‚¤ãƒ³ãƒˆâ€ã‚’æ˜ç¤º
- **ç§»è¡Œæ”¯æ´**ï¼šAzure Pipelines ã¨ã®æ§‹æ–‡å¯¾å¿œè¡¨ãƒ»è¨€èªåˆ¥ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’ä»˜éŒ²åŒ–

ã“ã†è¨˜è¿°ã—ã¦ãŠã‘ã°ã€**â€œAzure DevOps ãƒ¦ãƒ¼ã‚¶ãŒ GitLab CI/CD ã‚’ç†è§£ã—ã€å®Ÿæ¡ˆä»¶ã«è»¢ç”¨ã™ã‚‹â€** ã¾ã§ã‚«ãƒãƒ¼ã§ãã€ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã¨ã—ã¦éä¸è¶³ã‚ã‚Šã¾ã›ã‚“ã€‚
