### 1. ã¾ãšã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹è‡ªä½“ã®ã‚¹ãƒšãƒƒã‚¯ã‚’æŠŠæ¡ã™ã‚‹

`t2.medium` ï¼ **vCPU Ã— 2 / ãƒ¡ãƒ¢ãƒª 4 GiB** ([Amazon Web Services, Inc.][1])
GitLab ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã€Œ**æœ€ä½ 8 GiBã€æ¨å¥¨ 16 GiB**ï¼ˆ20 req/s ç¨‹åº¦ã¾ã§ï¼‰ã€ã¨æ¡ˆå†…ã•ã‚Œã¦ã„ã¾ã™ ([GitLab Docs][2])ã€‚
4 GiB ã§å‹•ã‹ã™å ´åˆã¯ã€Œé–‹ç™ºè€… 5 äººãƒ»å°ã•ãªãƒªãƒã‚¸ãƒˆãƒªã¾ã§ãªã‚‰å¯ã€ã¨ã™ã‚‹ â€œãƒ¡ãƒ¢ãƒªåˆ¶é™ç’°å¢ƒâ€ ã‚¬ã‚¤ãƒ‰ã«æ²¿ã£ãŸèª¿æ•´ãŒå¿…è¦ã§ã™ ([GitLab Docs][3])ã€‚

---

### 2. EC2 å†…ã§ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã‚’ç¢ºèª

| ã‚„ã‚ŠãŸã„ã“ã¨                  | ä»£è¡¨çš„ãªã‚³ãƒãƒ³ãƒ‰                                                    | ãƒã‚¤ãƒ³ãƒˆ                                |
| ----------------------------- | ------------------------------------------------------------------- | --------------------------------------- |
| **å…¨ä½“ã®ç©ºã / ä½¿ç”¨é‡**       | `free -h`                                                           | Swap ãŒé£Ÿã‚ã‚Œã¦ã„ãªã„ã‹ã‚‚ç¢ºèª           |
| **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã®è² è·**        | `top` ã¾ãŸã¯ `htop`                                                 | `%MEM` åˆ—ã§ãƒ—ãƒ­ã‚»ã‚¹åˆ¥åˆ©ç”¨é‡             |
| **10 ç§’ãŠãã«ã‚µãƒãƒª**         | `vmstat 10`                                                         | `si`/`so` ãŒå¢—ãˆã¦ã„ã‚Œã°ã‚¹ãƒ¯ãƒƒãƒ—ç™ºç”Ÿ    |
| **Docker å…¨ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ¡ãƒ¢ãƒª** | `docker stats`                                                      | `MEM USAGE / LIMIT` ã‚’è¦‹ã‚‹              |
| **å€‹åˆ¥ã‚³ãƒ³ãƒ†ãƒŠã®è©³ç´°**        | `docker inspect --format '{{json .HostConfig.Memory}}' <container>` | åˆ¶é™ãªã—ãªã‚‰ `0` (=ãƒ›ã‚¹ãƒˆã® 4 GiB å…¨éƒ¨) |

---

### 3. å…¸å‹çš„ãªãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã¨å¯¾ç­–

| ç—‡çŠ¶                                   | åŸå›  / ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ                      | å¯¾å‡¦ä¾‹                                                                                                            |
| -------------------------------------- | -------------------------------------------- | ----------------------------------------------------------------------------------------------------------------- |
| `unhealthy` â†’ OOM Kill ã®ãƒ­ã‚°          | GitLab ãŒ 4 GiB ä»¥ä¸Šä½¿ãŠã†ã¨ã—ã¦ kill ã•ã‚Œã‚‹ | - `swapoff -a` ã§ swap ç„¡åŠ¹ãªã‚‰æœ‰åŠ¹åŒ–<br>- `/etc/gitlab/gitlab.rb` ã§ä¸è¦ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢ï¼ˆPrometheus, Grafana ãªã©ï¼‰ |
| CPU ä½¿ç”¨ç‡ã¯ä½ã„ã®ã«å¿œç­”ãŒæ¥µç«¯ã«é…ã„   | **T2 CPU ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆåˆ‡ã‚Œ**                    | CloudWatch ã® `CPUCreditBalance` ã‚’ç›£è¦– / `t3.medium` ä»¥ä¸Šã¸                                                      |
| `docker stats` ã§ GitLab ãŒ 3.5 GiB è¶… | ãƒªãƒã‚¸ãƒˆãƒªæ•°ãƒ»CI ã‚¸ãƒ§ãƒ–å¤šã‚                  | - `gitlab-ctl reconfigure` å¾Œã« `gitlab-ctl restart`<br>- CI ã‚’åˆ¥ Runner ãƒ›ã‚¹ãƒˆã¸åˆ‡ã‚Šåˆ†ã‘                         |
| Runner ã® `docker build` ãŒ OOM        | Runner ã‚³ãƒ³ãƒ†ãƒŠã«ãƒ¡ãƒ¢ãƒªåˆ¶é™ãªã—              | `runner` ã‚µãƒ¼ãƒ“ã‚¹ã« `mem_limit: "1g"` ã‚’è¨­å®š (docker-compose)                                                     |

---

### 4. å…·ä½“çš„ãªã‚³ãƒãƒ³ãƒ‰ä¾‹

```bash
# 1) å…¨ä½“ãƒ¡ãƒ¢ãƒª
free -h

# 2) GitLab ã‚³ãƒ³ãƒ†ãƒŠ ID ã‚’ç¢ºèª
docker ps --format '{{.Names}}\t{{.ID}}\t{{.Status}}'

# 3) ãã®ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ¡ãƒ¢ãƒªæ¨ç§»ã‚’ 5 ç§’ã”ã¨ã«
watch -n5 "docker stats --no-stream <CONTAINER_ID>"

# 4) æœ€è¿‘ OOM Kill ãŒèµ·ããŸã‹ç¢ºèª
dmesg | grep -i -e oom -e kill | tail

# 5) Runner ã‚‚å«ã‚ãŸå…¨ã‚³ãƒ³ãƒ†ãƒŠã®ä¸Šé™å€¤
docker inspect --format '{{.Name}} -> {{.HostConfig.Memory}}' $(docker ps -q)
```

---

### 5. ãƒ¡ãƒ¢ãƒªã‚’æŠ‘ãˆã‚‹ GitLab è¨­å®šï¼ˆæœ€å°æ§‹æˆå‘ã‘ï¼‰

```bash
# /etc/gitlab/gitlab.rb
prometheus_monitoring['enable'] = false
alertmanager['enable']        = false
grafana['enable']             = false
gitlab_workhorse['concurrency'] = 2
puma['worker_processes']        = 0     # ã‚·ãƒ³ã‚°ãƒ«ãƒ—ãƒ­ã‚»ã‚¹
sidekiq['concurrency']          = 5
gitlab_rails['gitlab_shell_ssh_port'] = 2222
```

åæ˜ ã¯ `gitlab-ctl reconfigure && gitlab-ctl restart`ã€‚

---

### 6. ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚µã‚¤ã‚ºã®æ¤œè¨

| ãƒ—ãƒ©ãƒ³        | vCPU | ãƒ¡ãƒ¢ãƒª | æ–™é‡‘ç›®å®‰ (æ±äº¬) | ã‚³ãƒ¡ãƒ³ãƒˆ                          |
| ------------- | ---- | ------ | --------------- | --------------------------------- |
| t2.medium     | 2    | 4 GiB  | ç´„ \$0.046/hr   | ç¾åœ¨ã€‚ãƒ¡ãƒ¢ãƒªä¸è¶³æ„Ÿ                |
| **t3.medium** | 2    | 4 GiB  | ç´„ \$0.041/hr   | åŒãƒ¡ãƒ¢ãƒªã ãŒ CPU ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆåŠ¹ç‡ â— |
| **t3.large**  | 2    | 8 GiB  | ç´„ \$0.082/hr   | GitLab æœ€ä½ãƒ©ã‚¤ãƒ³ã‚’æº€ãŸã™         |
| t3a.large     | 2    | 8 GiB  | ç´„ \$0.074/hr   | ã‚³ã‚¹ãƒˆã‚’æŠ‘ãˆã¤ã¤ 8 GiB            |

8 GiB ä»¥ä¸Šã¸ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ãƒƒãƒ—ã—ã€Runner ã¯åŒä¸€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å†…ã§ã‚‚ OKï¼å°†æ¥çš„ã«åˆ¥ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§åˆ†é›¢â€¦ã¨ã„ã£ãŸæ§‹æˆãŒä¸€èˆ¬çš„ã§ã™ã€‚

---

## ğŸ” æ¬¡ã«ã‚„ã‚‹ã“ã¨

1. `free -h`, `docker stats`, `dmesg` ã§ **å…·ä½“çš„ã«ã©ã®ãƒ—ãƒ­ã‚»ã‚¹ãŒãƒ¡ãƒ¢ãƒªã‚’é£Ÿã£ã¦ã„ã‚‹ã‹** ã‚’ç¢ºèª
2. 4 GiB ã§åã¾ã‚‰ãªã‘ã‚Œã° GitLab ã®ä¸è¦ã‚µãƒ¼ãƒ“ã‚¹ã‚«ãƒƒãƒˆ or ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æ‹¡å¼µ
3. Runner ã‚³ãƒ³ãƒ†ãƒŠã«æ˜ç¤ºçš„ãª `mem_limit` ã‚’ä»˜ã‘ã¦ OOM ã‚’é˜²ã

å‡ºåŠ›çµæœã‚’è²¼ã£ã¦ã„ãŸã ã‘ã‚Œã°ã€ã•ã‚‰ã«è©³ã—ããƒœãƒˆãƒ«ãƒãƒƒã‚¯ã‚’çµã‚Šè¾¼ã¿ã¾ã—ã‚‡ã†ï¼

[1]: https://aws.amazon.com/ec2/instance-types/t2/?utm_source=chatgpt.com "Amazon EC2 T2 Instances â€“ Amazon Web Services (AWS)"
[2]: https://docs.gitlab.com/install/requirements/?utm_source=chatgpt.com "GitLab installation requirements"
[3]: https://docs.gitlab.com/omnibus/settings/memory_constrained_envs/?utm_source=chatgpt.com "Running GitLab in a memory-constrained environment"
